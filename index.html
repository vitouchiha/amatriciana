<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Matrice Orari</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --bg-a: #5ee7df;
      --bg-mid: #eaf7ff;
      --bg-b: #7b61ff;

      --card: rgba(255,255,255,0.92);
      --stroke: rgba(11,16,32,0.10);
      --text: #0b1020;
      --muted: rgba(11,16,32,0.62);

      --shadow: 0 18px 44px rgba(0,0,0,0.22);
      --shadow-soft: 0 10px 24px rgba(0,0,0,0.18);
      --radius: 18px;

      --accent: #5c9bff;
      --accent2: #14b8a6;
      --danger: #e11d48;
      --ok: #16a34a;
      --warn: #f59e0b;

      --table-bg: #ffffff;
      --table-stroke: rgba(11,16,32,0.10);
      --table-zebra: rgba(11,16,32,0.03);
    }
    html[data-theme="dark"]{
      --bg-a: #3a7686;
      --bg-mid: #0b1420;
      --bg-b: #0b1420;

      --card: rgba(18, 42, 55, 0.96);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);

      --shadow: 0 18px 44px rgba(0,0,0,0.55);
      --shadow-soft: 0 14px 28px rgba(0,0,0,0.40);

      --table-bg: rgba(11, 18, 25, 0.88);
      --table-stroke: rgba(255,255,255,0.10);
      --table-zebra: rgba(11, 18, 25, 0.28);
    }

*{box-sizing:border-box;}
    html, body{height:100%;}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg-a) 0%, var(--bg-mid) 40%, var(--bg-b) 100%);
      color: var(--text);
      padding: 14px;
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: auto;
      touch-action: pan-x pan-y;
    }
    body.modal-open{overflow:hidden;}
    a{color:inherit}

    .app-shell{max-width: 1100px; margin:0 auto;}
    .topbar{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: calc(env(safe-area-inset-top) + 10px);
      z-index: 9999;
      width: calc(100% - 32px);
      max-width: 1100px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 16px;
      border-radius: 16px;
      background: var(--card);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(18px);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0; flex: 0 0 auto;}
    .brand-icon{
      width:38px; height:38px; border-radius: 12px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(92,155,255,0.32), rgba(123,97,255,0.26));
      border: 1px solid var(--stroke);
      flex: 0 0 auto;
      font-size: 18px;
    }
    .brand-text{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .brand-text h1{
      margin:0; font-size: 14px; font-weight: 900; line-height: 1.15;
      letter-spacing: -0.3px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .brand-text small{
      display:block; font-size: 11px; color: var(--muted); font-weight: 700;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }

    /* Gruppi pulsanti nella topbar */
    .top-actions{
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .tbtn-group{
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px;
      border-radius: 14px;
      background: rgba(0,0,0,0.04);
      border: 1px solid var(--stroke);
    }
    html[data-theme="dark"] .tbtn-group{ background: rgba(255,255,255,0.04); }
    .tbtn-sep{
      width: 1px; height: 22px;
      background: var(--stroke);
      margin: 0 4px;
      flex-shrink: 0;
    }
    .ctrl{ display:flex; flex-direction:column; gap:3px; align-items:center; }
    .ctrl .label{
      font-size: 10px; font-weight: 800; color: var(--muted);
      line-height: 1; letter-spacing: 0.2px;
      transition: color 0.2s;
    }
    /* topbar position handled above (fixed) */
    .icon-btn{
      width:36px; height:36px; border-radius: 10px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.30);
      display:grid; place-items:center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
      overflow:hidden;
      flex-shrink: 0;
    }
    html[data-theme="dark"] .icon-btn{background: rgba(0,0,0,0.22);}
    .icon-btn i{ font-size: 15px; }
    .icon-btn:active{transform: translateY(1px);}
    /* Accento per save/share */
    .icon-btn.btn-save{ background: linear-gradient(135deg,rgba(20,184,166,0.18),rgba(92,155,255,0.14)); border-color: rgba(20,184,166,0.30); }
    .icon-btn.btn-share{ background: linear-gradient(135deg,rgba(92,155,255,0.18),rgba(123,97,255,0.14)); border-color: rgba(92,155,255,0.30); }
    html[data-theme="dark"] .icon-btn.btn-save{ background: linear-gradient(135deg,rgba(20,184,166,0.22),rgba(92,155,255,0.16)); }
    html[data-theme="dark"] .icon-btn.btn-share{ background: linear-gradient(135deg,rgba(92,155,255,0.22),rgba(123,97,255,0.18)); }
    .icon-btn:disabled{ opacity: 0.40; cursor: not-allowed; }
    .ripple{
      position:absolute; border-radius: 999px; transform: translate(-50%,-50%);
      pointer-events:none;
      width: 10px; height: 10px;
      background: rgba(255,255,255,0.55);
      animation: ripple 520ms ease-out forwards;
      mix-blend-mode: overlay;
    }
    @keyframes ripple{
      from{opacity: 0.85; transform: translate(-50%,-50%) scale(1);}
      to{opacity:0; transform: translate(-50%,-50%) scale(16);}
    }

    main{padding-top: 14px;}

    /* When topbar is fixed, add top padding so content isn't covered */
    .app-shell{padding-top: calc(64px + env(safe-area-inset-top));}  

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-head{
      padding: 14px 14px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.25);
    }
    html[data-theme="dark"] .card-head{border-bottom: 1px solid rgba(255,255,255,0.10);}
    .card-title{font-weight: 1000; letter-spacing:-0.2px;}
    .card-sub{font-size: 12px; color: var(--muted); margin-top: 4px;}
    .card-body{padding: 14px;}

    .note{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .note i{margin-top: 2px; opacity: 0.9;}

    .controls-grid{
      margin-top: 10px;
      display: flex;
      flex-flow: row wrap;
      align-items: flex-end;
      gap: 8px;
    }
    .ctrl-item{ display:flex; flex-direction:column; gap:5px; flex: 0 0 auto; }
    .ctrl-item .control-label{ margin-bottom:0; }
    .control-label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .segmented{
      display:flex;
      gap: 4px;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.30);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    html[data-theme="dark"] .segmented{background: rgba(0,0,0,0.18);}
    .segmented button{
      flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.62);
      color: var(--text);
      padding: 7px 11px;
      border-radius: 9px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
      white-space: nowrap;
    }
    html[data-theme="dark"] .segmented button{background: rgba(16,18,27,0.60); border: 1px solid rgba(255,255,255,0.10);}
    .segmented button[aria-pressed="true"]{
      outline: 2px solid rgba(92,155,255,0.55);
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    }

    .btn-ghost{
      width: 100%;
      min-height: 46px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.30);
      color: var(--text);
      font-weight: 900;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
    }
    html[data-theme="dark"] .btn-ghost{background: rgba(0,0,0,0.18);}
    .btn-ghost:active{transform: translateY(1px);}
    .btn-ghost:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      filter: saturate(0.85);
    }
    .btn-ghost:disabled i{opacity: 0.6;}


    .hint-row{display:flex; gap: 10px; margin-top: 10px; flex-wrap:wrap;}
    .hint-pill{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      color: var(--text);
      font-weight: 800;
    }
    html[data-theme="dark"] .hint-pill{background: rgba(0,0,0,0.20);}

    .row-actions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn{
      border: 1px solid rgba(11,16,32,0.06);
      background: linear-gradient(180deg,#ffffff,#f3f4f6);
      color: var(--text);
      font-weight: 1000;
      padding: 12px 16px;
      border-radius: 16px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      display:flex; align-items:center; gap: 10px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 6px 14px rgba(2,6,23,0.04);
    }
    html[data-theme="dark"] .btn{background: rgba(16,18,27,0.78); color: #fff; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 8px 18px rgba(0,0,0,0.32);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(139,92,246,0.95));
      border: 1px solid rgba(59,130,246,0.45);
      color: #fff;
      box-shadow: 0 10px 22px rgba(59,130,246,0.12);
    }
    .btn:disabled{opacity: 0.55; cursor:not-allowed;}

    /* Preview */
    .preview-wrap{display:none;}
    .preview-wrap.is-visible{display:block;}

    /* Vista a schede */
    .cards-wrap{display:none; margin-top: 10px;}
    .cards-wrap.is-visible{display:block;}

    /* Vista calendario */
    .calendar-wrap{display:none; margin-top: 10px;}
    .calendar-wrap.is-visible{display:block;}
    .cal-month{
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
    }
    .cal-month-title{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -0.2px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(90deg, rgba(92,155,255,0.12), rgba(123,97,255,0.08));
    }
    html[data-theme="dark"] .cal-month-title{
      background: linear-gradient(90deg, rgba(96,165,250,0.18), rgba(139,92,246,0.14));
    }
    .cal-grid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-top: 1px solid var(--stroke);
    }
    .cal-dow{
      text-align: center;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      padding: 8px 4px;
      border-right: 1px solid var(--stroke);
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,0.18);
      letter-spacing: 0.4px;
    }
    html[data-theme="dark"] .cal-dow{background: rgba(0,0,0,0.14);}
    .cal-dow:last-child{border-right: 0;}
    .cal-cell{
      min-height: 72px;
      padding: 6px 5px;
      border-right: 1px solid var(--stroke);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
    }
    .cal-cell:nth-child(7n){border-right: 0;}
    .cal-cell.cal-empty{background: rgba(0,0,0,0.015);}
    html[data-theme="dark"] .cal-cell.cal-empty{background: rgba(0,0,0,0.10);}
    .cal-cell.cal-rest{
      background: rgba(239,68,68,0.04);
    }
    html[data-theme="dark"] .cal-cell.cal-rest{background: rgba(239,68,68,0.07);}
    .cal-cell.cal-holiday{
      background: rgba(239,68,68,0.07);
    }
    .cal-day-num{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      line-height: 1;
      margin-bottom: 2px;
    }
    .cal-cell.cal-today .cal-day-num{
      color: var(--accent);
    }
    .cal-time{
      font-size: 12px;
      font-weight: 900;
      color: var(--text);
      line-height: 1.15;
    }
    .cal-time-end{
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
    }
    .cal-libero{
      font-size: 11px;
      font-weight: 900;
      color: var(--danger);
      letter-spacing: 0.2px;
    }
    .cal-hname{
      font-size: 10px;
      font-weight: 900;
      color: var(--danger);
      line-height: 1.2;
      word-break: break-word;
    }
    .cal-rientro{
      position: absolute;
      top: 3px;
      right: 4px;
      font-size: 8px;
      font-weight: 900;
      color: #d97706;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      line-height: 1;
      pointer-events: none;
    }
    .cal-time.time-red{ color: var(--danger); }
    .week-card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
      margin-bottom: 10px;
    }
    html[data-theme="dark"] .week-card{background: rgba(0,0,0,0.14);}
    .week-card summary{
      list-style: none;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .week-card summary::-webkit-details-marker{display:none;}
    .week-card .wc-title{
      font-weight: 1000;
      font-size: 13px;
      letter-spacing: -0.1px;
    }
    .week-card .wc-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .week-card .wc-left{min-width:0;}
    .week-card .chev{
      width: 34px; height:34px;
      display:grid; place-items:center;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
    }
    html[data-theme="dark"] .week-card .chev{background: rgba(0,0,0,0.18);}
    details[open] .chev{transform: rotate(180deg);}
    .week-card .wc-body{
      padding: 0 12px 12px;
      display:grid;
      gap: 8px;
    }
    .day-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.40);
    }
    html[data-theme="dark"] .day-row{background: rgba(0,0,0,0.12);}
    .day-left{display:flex; flex-direction:column; gap:3px; min-width:0;}
    .day-name{font-weight: 1000; font-size: 12px;}
    .day-date{font-size: 11px; color: var(--muted);}
    .day-right{display:flex; flex-direction:column; align-items:center; gap:4px; position: relative;}
    .day-time{font-weight: 1000; font-size: 12px;}
    .holiday-name{font-size: 10px; font-weight: 900; color: var(--danger);}


    .matrix-container{
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(10, 18, 25, 0.78);
      box-shadow: 0 18px 30px rgba(0,0,0,0.32);
      overflow-x: auto;
      overflow-y: visible; /* la pagina scorre ovunque */
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x pan-y;
      position: relative;
      padding: 10px 12px; /* crea spazio e arrotonda visivamente l'intestazione */
    }

    table.matrix-table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 820px;
      font-size: 13px;
      color: var(--text);
    }
    .matrix-table th, .matrix-table td{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      border-right: 1px solid rgba(255,255,255,0.04);
      vertical-align: middle;
      background: transparent;
      text-align: center;
    }
    .matrix-table thead{background:transparent;}
    .matrix-table th{
      font-size: 14px;
      text-transform: none;
      letter-spacing: 0.2px;
      color: var(--muted);
      font-weight: 1000;
      position: sticky;
      top: 0;
      z-index: 3;
      background: linear-gradient(90deg, rgba(96,165,250,0.95), rgba(139,92,246,0.95));
      color: rgba(255,255,255,0.96);
      backdrop-filter: blur(6px);
      padding-top: 18px;
      padding-bottom: 18px;
    }
    /* Rounded corners for the table header to match container */
    .matrix-table thead th:first-child{ border-top-left-radius: 12px; }
    .matrix-table thead th:last-child{ border-top-right-radius: 12px; }
    .matrix-table th:first-child{
      left: 0;
      z-index: 4;
    }
    .matrix-table td:first-child{
      position: sticky;
      left: 0;
      z-index: 2;
      background: linear-gradient(180deg, rgba(16,18,25,0.95), rgba(30,35,42,0.9));
      backdrop-filter: none;
      min-width: 220px;
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      border-right: 1px solid rgba(255,255,255,0.04);
    }
    .matrix-table tr:last-child td{border-bottom: 0;}
    .matrix-table th:last-child, .matrix-table td:last-child{border-right: 0;}

    /* Reduce contrast dimming — keep rows readable */
    .row-dim{opacity: 1;}
    /* In dark theme keep a slight dim to de-emphasize but readable */
    html[data-theme="dark"] .row-dim{opacity: 0.75;}
    .week-label{
      display:block; /* single-line label for table column */
      text-align:center;
      font-weight: 900;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.6px;
      color: var(--muted);
      padding: 6px 8px;
    }
    .matrix-table td:first-child .week-label{display:block;}
    .week-label small{display:none !important;}    

    .cell{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-height: 44px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      width: fit-content;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      font-weight: 1000;
      font-size: 12px;
    }
    html[data-theme="dark"] .pill{background: rgba(0,0,0,0.18);}

    /* Day-selection pills inside swap search */
    .swap-day-pill{
      font-size:11px; font-weight:800;
      padding:4px 9px; border-radius:20px;
      border:1.5px solid var(--stroke);
      background:transparent; color:var(--text);
      cursor:pointer; transition:background 0.15s, color 0.15s, border-color 0.15s;
      white-space:nowrap;
    }
    .swap-day-pill.active{
      background:var(--accent); color:#fff;
      border-color:var(--accent);
    }
    #swapDayPills{display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 2px;}

    .pill.work{border-color: rgba(92,155,255,0.40);}
    .pill.rest{border-color: rgba(245,158,11,0.40);}
    
    /* In tema scuro: badge LIBERO rossi (come festività) */
    html[data-theme="dark"] .pill.rest{
      border-color: rgba(225,29,72,0.60);
      background: rgba(225,29,72,0.12);
    }
    html[data-theme="dark"] .pill.rest .dot{background: rgba(225,29,72,0.95);}
.pill.holiday{border-color: rgba(225,29,72,0.42);
      font-size: 11px;
      padding: 4px 8px;
    }
    .pill .dot{width:8px; height:8px; border-radius: 999px; background: rgba(92,155,255,0.95);}
    .pill.rest .dot{background: rgba(245,158,11,0.95);}
    .pill.holiday .dot{background: rgba(225,29,72,0.95);}
    .time-red{color: var(--danger);}

    /* Mobile: disable sticky to avoid "layer" feel; let the page scroll anywhere */
    @media (max-width: 720px){
      table.matrix-table{min-width: 720px;}
      .matrix-table th, .matrix-table td{position: static !important; backdrop-filter: none !important;}
      .matrix-table th{background: transparent !important;}
      .matrix-table td:first-child{background: transparent !important;}
      .card{backdrop-filter: none;}
      .topbar{backdrop-filter: none;}
    }

    /* Bottom bar */
    .bottom-bar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 90;
      padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,0.10);
      backdrop-filter: blur(18px);
    }
    html[data-theme="dark"] .bottom-bar{background: rgba(0,0,0,0.25);}
    .bottom-bar__inner{
      max-width: 1100px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .cta{
      border: 0;
      border-radius: 18px;
      min-height: 52px;
      font-weight: 1000;
      color: #fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .cta:disabled{opacity: 0.55; cursor:not-allowed;}
    .cta-save{background: linear-gradient(135deg, rgba(20,184,166,0.95), rgba(92,155,255,0.92));}
    .cta-share{background: linear-gradient(135deg, rgba(92,155,255,0.95), rgba(123,97,255,0.92));}

    /* Toast — nascosto */
    .toast{ display:none !important; }

    /* Step summary chips */
    .step-sum{
      display: none;
      align-items: center;
      gap: 10px;
      padding: 9px 14px;
      border-radius: 12px;
      background: rgba(92,155,255,0.09);
      border: 1px solid var(--stroke);
      margin-bottom: 2px;
    }
    html[data-theme="dark"] .step-sum{ background: rgba(92,155,255,0.13); }
    .step-sum-icon{ font-size:13px; color:#5c9bff; flex-shrink:0; }
    .step-sum-text{ flex:1; font-size:13px; font-weight:700; }
    .step-edit-btn{
      font-size:11px; font-weight:800; color:var(--muted);
      background:none; border:none; cursor:pointer;
      padding:3px 8px; border-radius:6px;
      letter-spacing:0.3px; text-transform:uppercase;
      transition: background 0.15s, color 0.15s;
    }
    .step-edit-btn:hover{ background:var(--stroke); color:var(--fg); }
    @keyframes stepFadeIn {
      from { opacity:0; transform:translateY(-7px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .step-fadein { animation: stepFadeIn .2s cubic-bezier(.4,0,.2,1) both; }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 200;
      display:none;
      align-items: flex-end;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      padding: 14px;
    }
    .modal.is-open{display:flex;}
    .modal-sheet{
      width: min(560px, 100%);
      border-radius: 22px;
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding: 14px 14px; border-bottom: 1px solid rgba(255,255,255,0.25);}
    html[data-theme="dark"] .modal-head{border-bottom: 1px solid rgba(255,255,255,0.10);}
    .modal-title{font-weight: 1000;}
    .modal-list{max-height: 60vh; overflow:auto; -webkit-overflow-scrolling:touch; padding: 10px;}
    #optionList{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    #optionList .modal-item{
      margin-bottom: 0;
      min-height: 44px;
      padding: 8px 10px;
      font-size: 12px;
      text-align: center;
      align-items: center;
      justify-content: center;
      line-height: 1.3;
    }
    @media(max-width:400px){
      #optionList{ grid-template-columns: repeat(2,1fr); }
    }
    .modal-item{
      width:100%;
      min-height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.62);
      color: var(--text);
      font-weight: 900;
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:center;
      padding: 10px 12px;
      cursor:pointer;
      margin-bottom: 10px;
    }
    .modal-item .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      line-height: 1.25;
    }
    html[data-theme="dark"] .modal-item{background: rgba(16,18,27,0.60); border: 1px solid rgba(255,255,255,0.10);}
    .modal-item[aria-current="true"]{outline: 2px solid rgba(92,155,255,0.55);}

    /* Export cleanup */
    .export-root{
      background: #fff;
      color: #111;
      padding: 18px;
      border-radius: 14px;
      width: fit-content;
    }
    .export-root .matrix-table{min-width: 0; width: auto;}
    .export-root .matrix-table th,
    .export-root .matrix-table td{position: static !important; backdrop-filter: none !important;}
    .export-root .matrix-container{overflow: visible !important; border: 1px solid #e5e7eb; background: #fff;}
    .export-root .row-dim{opacity: 1;}
    .export-root .pill{background: #f8fafc; border: 1px solid #e5e7eb;}
    .export-root .pill.work{border-color: rgba(59,130,246,0.50);}
    .export-root .pill.rest{border-color: rgba(245,158,11,0.50);}
    .export-root .pill.holiday{border-color: rgba(225,29,72,0.60);}
    .export-root .time-red{color: #b91c1c;}

    /* Export: vista schede */
    .export-root .week-card{background:#fff; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:10px; overflow:hidden;}
    .export-root .week-card summary{padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .export-root .wc-title{font-weight:900; font-size:13px; color:#0b1020;}
    .export-root .wc-sub{font-size:11px; color:#64748b; margin-top:2px;}
    .export-root .chev{display:none;}
    .export-root .wc-body{padding:0 12px 12px; display:grid; gap:8px;}
    .export-root .day-row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc;}
    .export-root .day-name{font-weight:900; font-size:12px; color:#0b1020;}
    .export-root .day-date{font-size:11px; color:#64748b;}
    .export-root .day-time{font-size:12px; font-weight:900; color:#0b1020; text-align:center;}
    .export-root .time-start{font-weight:900;}
    .export-root .time-end{font-size:11px; font-weight:700; color:#64748b;}
    .export-root .holiday-name{font-size:10px; font-weight:900; color:#b91c1c; text-align:center; margin-top:4px;}

    /* Export: vista calendario */
    .export-root .cal-month{background:#fff; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:14px; overflow:hidden;}
    .export-root .cal-month-title{font-weight:900; font-size:13px; padding:10px 12px; border-bottom:1px solid #e5e7eb; background:#f1f5f9; color:#0b1020;}
    .export-root .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); border-top:1px solid #e5e7eb;}
    .export-root .cal-dow{text-align:center; font-size:11px; font-weight:900; color:#64748b; padding:6px 2px; border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; background:#f8fafc;}
    .export-root .cal-dow:last-child{border-right:0;}
    .export-root .cal-cell{min-height:60px; padding:5px 4px; border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; display:flex; flex-direction:column; gap:2px;}
    .export-root .cal-cell:nth-child(7n){border-right:0;}
    .export-root .cal-cell.cal-empty{background:#fafafa;}
    .export-root .cal-cell.cal-rest{background:#fff5f5;}
    .export-root .cal-cell.cal-holiday{background:#fff1f1;}
    .export-root .cal-day-num{font-size:11px; font-weight:900; color:#64748b;}
    .export-root .cal-time{font-size:12px; font-weight:900; color:#0b1020;}
    .export-root .cal-time.time-red{color:#b91c1c;}
    .export-root .cal-time-end{font-size:11px; color:#64748b;}
    .export-root .cal-libero{font-size:11px; font-weight:900; color:#b91c1c;}
    .export-root .cal-hname{font-size:10px; font-weight:900; color:#b91c1c; line-height:1.2;}

    /* --- Classic dark look (as screenshot) --- */
    .hint-strip{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(220, 230, 238, 0.75);
      color: rgba(10,16,26,0.78);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
      margin: 10px 0 14px;
      font-weight: 700;
    }
    html[data-theme="dark"] .hint-strip{
      background: rgba(210, 220, 228, 0.55);
      color: rgba(255,255,255,0.80);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .hint-strip i{color: #fb923c;}

    .select-like{
      width:100%;
      min-height: 50px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(10, 18, 25, 0.55);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 14px;
      font-weight: 800;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Quando select-like è dentro un ctrl-item (flex row) non si allarga a tutto */
    .ctrl-item .select-like{ width:auto; min-width:130px; min-height:40px; border-radius:11px; font-size:13px; padding:0 10px; }
    /* OK button inline */
    .ctrl-item .ok-btn{ flex:0 0 auto; min-height:40px; padding:0 18px; border-radius:11px; font-size:13px; }
    .card-sub{display:none !important;}
    .card-title{display:none !important;}
    .hint-strip{display:none !important;}
    .select-like:disabled{opacity: 0.55; cursor:not-allowed;}
    .select-like__left{display:flex; align-items:center; gap: 10px; min-width:0;}
    .select-like__left span{white-space:nowrap; overflow:hidden; text-overflow: ellipsis;}
    .select-like i{opacity: 0.9;}

    .row-actions{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 14px;
    }
    .ok-btn{
      flex: 1 1 auto;
      min-height: 56px;
      border-radius: 16px;
      border: 0;
      background: linear-gradient(90deg, #4f46e5, #06b6d4);
      color: white;
      font-weight: 900;
      letter-spacing: 0.4px;
      box-shadow: 0 14px 30px rgba(79,70,229,0.14);
    }
    .ok-btn:disabled{filter: grayscale(0.2); opacity: 0.55;}
    .btn:focus-visible, .ok-btn:focus-visible{ outline: 3px solid rgba(59,130,246,0.28); outline-offset: 3px; }
    .ok-btn:disabled{filter: grayscale(0.2); opacity: 0.55;}
    .row-actions .icon-btn{
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: rgba(10, 18, 25, 0.45);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }

    /* table look (applied only in dark theme) */
    html[data-theme="dark"] .matrix-container{
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      background: rgba(10, 18, 25, 0.70);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      box-shadow: 0 18px 30px rgba(0,0,0,0.28);
      touch-action: pan-x pan-y;
    }
    html[data-theme="dark"] table.matrix-table{min-width: 780px;}
    html[data-theme="dark"] .matrix-table th{
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      background: linear-gradient(90deg, rgba(96,165,250,0.85), rgba(139,92,246,0.85));
      border-right: 1px solid rgba(255,255,255,0.12);
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    html[data-theme="dark"] .matrix-table td{
      background: rgba(11, 18, 25, 0.40);
      color: rgba(255,255,255,0.88);
      border-right: 1px solid rgba(255,255,255,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    html[data-theme="dark"] .matrix-table tr:nth-child(even) td{background: var(--table-zebra);}    
    html[data-theme="dark"] .week-label{display:block; font-weight: 900;}
    html[data-theme="dark"] .week-label small{display:block; margin-top: 6px; font-weight: 800; color: rgba(255,255,255,0.58);}
    html[data-theme="dark"] .cell-stack{display:flex; flex-direction:column; gap: 10px; align-items:center; justify-content:center; padding: 8px 0;}
    html[data-theme="dark"] .cell-time{font-weight: 900;}
    /* Increase table row height and emphasize time */
    .matrix-table td .cell-stack{ min-height: 64px; padding-top: 6px; padding-bottom: 6px; position: relative; }
    .matrix-table .cell-time, .matrix-table .day-time{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size: 14px;
      text-align: center;
      line-height: 1.1;
    }
    .matrix-table .cell-time .time-start,
    .matrix-table .day-time .time-start{ font-weight: 900; }
    .matrix-table .cell-time .time-end,
    .matrix-table .day-time .time-end{ color: var(--muted); font-size: 13px; font-weight: 700; }
    /* Ensure pill badges and other inline elements are centered */
    .matrix-table .pill, .matrix-table .cell-stack{ display:flex; align-items:center; justify-content:center; }
    /* Force vertical stacking inside table cells: time above, holiday name below */
    .matrix-table .cell-stack{ flex-direction: column !important; }
    .matrix-table .cell-time{ display:flex; flex-direction:column; align-items:center; }
    .matrix-table .holiday-name{ display:block; width:100%; text-align:center; margin-top:6px; }
    html[data-theme="dark"] .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height: 30px;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.4px;
      border: 0;
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.94);
    }
    html[data-theme="dark"] .pill.rest{
      background: linear-gradient(180deg, rgba(239,68,68,0.95), rgba(239,68,68,0.85));
      color: #fff;
      box-shadow: 0 6px 14px rgba(239,68,68,0.12) inset;
    }
    html[data-theme="dark"] .pill.work{
      background: rgba(255,255,255,0.08);
    }
    html[data-theme="dark"] .pill.holiday{
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.40);
    }
    html[data-theme="dark"] .time-red{color: #fecaca; font-weight: 900;}
    @media (max-width: 720px){
      /* su mobile: niente sticky e niente “vetro” */
      .card{backdrop-filter: none;}
      .topbar{backdrop-filter: none;}
    }

  
    #refHintRow{ display:none !important; }

    .spacer-8{ height:8px; }

    /* Accessibilità: testo solo per screen reader */
    .sr-only{
      position:absolute;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    /* Nasconde “Settimana X” ovunque */
    .week-label small{display:none !important;}

    /* Festività: nome in rosso più piccolo */
    .holiday-name{
      font-size: 11px;
      font-weight: 900;
      color: var(--danger);
      line-height: 1.1;
      letter-spacing: 0.1px;
    }
    /* Force holiday name below times and centered (cards) */
    .day-right .holiday-name{ display:block; width:100%; text-align:center; margin-top:6px; }

    /* Light theme overrides: keep preview and controls clean and high-contrast */
    html[data-theme="light"] .matrix-container{
      background: var(--table-bg);
      border: 1px solid rgba(11,16,32,0.06);
      box-shadow: var(--shadow-soft);
      padding: 8px;
    }
    html[data-theme="light"] table.matrix-table{min-width: 780px;}
    html[data-theme="light"] .matrix-table th{
      color: var(--text);
      font-weight: 900;
      background: linear-gradient(90deg, rgba(92,155,255,0.10), rgba(123,97,255,0.06));
      border-right: 1px solid rgba(11,16,32,0.06);
      border-bottom: 1px solid rgba(11,16,32,0.04);
    }
    html[data-theme="light"] .matrix-table td{
      background: var(--table-bg);
      color: var(--text);
      border-right: 1px solid rgba(11,16,32,0.04);
      border-bottom: 1px solid rgba(11,16,32,0.03);
    }
    html[data-theme="light"] .matrix-table tr:nth-child(even) td{background: var(--table-zebra);}    
    html[data-theme="light"] .matrix-table td:first-child{
      background: var(--table-bg);
      color: var(--text);
      font-weight: 800;
      border-right: 1px solid rgba(11,16,32,0.06);
    }
    html[data-theme="light"] .pill{
      background: #f1f5f9;
      color: var(--text);
      border: 1px solid rgba(11,16,32,0.06);
    }
    html[data-theme="light"] .pill.rest{
      background: #fff5f5;
      color: #b91c1c;
      border: 1px solid rgba(239,68,68,0.12);
    }
    html[data-theme="light"] .select-like{
      background: var(--card);
      border: 1px solid rgba(11,16,32,0.06);
      color: var(--text);
    }
    html[data-theme="light"] .card{ background: var(--card); }
    html[data-theme="light"] .topbar{ background: var(--card); border:1px solid rgba(11,16,32,0.04); }


    /* Responsive: piccoli schermi */
    @media (max-width: 520px){
      .topbar{ padding:8px 10px; gap:8px; }
      .brand-text{ display:none; }
      .icon-btn{ width:32px; height:32px; border-radius:9px; }
      .icon-btn i{ font-size:13px; }
      .ctrl .label{ font-size:8px; letter-spacing:0; }
    }

    /* Evidenzia riga/cella corrente nella tabella */
    .matrix-table tr.row-today > td { background: rgba(92,155,255,0.08) !important; }
    html[data-theme="dark"] .matrix-table tr.row-today > td { background: rgba(92,155,255,0.12) !important; }
    .matrix-table td.cell-today { outline: 2px solid var(--accent); outline-offset: -3px; border-radius: 4px; }

    /* Weekend non-riposo nel calendario */
    .cal-cell.cal-weekend { background: rgba(11,16,32,0.03); }
    html[data-theme="dark"] .cal-cell.cal-weekend { background: rgba(255,255,255,0.03); }

    /* Filtro rapido mese nel calendario */
    .cal-month-filter {
      display: flex; gap: 8px; overflow-x: auto; padding: 2px 2px 10px;
      -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .cal-month-filter::-webkit-scrollbar { display: none; }
    .cal-month-pill {
      flex: 0 0 auto;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      color: var(--text);
      font-size: 12px; font-weight: 900;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    html[data-theme="dark"] .cal-month-pill { background: rgba(0,0,0,0.20); }
    .cal-month-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* Indicatore vista attiva sotto il tasto */
    .ctrl .label { transition: color 0.2s; }

    /* Calendario responsivo su schermi piccoli */
    @media (max-width: 480px) {
      .cal-cell { min-height: 52px; padding: 4px 3px; }
      .cal-day-num { font-size: 10px; }
      .cal-time { font-size: 11px; }
      .cal-time-end { font-size: 10px; }
      .cal-libero { font-size: 10px; }
      .cal-hname { font-size: 9px; }
      .cal-dow { font-size: 10px; padding: 6px 2px; }
      .cal-month-title { font-size: 13px; }
    }
    @media (max-width: 360px) {
      .calendar-wrap { overflow-x: auto; }
      .cal-grid { min-width: 320px; }
    }

    /* CSS Stampa */
    @media print {
      body { background: #fff !important; padding: 0 !important; padding-bottom: 0 !important; }
      .topbar, .top-actions, .toast, .card-head button, #generateBtn, #resetBtn, .row-actions { display: none !important; }
      .card:first-child .card-body { display: none !important; }
      .app-shell { padding-top: 0 !important; }
      .card { box-shadow: none !important; border: 1px solid #e5e7eb !important; background: #fff !important; backdrop-filter: none !important; }
      .preview-wrap { display: block !important; }
      #matrixTableWrap, #matrixCardsWrap, #matrixCalendarWrap { display: none !important; }
      #matrixTableWrap.print-show, #matrixCardsWrap.print-show, #matrixCalendarWrap.print-show { display: block !important; }
      .matrix-container { overflow: visible !important; box-shadow: none !important; border: 1px solid #e5e7eb !important; }
      .matrix-table th, .matrix-table td { position: static !important; backdrop-filter: none !important; }
      .matrix-table th { background: #f1f5f9 !important; color: #0b1020 !important; }
      .matrix-table td { background: #fff !important; color: #0b1020 !important; }
      .week-card { break-inside: avoid; }
      .cal-month { break-inside: avoid; margin-bottom: 8px; }
      .cal-month-filter { display: none !important; }
    }

    /* ===== WEEK CAL DIALOG ===== */
    dialog.week-cal-dialog{
      border:none; padding:0; background:transparent;
      width:min(340px, calc(100vw - 32px));
      border-radius:22px;
      box-shadow: var(--shadow);
    }
    dialog.week-cal-dialog::backdrop{
      background:rgba(0,0,0,0.5);
    }
    dialog.week-cal-dialog .modal-sheet{
      width:100%; border-radius:22px;
    }

    /* ===== INLINE CALENDAR (selezione settimana) ===== */
    .ical-wrap{
      background:var(--input); border:1px solid var(--stroke);
      border-radius:14px; padding:12px 10px 8px; max-width:290px;
      user-select:none;
    }
    .ical-nav{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px; gap:4px;
    }
    .ical-nav-btn{
      background:var(--card); border:1px solid var(--stroke); border-radius:8px;
      color:var(--fg); cursor:pointer; font-size:15px; font-weight:900;
      padding:3px 10px; line-height:1.4; transition:background .15s;
    }
    .ical-nav-btn:hover{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .ical-month-label{
      font-weight:900; font-size:13px; color:var(--fg); flex:1; text-align:center;
    }
    .ical-dow-row,.ical-days-grid{
      display:grid; grid-template-columns:repeat(7,1fr); gap:1px;
    }
    .ical-dow{
      text-align:center; font-size:10px; font-weight:700;
      color:var(--muted); padding:2px 0 5px;
    }
    .ical-day{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center;
      border-radius:5px; font-size:12px; font-weight:600; cursor:pointer;
      transition:background .1s; position:relative; color:var(--fg);
    }
    .ical-day:hover{ background:rgba(92,155,255,0.18); }
    .ical-day.other-month{ opacity:.28; }
    .ical-day.today::after{
      content:''; position:absolute; bottom:2px; left:50%;
      transform:translateX(-50%); width:4px; height:4px;
      border-radius:50%; background:var(--accent);
    }
    .ical-day.sel-week{ background:rgba(92,155,255,0.18); color:var(--accent); font-weight:900; }
    .ical-day.sel-week-start{ border-radius:6px 0 0 6px; background:var(--accent); color:#fff; }
    .ical-day.sel-week-end{ border-radius:0 6px 6px 0; background:rgba(92,155,255,0.25); }
    .ical-day.sel-week-mid{ border-radius:0; }

    /* ===== ADMIN ===== */
    .admin-badge{
      display:inline-flex; align-items:center; gap:5px;
      font-size:11px; font-weight:900; padding:3px 9px;
      border-radius:8px; letter-spacing:0.3px;
    }
    .admin-badge.on{ background:rgba(20,184,166,0.15); color:#14b8a6; border:1px solid rgba(20,184,166,0.3); }
    .admin-badge.off{ background:rgba(148,163,184,0.10); color:var(--muted); border:1px solid var(--stroke); }
    .admin-badge i{ font-size:10px; }
    /* Admin lock button accent */
    .icon-btn.locked{ border-color: rgba(245,158,11,0.4); }
    .icon-btn.locked i{ color:#f59e0b; }
    .icon-btn.unlocked{ border-color: rgba(20,184,166,0.4); }
    .icon-btn.unlocked i{ color:#14b8a6; }
    /* Time search */
    .search-time-input{
      width:110px; flex-shrink:0;
      padding:10px 12px; border-radius:12px;
      background:var(--input); border:1px solid var(--stroke);
      color:var(--fg); font-size:14px; font-family:inherit; font-weight:700;
    }
    .search-time-input:focus{ outline:none; border-color:rgba(92,155,255,0.5); }
    .badge-active{ background:rgba(92,155,255,0.15); color:#5c9bff; border:1px solid rgba(92,155,255,0.3); }
    .badge-offshift{ background:rgba(148,163,184,0.12); color:var(--muted); border:1px solid var(--stroke); }
    .team-list{ display:flex; flex-direction:column; gap:8px; }
    .colleague-row{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-radius:14px;
      background: var(--input); border:1px solid var(--stroke);
    }
    .colleague-avatar{
      width:36px; height:36px; border-radius:50%;
      display:grid; place-items:center;
      font-weight:900; font-size:15px; flex-shrink:0;
      background: linear-gradient(135deg,rgba(92,155,255,0.28),rgba(123,97,255,0.28));
      text-transform:uppercase; color: var(--fg);
      border:1px solid var(--stroke);
    }
    .colleague-info{ flex:1; min-width:0; }
    .colleague-name{ font-size:14px; font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .colleague-meta{ font-size:11px; color:var(--muted); margin-top:2px; }
    .colleague-actions{ display:flex; gap:4px; flex-shrink:0; }
    .btn-icon-sm{
      width:30px; height:30px; border-radius:8px; border:1px solid var(--stroke);
      background:none; cursor:pointer; display:grid; place-items:center;
      font-size:12px; color:var(--muted); transition:background 0.15s,color 0.15s;
    }
    .btn-icon-sm:hover{ background:var(--stroke); color:var(--fg); }
    .btn-icon-sm.del:hover{ background:rgba(239,68,68,0.14); color:#f87171; border-color:rgba(239,68,68,0.3); }

    /* ===== SEARCH ===== */
    .search-date-bar{ display:flex; gap:8px; align-items:center; }
    .search-date-input{
      flex:1; padding:10px 14px; border-radius:12px;
      background:var(--input); border:1px solid var(--stroke);
      color:var(--fg); font-size:14px; font-family:inherit; font-weight:700;
    }
    .search-date-input:focus{ outline:none; border-color:rgba(92,155,255,0.5); }
    .search-results{ display:flex; flex-direction:column; gap:6px; margin-top:12px; }
    .sr-row{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius:12px;
      background:var(--input); border:1px solid var(--stroke);
    }
    .sr-avatar{
      width:32px; height:32px; border-radius:50%;
      display:grid; place-items:center; font-size:13px; font-weight:900;
      background:linear-gradient(135deg,rgba(92,155,255,0.22),rgba(123,97,255,0.22));
      border:1px solid var(--stroke); flex-shrink:0; text-transform:uppercase;
    }
    .sr-name{ font-size:13px; font-weight:800; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sr-badge{
      font-size:12px; font-weight:700; padding:3px 10px;
      border-radius:8px; flex-shrink:0; white-space:nowrap;
    }
    .badge-work{ background:rgba(20,184,166,0.15); color:#14b8a6; border:1px solid rgba(20,184,166,0.3); }
    .badge-rest{ background:rgba(245,158,11,0.12); color:#f59e0b; border:1px solid rgba(245,158,11,0.25); }
    .badge-holiday{ background:rgba(239,68,68,0.12); color:#ef4444; border:1px solid rgba(239,68,68,0.2); }
    .badge-out{ background:rgba(148,163,184,0.12); color:var(--muted); border:1px solid var(--stroke); }
    .sr-time{ font-size:12px; color:var(--muted); white-space:nowrap; }
    .search-head-row{
      display:flex; align-items:center; gap:8px;
      padding:6px 0 10px;
      font-size:12px; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:0.4px;
    }
    .search-head-row i{ font-size:13px; }
    .no-results-note{ font-size:13px; color:var(--muted); padding:8px 0; }

    /* ===== COLLEAGUE MODAL ===== */
    .modal-form{ padding:14px; display:flex; flex-direction:column; gap:14px; }
    .modal-field{ display:flex; flex-direction:column; gap:6px; }
    .modal-field label{ font-size:11px; font-weight:900; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
    .modal-text-input{
      padding:10px 14px; border-radius:12px;
      background:var(--input); border:1px solid var(--stroke);
      color:var(--fg); font-family:inherit; font-size:15px; font-weight:700;
    }
    .modal-text-input:focus{ outline:none; border-color:rgba(92,155,255,0.55); }
    .modal-select{
      padding:10px 14px; border-radius:12px;
      background:var(--input); border:1px solid var(--stroke);
      color:var(--fg); font-family:inherit; font-size:14px; font-weight:700;
    }
    .modal-select:focus{ outline:none; border-color:rgba(92,155,255,0.55); }
    .modal-actions{ display:flex; gap:8px; padding:0 14px 14px; }
    .btn-primary-lg{
      flex:1; padding:12px; border-radius:12px; cursor:pointer;
      background:linear-gradient(135deg,rgba(92,155,255,0.88),rgba(123,97,255,0.88));
      border:none; color:#fff; font-weight:900; font-size:14px; font-family:inherit;
    }
    .btn-primary-lg:disabled{ opacity:0.42; cursor:not-allowed; }
    .btn-secondary-lg{
      padding:12px 20px; border-radius:12px; cursor:pointer;
      background:var(--input); border:1px solid var(--stroke);
      color:var(--fg); font-weight:800; font-size:14px; font-family:inherit;
    }
    .modal-sheet-scroll{ max-height:85vh; overflow-y:auto; }

</style>
</head>

<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="brand">
        <div class="brand-icon" aria-hidden="true">📅</div>
        <div class="brand-text">
          <h1>Matrice Orari</h1>
          <small id="brandSub">Seleziona ruolo e orario</small>
        </div>
        <div class="ctrl" style="margin-left:6px;">
          <button class="icon-btn locked" id="adminLockBtn" type="button" aria-label="Accedi come admin" title="Accedi come admin">
            <i class="fa-solid fa-lock"></i>
          </button>
          <span class="label" id="adminLabel">Admin</span>
        </div>
        <div class="ctrl" id="orarioColleghiCtrl" style="display:none;">
          <button class="icon-btn" id="orarioColleghiBtn" type="button" title="Orario Colleghi" aria-label="Orario Colleghi">
            <i class="fa-solid fa-users"></i>
          </button>
          <span class="label">Colleghi</span>
        </div>
        <div class="ctrl" id="cercaOrarioCtrl" style="display:none;">
          <button class="icon-btn" id="cercaOrarioBtn" type="button" title="Cerca orario" aria-label="Cerca orario">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
          <span class="label">Cerca</span>
        </div>
      </div>

      <div class="top-actions" role="group" aria-label="Azioni principali">
        <!-- Gruppo vista -->
        <div class="tbtn-group">
          <div class="ctrl">
            <button class="icon-btn" id="viewToggle" type="button" aria-label="Cambia vista">
              <i class="fa-solid fa-layer-group"></i>
            </button>
            <span class="label" id="viewLabel">Tabella</span>
          </div>
        </div>

        <div class="tbtn-sep"></div>

        <!-- Gruppo utility -->
        <div class="tbtn-group">
          <div class="ctrl">
            <button class="icon-btn" id="themeToggle" type="button" aria-label="Cambia tema">
              <i class="fa-solid fa-moon" id="themeIcon"></i>
            </button>
            <span class="label" id="themeLabel">Buio</span>
          </div>
        </div>

        <div class="tbtn-sep"></div>

        <!-- Gruppo export -->
        <div class="tbtn-group">
          <div class="ctrl">
            <button class="icon-btn btn-save" id="saveTopBtn" type="button" aria-label="Salva PDF" disabled>
              <i class="fa-solid fa-download"></i>
            </button>
            <span class="label">Salva</span>
          </div>
        </div>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Impostazioni</div>
            <div class="card-sub">Segui i passaggi per generare la matrice.</div>
          </div>
        </div>
        <div class="card-body">

          <div class="controls-grid">

            <!-- Step 1: Ruolo -->
            <div class="ctrl-item">
              <div id="step-role-input">
                <span class="control-label">Ruolo</span>
                <div class="segmented" id="roleSegment" role="group" aria-label="Tipo operatore">
                  <button type="button" data-role="dipendente" aria-pressed="false">Dipendente</button>
                  <button type="button" data-role="tutor" aria-pressed="false">Tutor</button>
                </div>
              </div>
              <div id="step-role-sum" class="step-sum">
                <i class="fa-solid fa-user step-sum-icon"></i>
                <span class="step-sum-text" id="step-role-text"></span>
                <button class="step-edit-btn" id="step-role-edit" type="button">Modifica</button>
              </div>
            </div>

            <!-- Step 2: Team -->
            <div class="ctrl-item">
              <div id="step-team-input" style="display:none;">
                <span class="control-label">Team</span>
                <select class="select-like" id="teamSelect">
                  <option value="">-- Seleziona team --</option>
                </select>
              </div>
              <div id="step-team-sum" class="step-sum">
                <i class="fa-solid fa-users step-sum-icon"></i>
                <span class="step-sum-text" id="step-team-text"></span>
                <button class="step-edit-btn" id="step-team-edit" type="button">Modifica</button>
              </div>
            </div>

            <!-- Step 3: Ore -->
            <div class="ctrl-item">
              <div id="step-hours-input">
                <span class="control-label">Monte ore</span>
                <select class="select-like" id="hoursSelect" style="min-width:170px;">
                  <option value="">-- Seleziona --</option>
                  <option value="20h">20h settimanali</option>
                  <option value="30h">30h settimanali</option>
                  <option value="33h">33h settimanali</option>
                  <option value="40h">40h settimanali</option>
                </select>
              </div>
              <div id="step-hours-sum" class="step-sum">
                <i class="fa-solid fa-clock step-sum-icon"></i>
                <span class="step-sum-text" id="step-hours-text"></span>
                <button class="step-edit-btn" id="step-hours-edit" type="button">Modifica</button>
              </div>
            </div>

            <!-- Step 3+4: Settimana di partenza (calendario modale) -->
            <div class="ctrl-item" style="align-items:flex-start;">
              <div id="step-week-input">
                <span class="control-label">Settimana di partenza</span>
                <button class="select-like" id="weekPickerBtn" type="button">
                  <span class="select-like__left">
                    <i class="fa-solid fa-calendar-week" style="margin-right:8px;opacity:.7;"></i>
                    <span id="calSelLabel">Seleziona settimana</span>
                  </span>
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
              </div>
              <div id="step-week-sum" class="step-sum" style="display:none;">
                <i class="fa-solid fa-calendar-week step-sum-icon"></i>
                <span class="step-sum-text" id="step-week-text"></span>
                <button class="step-edit-btn" id="step-week-edit" type="button">Modifica</button>
              </div>
            </div>

            <!-- Step 5: Orario -->
            <div class="ctrl-item">
              <div id="step-option-input">
                <span class="control-label">Orario e riposi</span>
                <button class="select-like" id="optionBtn" type="button" disabled>
                  <span class="select-like__left"><span id="optionLabel">Seleziona</span></span>
                  <i class="fa-solid fa-chevron-down"></i>
                </button>
                <div class="hint-row" id="refHintRow" style="display:none;"></div>
              </div>
              <div id="step-option-sum" class="step-sum">
                <i class="fa-solid fa-clock-rotate-left step-sum-icon"></i>
                <span class="step-sum-text" id="step-option-text"></span>
                <button class="step-edit-btn" id="step-option-edit" type="button">Modifica</button>
              </div>
            </div>

            <!-- Reset inline -->
            <div class="ctrl-item" style="justify-content:flex-end;">
              <span class="control-label" style="visibility:hidden;">Reset</span>
              <div style="display:flex;gap:6px;align-items:center;">
                <button class="btn ok-btn" id="generateBtn" type="button" disabled style="display:none;"><i class="fa-solid fa-check"></i> OK</button>
                <button class="icon-btn" id="resetBtn" type="button" aria-label="Reset"><i class="fa-solid fa-rotate-left"></i></button>
              </div>
            </div>

          </div>
        </div>
      </section>

      <section class="card" id="previewCard" style="display:none;">
        <div class="card-head" style="border-bottom:0; padding-bottom:8px;">
          <div>
            <div class="card-title" style="display:block !important; font-size:13px; font-weight:900; opacity:0.7;">Anteprima</div>
          </div>
          <button class="icon-btn" id="previewTopBtn" type="button" aria-label="Torna su"><i class="fa-solid fa-arrow-up"></i></button>
        </div>
        <div class="card-body">
          <div class="preview-wrap" id="previewWrap">
            <div class="matrix-container" id="matrixTableWrap" aria-label="Matrice orari"></div>
            <div class="cards-wrap" id="matrixCardsWrap" aria-label="Matrice (schede)" style="display:none;"></div>
            <div class="calendar-wrap" id="matrixCalendarWrap" aria-label="Matrice (calendario)" style="display:none;"></div>
          </div>

          <div id="emptyPreview" class="note" style="margin-top:2px; display:none;">
            <i class="fa-regular fa-eye-slash"></i>
          </div>
        </div>
      </section>

      <!-- Team card -->
      <section class="card" id="teamCard" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">Colleghi del Team</div>
            <div class="card-sub">Operatori configurati con matrice orari.</div>
          </div>
          <button class="icon-btn" id="addColleagueBtn" type="button" aria-label="Aggiungi collega" title="Aggiungi collega" style="display:none;">
            <i class="fa-solid fa-user-plus"></i>
          </button>
        </div>
        <div class="card-body">
          <div class="team-list" id="teamList">
            <div class="note" id="teamEmpty" style="color:var(--muted); font-size:13px;">
              <i class="fa-regular fa-users" style="margin-right:6px;"></i>Nessun collega nel team.
            </div>
          </div>
        </div>
      </section>

      <!-- Cerca per data e orario -->
      <section class="card" id="searchDateCard" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">Cerca per orario</div>
            <div class="card-sub">Chi è in turno in un giorno e orario specifico?</div>
          </div>
        </div>
        <div class="card-body">
          <div class="search-date-bar">
            <input type="date" class="search-date-input" id="searchDateInput" style="flex:1;" />
            <input type="time" class="search-time-input" id="searchTimeInput" />
            <button class="icon-btn" id="searchDateBtn" type="button" aria-label="Cerca">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </div>
          <div class="search-results" id="searchResults" style="display:none;"></div>
        </div>
      </section>

      <!-- Scambi Orari -->
      <section class="card" id="swapCard" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">Scambi Orari</div>
            <div class="card-sub">Verifica se uno scambio di turno con un collega è ammesso dal contratto.</div>
          </div>
        </div>
        <div class="card-body">
          <div id="swapPrereq" class="note">
            <i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>
            Aggiungi almeno un collega con configurazione completa.
          </div>
          <div id="swapForm" style="display:none;">

            <!-- Riga 1: il tuo turno quel giorno -->
            <div id="swapManualSection" style="display:none; margin-bottom:10px;">
              <div style="font-size:10px; font-weight:900; opacity:0.5; text-transform:uppercase; letter-spacing:.06em; margin-bottom:6px;">Il tuo turno nel giorno che hai</div>
              <div class="controls-grid" style="gap:8px;">
                <div class="ctrl-item">
                  <span class="control-label">Sei</span>
                  <div class="segmented" id="swapRoleSegment" role="group">
                    <button type="button" data-role="dipendente" aria-pressed="false">Dipendente</button>
                    <button type="button" data-role="tutor" aria-pressed="false">Tutor</button>
                  </div>
                </div>
                <div class="ctrl-item">
                  <span class="control-label">Inizio turno</span>
                  <select id="swapManualStart" class="hours-select" style="width:100%;">
                    <option value="">-- orario --</option>
                    <option value="06:00">06:00</option>
                    <option value="08:00">08:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="15:00">15:00</option>
                    <option value="18:00">18:00</option>
                  </select>
                </div>
                <!-- Fine turno nascosta, popolata via JS -->
                <input type="time" id="swapManualEnd" style="display:none;" readonly />
              </div>
            </div>

            <!-- Riga 2: date -->
            <div class="controls-grid" style="gap:8px;">
              <div class="ctrl-item" style="flex:1 1 150px;min-width:150px;">
                <span class="control-label">Il giorno che hai</span>
                <input type="date" id="swapMyDate" class="search-date-input" style="width:100%;min-width:150px;" />
              </div>
              <div class="ctrl-item" style="flex:1 1 150px;min-width:150px;">
                <span class="control-label">Il giorno che vuoi</span>
                <input type="date" id="swapTargetDate" class="search-date-input" style="width:100%;min-width:150px;" />
              </div>
            </div>
            <div class="controls-grid" style="gap:8px;margin-top:4px;">
              <div class="ctrl-item" id="swapDesiredShiftFields">
                <span class="control-label">Orario desiderato</span>
                <select id="swapDesiredStart" class="hours-select" style="width:100%;">
                  <option value="">-- orario --</option>
                  <option value="06:00">06:00</option>
                  <option value="08:00">08:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="15:00">15:00</option>
                  <option value="18:00">18:00</option>
                </select>
                <!-- Fine desiderata nascosta, popolata via JS -->
                <input type="time" id="swapDesiredEnd" style="display:none;" readonly />
              </div>
              <div class="ctrl-item" style="justify-content:flex-end;">
                <span class="control-label" style="visibility:hidden;">OK</span>
                <button class="btn ok-btn" id="swapSearchBtn" type="button">
                  <i class="fa-solid fa-magnifying-glass"></i> Cerca colleghi
                </button>
              </div>
            </div>
          </div>
          <div id="swapResult" style="display:none; margin-top:12px;"></div>
        </div>
      </section>

      <!-- Trova Collega -->
      <section class="card" id="findColleagueCard" style="display:none;">
        <div class="card-head">
          <div>
            <div class="card-title">Trova Collega</div>
            <div class="card-sub">Cerca chi ha un orario specifico in un giorno, tenendo conto delle regole di scambio.</div>
          </div>
        </div>
        <div class="card-body">
          <div id="findColPrereq" class="note">
            <i class="fa-solid fa-triangle-exclamation" style="margin-right:6px;"></i>
            Genera prima la tua matrice e aggiungi almeno un collega con configurazione completa.
          </div>
          <div id="findColForm" style="display:none;">
            <div class="controls-grid" style="gap:8px;">
              <div class="ctrl-item">
                <span class="control-label">Giorno</span>
                <input type="date" id="findColDate" class="search-date-input" style="width:100%;" />
              </div>
              <div class="ctrl-item">
                <span class="control-label">Cerco orario</span>
                <select id="findColTarget" class="hours-select" style="width:100%;">
                  <option value="">— seleziona orario —</option>
                </select>
              </div>
              <div class="ctrl-item" style="justify-content:flex-end;">
                <span class="control-label" style="visibility:hidden;">OK</span>
                <button class="btn ok-btn" id="findColBtn" type="button">
                  <i class="fa-solid fa-magnifying-glass"></i> Cerca
                </button>
              </div>
            </div>
            <div id="findColMyShift" style="display:none;margin-top:8px;padding:8px 12px;border-radius:10px;background:var(--ctrl-bg);font-size:13px;"></div>
          </div>
          <div id="findColResult" style="display:none;margin-top:12px;"></div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modals -->

  <!-- Modal matrice collega -->
  <div class="modal" id="colleagueMatrixModal" role="dialog" aria-modal="true">
    <div class="modal-sheet modal-sheet-scroll" style="width:min(720px,100%);">
      <div class="modal-head" style="flex-wrap:wrap;gap:8px;">
        <div class="modal-title" id="colleagueMatrixTitle">Matrice collega</div>
        <div style="display:flex;gap:6px;align-items:center;">
          <div id="colleagueViewToggle" style="display:flex;border:1.5px solid #e2e8f0;border-radius:8px;overflow:hidden;">
            <button id="toggleCalBtn" type="button" title="Vista calendario"
              style="padding:5px 10px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-size:12px;font-weight:700;transition:background .15s;">
              <i class="fa-solid fa-calendar-days"></i>
            </button>
            <button id="toggleCardsBtn" type="button" title="Vista schede settimanali"
              style="padding:5px 10px;border:0;background:#fff;color:#64748b;cursor:pointer;font-size:12px;font-weight:700;transition:background .15s;">
              <i class="fa-solid fa-layer-group"></i>
            </button>
            <button id="toggleTblBtn" type="button" title="Vista tabella"
              style="padding:5px 10px;border:0;background:#fff;color:#64748b;cursor:pointer;font-size:12px;font-weight:700;transition:background .15s;">
              <i class="fa-solid fa-table-list"></i>
            </button>
          </div>
          <button class="icon-btn btn-save" id="saveCollegueMatrixBtn" type="button" aria-label="Salva PDF" title="Salva PDF">
            <i class="fa-solid fa-download"></i>
          </button>
          <button class="icon-btn" id="closeColleagueMatrixModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>
      <div style="padding:10px 14px 18px;" id="colleagueMatrixBody"></div>
    </div>
  </div>

  <!-- Dialog selezione settimana -->
  <dialog id="weekCalModal" class="week-cal-dialog">
    <div class="modal-sheet">
      <div class="modal-head">
        <div class="modal-title" id="weekCalTitle"><i class="fa-solid fa-calendar-week" style="margin-right:8px;color:var(--accent);"></i>Settimana di partenza</div>
        <button class="icon-btn" id="closeWeekCalModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div style="padding:4px 16px 20px;">
        <div class="ical-wrap" id="icalWrap" style="max-width:100%;border:none;background:transparent;padding:0;">
          <div class="ical-nav">
            <button class="ical-nav-btn" id="calPrev" type="button">&#8249;</button>
            <span class="ical-month-label" id="calMonthLabel"></span>
            <button class="ical-nav-btn" id="calNext" type="button">&#8250;</button>
          </div>
          <div class="ical-dow-row">
            <div class="ical-dow">Lun</div><div class="ical-dow">Mar</div>
            <div class="ical-dow">Mer</div><div class="ical-dow">Gio</div>
            <div class="ical-dow">Ven</div><div class="ical-dow">Sab</div>
            <div class="ical-dow">Dom</div>
          </div>
          <div class="ical-days-grid" id="calDaysGrid"></div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Modal login admin -->
  <div class="modal" id="adminModal" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
    <div class="modal-sheet">
      <div class="modal-head">
        <div class="modal-title" id="adminModalTitle"><i class="fa-solid fa-shield-halved" style="margin-right:6px;color:#f59e0b;"></i>Accesso admin</div>
        <button class="icon-btn" id="closeAdminModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-form">
        <div class="modal-field">
          <label>Password</label>
          <input class="modal-text-input" id="adminPassInput" type="password" placeholder="••••••••" autocomplete="current-password" />
          <div id="adminPassError" style="font-size:12px; color:#f87171; display:none; margin-top:4px;"><i class="fa-solid fa-triangle-exclamation"></i> Password errata.</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary-lg" id="cancelAdminBtn" type="button">Annulla</button>
        <button class="btn-primary-lg" id="confirmAdminBtn" type="button">Accedi</button>
      </div>
    </div>
  </div>

  <!-- Modal collega -->
  <div class="modal" id="colleagueModal" role="dialog" aria-modal="true" aria-labelledby="colleagueModalTitle">
    <div class="modal-sheet modal-sheet-scroll">
      <div class="modal-head">
        <div class="modal-title" id="colleagueModalTitle">Aggiungi collega</div>
        <button class="icon-btn" id="closeColleagueModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-form">
        <div class="modal-field">
          <label>Nome</label>
          <input class="modal-text-input" id="colleagueName" type="text" placeholder="Es. Violetta" autocomplete="off" maxlength="40" />
        </div>
        <div class="modal-field">
          <label>Ruolo</label>
          <div class="segmented" id="cRoleSegment" role="group">
            <button type="button" data-role="dipendente" aria-pressed="false">Dipendente</button>
            <button type="button" data-role="tutor" aria-pressed="false">Tutor</button>
          </div>
        </div>
        <div class="modal-field">
          <label>Team</label>
          <select class="modal-select" id="cTeamSelect">
            <option value="">-- Seleziona --</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Monte ore</label>
          <select class="modal-select" id="cHoursSelect">
            <option value="">-- Seleziona --</option>
            <option value="20h">20h settimanali</option>
            <option value="30h">30h settimanali</option>
            <option value="33h">33h settimanali</option>
            <option value="40h">40h settimanali</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Anno</label>
          <select class="modal-select" id="cYearSelect"></select>
        </div>
        <div class="modal-field">
          <label>Mese di partenza</label>
          <select class="modal-select" id="cMonthSelect"></select>
        </div>
        <div class="modal-field">
          <label>Settimana di partenza</label>
          <select class="modal-select" id="cWeekSelect"></select>
        </div>
        <div class="modal-field">
          <label>Opzione orario</label>
          <select class="modal-select" id="cOptionSelect"></select>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary-lg" id="cancelColleagueBtn" type="button">Annulla</button>
        <button class="btn-primary-lg" id="saveColleagueBtn" type="button">Salva</button>
      </div>
    </div>
  </div>
  <div class="modal" id="optionModal" role="dialog" aria-modal="true" aria-labelledby="optionTitle">
    <div class="modal-sheet">
      <div class="modal-head">
        <div class="modal-title" id="optionTitle" style="font-size:13px;">Seleziona orario e riposi della settimana selezionata</div>
        <button class="icon-btn" id="closeOptionModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-list" id="optionList"></div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div>
      <div style="font-weight:900" id="toastTitle">Ok</div>
      <small id="toastMsg"></small>
    </div>
    <button id="toastClose" type="button">Chiudi</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase 9 compat (app + auth + firestore) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // --------- Micro feedback ---------
    const clickAudio = (() => {
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        return { ctx };
      } catch(e){ return null; }
    })();

    function playClickSound(){
      if(!clickAudio || !clickAudio.ctx) return;
      const ctx = clickAudio.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 420;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.06, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
      o.start(now);
      o.stop(now + 0.1);
    }

    function addRipple(el, x, y){
      const r = document.createElement('span');
      r.className = 'ripple';
      const rect = el.getBoundingClientRect();
      r.style.left = (x - rect.left) + 'px';
      r.style.top = (y - rect.top) + 'px';
      el.appendChild(r);
      setTimeout(() => r.remove(), 650);
    }

    function toast(title, msg){ /* notifiche disabilitate */ }

    

    // --------- Safe storage (no-crash) ---------
    const localStorage = (()=>{
      try{
        const ls = window.localStorage;
        const k = '__matrice_test__';
        ls.setItem(k, '1');
        ls.removeItem(k);
        return ls;
      } catch(e){
        const mem = new Map();
        return {
          getItem: (k)=> mem.has(k) ? mem.get(k) : null,
          setItem: (k,v)=> { mem.set(k, String(v)); },
          removeItem: (k)=> { mem.delete(k); },
        };
      }
    })();

    function safeStorageGet(key){
      try{ return localStorage.getItem(key); } catch(e){ return null; }
    }
    function safeStorageSet(key, value){
      try{ localStorage.setItem(key, String(value)); } catch(e){}
    }
    function safeStorageRemove(key){
      try{ localStorage.removeItem(key); } catch(e){}
    }
// --------- Data ---------
    const BASE_START_ISO = '2026-02-16'; // lunedì: data fissa di partenza della tabella (18 settimane)
    const DAYS = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];

    // Pattern fisso (18 settimane) - ordine del ciclo
    const DIPENDENTE_PATTERN = [
      { startTime: '14:00', restDays: ['Lun','Dom'] },
      { startTime: '06:00', restDays: ['Mer','Sab'] },
      { startTime: '13:30', restDays: ['Ven','Sab'] },
      { startTime: '15:30', restDays: ['Mar','Dom'] },
      { startTime: '09:30', restDays: ['Gio','Dom'] },
      { startTime: '12:00', restDays: ['Sab','Dom'] },
      { startTime: '14:30', restDays: ['Lun','Dom'] },
      { startTime: '08:00', restDays: ['Mer','Sab'] },
      { startTime: '14:00', restDays: ['Ven','Sab'] },
      { startTime: '16:00', restDays: ['Mar','Dom'] },
      { startTime: '09:30', restDays: ['Gio','Dom'] },
      { startTime: '12:30', restDays: ['Sab','Dom'] },
      { startTime: '15:00', restDays: ['Lun','Dom'] },
      { startTime: '08:30', restDays: ['Mer','Sab'] },
      { startTime: '14:30', restDays: ['Ven','Sab'] },
      { startTime: '18:00', restDays: ['Mar','Dom'] },
      { startTime: '10:00', restDays: ['Gio','Dom'] },
      { startTime: '13:00', restDays: ['Sab','Dom'] }
    ];

    // Eccezioni richieste (giorni specifici nella settimana) - indice nel PATTERN (0..17)
    const DIPENDENTE_SPECIAL_START_OVERRIDES = {
      12: { Sab: '18:00' },          // 15:00 (Lun,Dom) -> Sab 18:00
      13: { Dom: '10:00' },          // 08:30 (Mer,Sab) -> Dom 10:00
      14: { Dom: '18:00' },          // 14:30 (Ven,Sab) -> Dom 18:00
      15: { Sab: '12:00' },          // 18:00 (Mar,Dom) -> Sab 12:00
      16: { Sab: '09:00' },          // 10:00 (Gio,Dom) -> Sab 09:00
      0:  { Sab: '14:00' },          // 14:00 (Lun,Dom) -> Sab 14:00 (già uguale, ma esplicito)
      1:  { Dom: '06:00' },          // 06:00 (Mer,Sab) -> Dom 06:00
      2:  { Dom: '14:00' },          // 13:30 (Ven,Sab) -> Dom 14:00
      3:  { Sab: '10:00' },          // 15:30 (Mar,Dom) -> Sab 10:00
      4:  { Sab: '06:00' },          // 09:30 (Gio,Dom) -> Sab 06:00
      6:  { Sab: '16:00' },          // 14:30 (Lun,Dom) -> Sab 16:00
      7:  { Dom: '09:00' },          // 08:00 (Mer,Sab) -> Dom 09:00
      8:  { Dom: '16:00' },          // 14:00 (Ven,Sab) -> Dom 16:00
      9:  { Sab: '11:00' },          // 16:00 (Mar,Dom) -> Sab 11:00
      10: { Sab: '08:00' },          // 09:30 (Gio,Dom) -> Sab 08:00 (seconda occorrenza)
    };

    // Pattern Tutor (15 opzioni) — ciclo ripetuto per riempire 18 settimane
    const TUTOR_PATTERN = [
      { startTime: '12:00', restDays: ['Mer','Sab'], overrides: { Dom: '12:00' } },
      { startTime: '06:00', restDays: ['Mar','Sab'], overrides: { Dom: '06:00' } },
      { startTime: '18:00', restDays: ['Mer','Dom'], overrides: { Sab: '18:00' } },
      { startTime: '15:00', restDays: ['Sab','Dom'] },
      { startTime: '06:00', restDays: ['Gio','Dom'], overrides: { Sab: '06:00' } },
      { startTime: '18:00', restDays: ['Lun','Sab'], overrides: { Dom: '18:00' } },
      { startTime: '12:00', restDays: ['Mar','Dom'], overrides: { Sab: '12:00' } },
      { startTime: '08:00', restDays: ['Sab','Dom'] },
      { startTime: '18:00', restDays: ['Mar','Sab'], overrides: { Dom: '18:00' } },
      { startTime: '12:00', restDays: ['Lun','Sab'], overrides: { Dom: '12:00' } },
      { startTime: '06:00', restDays: ['Mer','Dom'], overrides: { Sab: '06:00' } },
      { startTime: '11:00', restDays: ['Sab','Dom'] },
      { startTime: '12:00', restDays: ['Gio','Dom'], overrides: { Sab: '12:00' } },
      { startTime: '06:00', restDays: ['Lun','Sab'], overrides: { Dom: '06:00' } },
      { startTime: '18:00', restDays: ['Gio','Dom'], overrides: { Sab: '18:00' } },
    ];
    const TOTAL_WEEKS_MAP = { dipendente: 18, tutor: 15 };
    function totalWeeksForRole(role){ return TOTAL_WEEKS_MAP[role] || 18; }

    // Per il tutor: conta le settimane dalla settimana di partenza fino al 31 dic dell'anno selezionato
    function computeTutorWeekCount(startISO){
      const start = parseISODate(startISO);
      const year = start.getFullYear();
      const endOfYear = new Date(year, 11, 31);
      let count = 0;
      let cur = new Date(start.getTime());
      while(cur <= endOfYear){
        count++;
        cur = addDays(cur, 7);
      }
      return Math.max(count, 1);
    }

    // Restituisce il totale settimane in base a ruolo e stato corrente
    // Per entrambi i ruoli: settimane dalla partenza fino al 31 dic dell'anno selezionato
    function computeTotalWeeks(){
      if(state.startWeekISO){
        return computeTutorWeekCount(state.startWeekISO);
      }
      return totalWeeksForRole(state.role);
    }

    // Ruolo attivo (Dipendente/Tutor) — determina pattern e opzioni
    let activeRole = 'dipendente';
    let ACTIVE_PATTERN = DIPENDENTE_PATTERN;
    let ACTIVE_SPECIAL_OVERRIDES = DIPENDENTE_SPECIAL_START_OVERRIDES;

    function setActiveRole(role){
      activeRole = (role === 'tutor') ? 'tutor' : 'dipendente';
      ACTIVE_PATTERN = (activeRole === 'tutor') ? TUTOR_PATTERN : DIPENDENTE_PATTERN;
      ACTIVE_SPECIAL_OVERRIDES = (activeRole === 'tutor') ? {} : DIPENDENTE_SPECIAL_START_OVERRIDES;
    }


    // Durate (minuti) — ore settimanali / 5 giorni lavorativi
    const DURATIONS = {
      '20h': 240,
      '30h': 360,
      '33h': 396,
      '40h': 480,
    };

    function prettyDuration(key){
      const map = { '20h':'20h settimanali', '30h':'30h settimanali', '33h':'33h settimanali', '40h':'40h settimanali' };
      return map[key] || key || '';
    }

    // --------- Rientri in sede ---------
    // Lunedì della prima settimana di rientro nota per ciascun team; ciclo ogni 6 settimane (42 giorni)
    const TEAM_RIENTRO_ANCHORS = {
      3: '2026-03-02',
      6: '2026-02-23',
      7: '2026-02-16',
      8: '2026-02-23',
      9: '2026-03-02',
    };
    // Team 1-2, 4-5: anchor da definire

    function isRientroWeek(weekMondayDate, team){
      const anchorISO = TEAM_RIENTRO_ANCHORS[team];
      if(!anchorISO || !team) return false;
      const anchor = parseISODate(anchorISO);
      const diffDays = Math.round((weekMondayDate.getTime() - anchor.getTime()) / 86400000);
      return (((diffDays % 42) + 42) % 42) === 0;
    }


    // --------- Helpers ---------
    function parseISODate(iso){
      const [y,m,d] = String(iso).split('-').map(Number);
      return new Date(y, (m||1)-1, d||1);
    }
    function pad2(n){return String(n).padStart(2,'0');}
    function isoDate(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
    function addDays(date, days){
      const d = new Date(date.getTime());
      d.setDate(d.getDate()+days);
      return d;
    }
    function timeToMinutes(t){
      const [hh,mm] = String(t).split(':').map(Number);
      return (hh||0)*60 + (mm||0);
    }
    function minutesToTime(m){
      m = ((m%1440)+1440)%1440;
      const hh = Math.floor(m/60);
      const mm = m%60;
      return `${pad2(hh)}:${pad2(mm)}`;
    }
    function addMinutesToTimeStr(t, minutes){
      return minutesToTime(timeToMinutes(t) + minutes);
    }
    function weekLabel(startDate){
      const endDate = addDays(startDate, 6);
      const options = { day: '2-digit', month: 'short' };
      const startStr = startDate.toLocaleDateString('it-IT', options);
      const endStr = endDate.toLocaleDateString('it-IT', options);
      return `${startStr} – ${endStr}`;
    }

    function timeStrToMinutes(t){
      const parts = String(t||'').split(':');
      const h = parseInt(parts[0]||'0', 10);
      const m = parseInt(parts[1]||'0', 10);
      return (h*60) + m;
    }
    function minutesToTimeStr(min){
      min = ((min % 1440) + 1440) % 1440;
      const h = Math.floor(min/60);
      const m = min % 60;
      return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }
    function computeStartEnd(rawStart, durationMinutes){
      // Fine turno massimo: mezzanotte (00:00).
      // Per i turni "18:00" consideriamo la chiusura a mezzanotte e calcoliamo l'inizio in base al monte ore.
      if(!durationMinutes) return { start: rawStart, end: '' };

      const startStr = String(rawStart);
      if(startStr === '18:00'){
        const startMin = 1440 - durationMinutes;
        return { start: minutesToTimeStr(startMin), end: '00:00' };
      }

      const end = addMinutesToTimeStr(startStr, durationMinutes);
      // Se attraversa la mezzanotte, tronca a 00:00
      if(timeStrToMinutes(end) < timeStrToMinutes(startStr)){
        return { start: startStr, end: '00:00' };
      }
      return { start: startStr, end };
    }

    function fmtDayMonth(d){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'][d.getMonth()];
      return `${dd} ${mm}`;
    }
    function restLabel(arr){
      return arr.join(', ');
    }

    // Easter / Easter Monday for a given year (Gregorian)
    function easterDate(year){
      // Anonymous Gregorian algorithm
      const a = year % 19;
      const b = Math.floor(year/100);
      const c = year % 100;
      const d = Math.floor(b/4);
      const e = b % 4;
      const f = Math.floor((b+8)/25);
      const g = Math.floor((b - f + 1)/3);
      const h = (19*a + b - d - g + 15) % 30;
      const i = Math.floor(c/4);
      const k = c % 4;
      const l = (32 + 2*e + 2*i - h - k) % 7;
      const m = Math.floor((a + 11*h + 22*l)/451);
      const month = Math.floor((h + l - 7*m + 114)/31); // 3=March, 4=April
      const day = ((h + l - 7*m + 114) % 31) + 1;
      return new Date(year, month-1, day);
    }

    
function buildHolidayMapForYear(year){
  const map = new Map();
  // Festività nazionali italiane (fisse)
  map.set(`${year}-01-01`, 'Capodanno');
  map.set(`${year}-01-06`, 'Epifania');
  map.set(`${year}-04-25`, 'Liberazione');
  map.set(`${year}-05-01`, 'Festa del Lavoro');
  map.set(`${year}-06-02`, 'Festa della Repubblica');
  map.set(`${year}-08-15`, 'Ferragosto');
  map.set(`${year}-11-01`, 'Ognissanti');
  map.set(`${year}-12-08`, 'Immacolata Concezione');
  map.set(`${year}-12-25`, 'Natale');
  map.set(`${year}-12-26`, 'Santo Stefano');
  map.set(`${year}-05-10`, 'San Cataldo (Patrono)');

  // Pasquetta (Lunedì dell’Angelo)
  const easter = easterDate(year);
  const easterMonday = addDays(easter, 1);
  map.set(isoDate(easterMonday), 'Pasquetta');

  return map;
}

    function getDayStartTime(patternIndex, dayName){
      const len = ACTIVE_PATTERN.length || 1;
      const idx = ((patternIndex % len) + len) % len;
      const entry = ACTIVE_PATTERN[idx];
      const override = ((entry.overrides || {})[dayName]) || ((ACTIVE_SPECIAL_OVERRIDES[idx] || {})[dayName]);
      return override || entry.startTime;
    }

        function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

// --------- State ---------
    const state = {
      role: null, // 'dipendente' | 'tutor'
      durationKey: null,
      durationMinutes: null,
      team: null,                 // numero team (1-9); null = non selezionato
      startMonth: null,           // 0..11 (mese di partenza)
      startWeekISO: null,         // YYYY-MM-DD (lunedì della settimana di partenza)
      anchorPatternIndex: null,   // 0..17 (orario + riposi della settimana di partenza)
      generated: false,
      viewMode: 'table',
      colleghi: [],               // array di {id, name, role, durationKey, durationMinutes, startWeekISO, anchorPatternIndex}
    };

    // --------- Matrix generation ---------
    function buildMatrixData(){
      const baseStart = state.startWeekISO ? parseISODate(state.startWeekISO) : parseISODate(BASE_START_ISO);
      const totalWeeks = computeTotalWeeks();

      // Holidays for years involved in the 18-week window
      const endWindow = addDays(baseStart, (totalWeeks - 1) * 7 + 6);
      const years = new Set();
      for(let y = baseStart.getFullYear(); y <= endWindow.getFullYear(); y++) years.add(y);
      const holidayMaps = {};
      years.forEach(y => holidayMaps[y] = buildHolidayMapForYear(y));

      const weeks = [];
      for (let weekIndex = 0; weekIndex < totalWeeks; weekIndex++){
        const weekStart = addDays(baseStart, weekIndex * 7);

        // La settimana di partenza usa l'opzione scelta; le successive avanzano nel ciclo (18)
        const patternIndex = (state.anchorPatternIndex !== null)
          ? (state.anchorPatternIndex + weekIndex) % ACTIVE_PATTERN.length
          : (weekIndex % ACTIVE_PATTERN.length);

        const pat = ACTIVE_PATTERN[patternIndex];

        const days = [];
        for (let dayIdx = 0; dayIdx < 7; dayIdx++){
          const dayName = DAYS[dayIdx];
          const dateObj = addDays(weekStart, dayIdx);

          const isRest = pat.restDays.includes(dayName);
          const rawStart = getDayStartTime(patternIndex, dayName);
          const se = computeStartEnd(rawStart, state.durationMinutes || 0);
          const start = se.start;
          const end = se.end;

          const y = dateObj.getFullYear();
          const holidayName = holidayMaps[y] ? holidayMaps[y].get(isoDate(dateObj)) : null;
          const isHoliday = !!holidayName;
          const isRientro = isRientroWeek(weekStart, state.team) && dayIdx < 5;

          days.push({ dayName, dateObj, isRest, start, end, isHoliday, holidayName, isRientro });
        }

        const inMonth = (state.startMonth === null)
          ? true
          : days.some(d => d.dateObj.getMonth() === state.startMonth);

        weeks.push({
          weekIndex,
          patternIndex,
          label: weekLabel(weekStart),
          weekStart,
          restDays: pat.restDays.slice(),
          baseStartTime: pat.startTime,
          inMonth,
          days,
        });
      }
      return weeks;
    }

    function renderTable(weeks){
      const wrap = document.getElementById('matrixTableWrap');
      const cols = ['Settimana', ...DAYS];
      const todayISO = isoDate(new Date());

      let html = '<div class="matrix-container"><table class="matrix-table" id="matrixTable"><thead><tr>';
      cols.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';

      weeks.forEach(w => {
        const isRowToday = w.days.some(d => isoDate(d.dateObj) === todayISO);
        html += `<tr class="${w.inMonth ? '' : 'row-dim'}${isRowToday ? ' row-today' : ''}">`;
        html += `<td><span class="week-label"><span class="sr-only">Settimana ${w.weekIndex+1}</span>${w.label}</span></td>`;

        w.days.forEach(d => {
          const isToday = isoDate(d.dateObj) === todayISO;
          let cellHtml = `<div class="cell-stack">`;
          if (d.holidayName){
            cellHtml += `<div class="cell-time time-red"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
            cellHtml += `<div class="holiday-name">${d.holidayName}</div>`;
          } else if (d.isRest){
            cellHtml += `<div class="pill rest">LIBERO</div>`;
          } else {
            cellHtml += `<div class="cell-time"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
          }
          if(d.isRientro) cellHtml += `<div class="cal-rientro">Rientro</div>`;
          cellHtml += `</div>`;
          html += `<td${isToday ? ' class="cell-today"' : ''}>${cellHtml}</td>`;
        });

        html += '</tr>';
      });

      html += '</tbody></table></div>';
      wrap.innerHTML = html;
    }

    function renderCards(weeks){
      const wrap = document.getElementById('matrixCardsWrap');
      if(!wrap) return;
      const todayISO = isoDate(new Date());
      let html = '';
      weeks.forEach((w, idx)=>{
        const isWeekToday = w.days.some(d => isoDate(d.dateObj) === todayISO);
        const open = (idx === 0 || isWeekToday) ? ' open' : '';
        html += `<details class="week-card"${open}>`;
        html += `<summary>`;
        html += `<div class="wc-left"><div class="wc-title">${w.label}</div>`;
        html += `<div class="wc-sub">${w.inMonth ? 'Nel mese selezionato' : 'Fuori filtro mese'}</div></div>`;
        html += `<div class="chev"><i class="fa-solid fa-chevron-down"></i></div>`;
        html += `</summary>`;
        html += `<div class="wc-body">`;
        w.days.forEach(d=>{
          const dateTxt = fmtDayMonth(d.dateObj);
          const isToday = isoDate(d.dateObj) === todayISO;
          let right = '';
          if(d.holidayName){
            right = `<div class="day-time time-red"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div><div class="holiday-name">${escapeHtml(d.holidayName)}</div>`;
          } else if(d.isRest){
            right = `<div class="pill rest">LIBERO</div>`;
          } else {
            right = `<div class="day-time"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
          }
          if(d.isRientro) right += `<div class="cal-rientro">Rientro</div>`;
          html += `<div class="day-row ${w.inMonth ? '' : 'row-dim'}${isToday ? ' day-row-today' : ''}"` +
                  `${isToday ? ' style="outline:2px solid var(--accent);outline-offset:-2px;border-radius:14px;"' : ''}>` +
                  `<div class="day-left"><div class="day-name">${d.dayName}</div><div class="day-date">${dateTxt}</div></div>` +
                  `<div class="day-right">${right}</div>` +
                  `</div>`;
        });
        html += `</div></details>`;
      });
      wrap.innerHTML = html;
    }

    // --------- Render calendario ---------
    function renderCalendar(weeks){
      const wrap = document.getElementById('matrixCalendarWrap');
      if(!wrap) return;

      const todayISO = isoDate(new Date());
      const weekendDowIdx = new Set([5, 6]); // Sab=5, Dom=6 (da Lun=0)

      // Raggruppa i giorni per mese
      const monthMap = new Map();
      weeks.forEach(w => {
        w.days.forEach(d => {
          const key = `${d.dateObj.getFullYear()}-${pad2(d.dateObj.getMonth()+1)}`;
          if(!monthMap.has(key)) monthMap.set(key, []);
          monthMap.get(key).push(d);
        });
      });

      const DOW_LABELS = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];

      // Filtro mese rapido
      let html = '<div class="cal-month-filter" id="calMonthFilterPills">';
      monthMap.forEach((_, key) => {
        const [y, m] = key.split('-').map(Number);
        const short = MONTHS[m-1].substring(0,3);
        html += `<button class="cal-month-pill" data-target="cal-month-${key}" type="button">${short} ${y}</button>`;
      });
      html += '</div>';

      monthMap.forEach((days, key) => {
        const [y, m] = key.split('-').map(Number);
        const monthName = MONTHS[m-1] + ' ' + y;

        const firstOfMonth = new Date(y, m-1, 1);
        const dowFirst = firstOfMonth.getDay();
        const offsetMon = (dowFirst === 0) ? 6 : dowFirst - 1;

        const dayByISO = new Map();
        days.forEach(d => dayByISO.set(isoDate(d.dateObj), d));

        const daysInMonth = new Date(y, m, 0).getDate();

        // Contatore ore mensili
        let workDays = 0;
        for(let day = 1; day <= daysInMonth; day++){
          const iso = isoDate(new Date(y, m-1, day));
          const d = dayByISO.get(iso);
          if(d && !d.isRest && !d.isHoliday) workDays++;
        }
        const totalMins = workDays * (state.durationMinutes || 0);
        const totH = Math.floor(totalMins / 60);
        const totM = totalMins % 60;
        const oreLabel = totalMins > 0 ? `${totH}h${totM ? ' ' + totM + 'm' : ''}` : '—';

        html += `<div class="cal-month" id="cal-month-${key}">`;
        html += `<div class="cal-month-title">${monthName}<span style="float:right;font-size:11px;font-weight:700;opacity:0.65;">${workDays} giorni · ${oreLabel}</span></div>`;
        html += `<div class="cal-grid">`;

        DOW_LABELS.forEach(dl => { html += `<div class="cal-dow">${dl}</div>`; });

        for(let i = 0; i < offsetMon; i++){
          html += `<div class="cal-cell cal-empty"></div>`;
        }

        for(let day = 1; day <= daysInMonth; day++){
          const dateObj = new Date(y, m-1, day);
          const iso = isoDate(dateObj);
          const d = dayByISO.get(iso);
          const isToday = iso === todayISO;
          const dowIdx = (dateObj.getDay() + 6) % 7;
          const isWeekend = weekendDowIdx.has(dowIdx);

          let classes = 'cal-cell';
          if(isToday) classes += ' cal-today';

          let inner = `<div class="cal-day-num">${day}</div>`;

          if(d){
            if(d.isRest){ classes += ' cal-rest'; inner += `<div class="cal-libero">LIBERO</div>`; }
            else if(d.isHoliday){ classes += ' cal-holiday'; inner += `<div class="cal-time time-red">${d.start}</div><div class="cal-time-end">${d.end}</div><div class="cal-hname">${escapeHtml(d.holidayName)}</div>`; }
            else {
              if(isWeekend) classes += ' cal-weekend';
              inner += `<div class="cal-time">${d.start}</div><div class="cal-time-end">${d.end}</div>`;
            }
          } else {
            classes += ' cal-empty';
          }

          if(d && d.isRientro) inner += `<div class="cal-rientro">Rientro</div>`;

          html += `<div class="${classes}">${inner}</div>`;
        }

        const totalCells = offsetMon + daysInMonth;
        const remainder = totalCells % 7;
        if(remainder !== 0){
          for(let i = 0; i < 7 - remainder; i++){
            html += `<div class="cal-cell cal-empty"></div>`;
          }
        }

        html += `</div></div>`;
      });

      wrap.innerHTML = html;

      // Wire month filter pills interactivity
      const pills = wrap.querySelectorAll('.cal-month-pill');
      pills.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.getAttribute('data-target'));
          if(target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          pills.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
      if(pills.length) pills[0].classList.add('active');

      // Auto-activate pill for current month
      const todayKey = todayISO.substring(0,7).replace('-', '-');
      const todayPill = wrap.querySelector(`.cal-month-pill[data-target="cal-month-${todayISO.substring(0,7)}"]`);
      if(todayPill){
        pills.forEach(b => b.classList.remove('active'));
        todayPill.classList.add('active');
      }
    }

    function render(){
      const previewCard = document.getElementById('previewCard');
      if(previewCard) previewCard.style.display = state.generated ? '' : 'none';
      refreshSwapReadiness();
      const previewWrap = document.getElementById('previewWrap');
      const empty = document.getElementById('emptyPreview');
      if(!state.generated){
        previewWrap.classList.remove('is-visible');
        empty.style.display = 'flex';
        const saveBtn = document.getElementById('saveTopBtn');
        if(saveBtn) saveBtn.disabled = true;
        return;
      }

      const weeks = buildMatrixData();
      // Costruisci sempre la tabella (serve anche per export PNG)
      renderTable(weeks);
      // Vista a schede
      renderCards(weeks);
      // Vista calendario
      renderCalendar(weeks);

      const tableWrap = document.getElementById('matrixTableWrap');
      const cardsWrap = document.getElementById('matrixCardsWrap');
      const calWrap = document.getElementById('matrixCalendarWrap');
      const vm = state.viewMode;
      if(tableWrap) tableWrap.style.display = (vm === 'table') ? 'block' : 'none';
      if(cardsWrap) cardsWrap.style.display = (vm === 'cards') ? 'block' : 'none';
      if(calWrap)   calWrap.style.display   = (vm === 'calendar') ? 'block' : 'none';

      previewWrap.classList.add('is-visible');
      empty.style.display = 'none';

      // Abilita il tasto salva dopo la generazione
      const saveBtn = document.getElementById('saveTopBtn');
      if(saveBtn) saveBtn.disabled = false;

      // Aggiorna sottotitolo brand
      const sub = document.getElementById('brandSub');
      if(sub && state.role && state.durationKey){
        const roleLabel = state.role === 'tutor' ? 'Tutor' : 'Dipendente';
        sub.textContent = `${roleLabel} · ${state.durationKey} · ${computeTotalWeeks()} settimane`;
      }
    }

    // --------- Modals & selettori ---------
    const MONTHS = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    const REFERENCE_YEAR = parseISODate(BASE_START_ISO).getFullYear();
    let ALL_WEEKS = [];

    function openModal(id){
      const modal = document.getElementById(id);
      modal.classList.add('is-open');
      document.body.classList.add('modal-open');
    }
    function closeModal(id){
      const modal = document.getElementById(id);
      modal.classList.remove('is-open');
      document.body.classList.remove('modal-open');
    }

    function computeWeeksForYear(year){
      const jan1 = new Date(year, 0, 1);
      const dow = jan1.getDay(); // 0=dom .. 6=sab
      const diffToMonday = (dow === 0) ? -6 : (1 - dow);
      const firstMonday = addDays(jan1, diffToMonday);

      const dec31 = new Date(year, 11, 31);
      const limit = addDays(dec31, 7);

      const arr = [];
      for(let i=0;i<54;i++){
        const ws = addDays(firstMonday, i*7);
        if(ws > limit) break;

        const monthsTouched = new Set();
        for(let d=0; d<7; d++){
          monthsTouched.add(addDays(ws, d).getMonth());
        }
        arr.push({ start: ws, iso: isoDate(ws), label: weekLabel(ws), monthsTouched });
      }
      return arr;
    }

    function weeksForSelectedMonth(){
      if(state.startMonth === null) return [];
      return ALL_WEEKS.filter(w => w.monthsTouched.has(state.startMonth));
    }

    function initMonthModal(){ /* rimossa - ora si usa il calendario inline */ }
    function initWeekModal(){   /* rimossa - ora si usa il calendario inline */ }

    // ===== CALENDARIO INLINE per selezione settimana di partenza =====
    let _icalYear, _icalMonth;

    function _isoMonday(date){
      const d = new Date(date.getTime());
      const dow = d.getDay();
      const diff = (dow === 0) ? -6 : 1 - dow;
      d.setDate(d.getDate() + diff);
      return isoDate(d);
    }

    function renderInlineCal(){
      const grid   = document.getElementById('calDaysGrid');
      const label  = document.getElementById('calMonthLabel');
      if(!grid) return;

      label.textContent = MONTHS[_icalMonth] + ' ' + _icalYear;
      grid.innerHTML = '';

      const todayIso   = isoDate(new Date());
      const selMonday  = state.startWeekISO;
      const selStart   = selMonday ? parseISODate(selMonday) : null;
      const selEndDate = selStart  ? addDays(selStart, 6)    : null;
      const selEndIso  = selEndDate ? isoDate(selEndDate) : null;

      // Giorno della settimana del 1° del mese (0=Lun..6=Dom)
      const firstDow = (()=>{ const fd = new Date(_icalYear, _icalMonth, 1).getDay(); return fd === 0 ? 6 : fd - 1; })();
      const daysInPrev = new Date(_icalYear, _icalMonth, 0).getDate();
      const daysInCur  = new Date(_icalYear, _icalMonth + 1, 0).getDate();

      const makeDay = (num, dateObj, extraClass) => {
        const iso = isoDate(dateObj);
        const el  = document.createElement('div');
        el.className = 'ical-day';
        el.textContent = num;
        if(extraClass) el.classList.add('other-month');
        if(iso === todayIso) el.classList.add('today');
        if(selStart && selEndDate){
          const d = dateObj;
          if(d >= selStart && d <= selEndDate){
            if(iso === isoDate(selStart)) el.classList.add('sel-week','sel-week-start');
            else if(iso === selEndIso)    el.classList.add('sel-week','sel-week-end');
            else                          el.classList.add('sel-week','sel-week-mid');
          }
        }
        el.addEventListener('click', ()=>{
          const monday = _isoMonday(dateObj);
          state.startWeekISO = monday;
          state.startMonth   = parseISODate(monday).getMonth();
          localStorage.setItem('startWeekISO', monday);
          localStorage.setItem('startMonth', String(state.startMonth));
          const wl = weekLabel(parseISODate(monday));
          const calLbl = document.getElementById('calSelLabel');
          if(calLbl) calLbl.textContent = wl;
          const dlg = document.getElementById('weekCalModal');
          if(dlg) dlg.close();
          updateRefLabels();
          renderInlineCal();
          advanceWizard();
          fbSave();
        });
        return el;
      };

      for(let i = firstDow - 1; i >= 0; i--)
        grid.appendChild(makeDay(daysInPrev - i, new Date(_icalYear, _icalMonth - 1, daysInPrev - i), true));
      for(let d = 1; d <= daysInCur; d++)
        grid.appendChild(makeDay(d, new Date(_icalYear, _icalMonth, d), false));
      const filled = grid.children.length;
      const remaining = (Math.ceil(filled / 7) * 7) - filled;
      for(let d = 1; d <= remaining; d++)
        grid.appendChild(makeDay(d, new Date(_icalYear, _icalMonth + 1, d), true));
    }

    function initInlineCal(){
      const now = new Date();
      _icalYear  = state.startWeekISO ? parseISODate(state.startWeekISO).getFullYear() : now.getFullYear();
      _icalMonth = state.startWeekISO ? parseISODate(state.startWeekISO).getMonth()    : now.getMonth();

      const dlg = document.getElementById('weekCalModal');

      document.getElementById('calPrev').addEventListener('click', ()=>{
        _icalMonth--; if(_icalMonth < 0){ _icalMonth = 11; _icalYear--; }
        renderInlineCal();
      });
      document.getElementById('calNext').addEventListener('click', ()=>{
        _icalMonth++; if(_icalMonth > 11){ _icalMonth = 0; _icalYear++; }
        renderInlineCal();
      });

      // Apri il dialogo al click del pulsante
      const pickerBtn = document.getElementById('weekPickerBtn');
      if(pickerBtn){
        pickerBtn.addEventListener('click', ()=>{
          if(state.startWeekISO){
            const d = parseISODate(state.startWeekISO);
            _icalYear  = d.getFullYear();
            _icalMonth = d.getMonth();
          } else {
            _icalYear  = now.getFullYear();
            _icalMonth = now.getMonth();
          }
          renderInlineCal();
          if(dlg) dlg.showModal();
        });
      }

      // Chiudi col pulsante X
      const closeBtn = document.getElementById('closeWeekCalModal');
      if(closeBtn) closeBtn.addEventListener('click', ()=>{ if(dlg) dlg.close(); });

      // Chiudi cliccando sul backdrop (click fuori dal dialog sheet)
      if(dlg){
        dlg.addEventListener('click', e=>{
          const rect = dlg.querySelector('.modal-sheet').getBoundingClientRect();
          if(e.clientX < rect.left || e.clientX > rect.right ||
             e.clientY < rect.top  || e.clientY > rect.bottom){
            dlg.close();
          }
        });
      }

      // Edit settimana
      const weekEditBtn = document.getElementById('step-week-edit');
      if(weekEditBtn) weekEditBtn.addEventListener('click', ()=>{ stepOpen('week'); });

      // Imposta etichetta se già selezionata
      if(state.startWeekISO){
        const lbl = document.getElementById('calSelLabel');
        if(lbl) lbl.textContent = weekLabel(parseISODate(state.startWeekISO));
      }
    }
    // ===== FINE CALENDARIO INLINE =====

    function optionText(entry){
      return `${entry.startTime} — ${restLabel(entry.restDays)}`;
    }

    function initOptionModal(){
      const list = document.getElementById('optionList');
      list.innerHTML='';
      ACTIVE_PATTERN.forEach((entry, idx)=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='modal-item';
        b.innerHTML = `${optionText(entry)}`;
        b.setAttribute('aria-current', state.anchorPatternIndex === idx ? 'true' : 'false');
        b.addEventListener('click', ()=>{
          state.anchorPatternIndex = idx;
          localStorage.setItem('anchorPatternIndex', String(state.anchorPatternIndex));
          updateRefLabels();
          closeModal('optionModal');
          advanceWizard();
        });
        list.appendChild(b);
      });
    }

    function updateRefButtonsEnabled(){
      const enabled = !!state.role && !!state.durationMinutes;
      document.getElementById('optionBtn').disabled = !enabled || !state.startWeekISO;
    }

    function updateRefLabels(){
      // Opzione
      const oLabel = document.getElementById('optionLabel');
      if(state.anchorPatternIndex !== null){
        oLabel.textContent = optionText(ACTIVE_PATTERN[state.anchorPatternIndex]);
      } else {
        oLabel.textContent = 'Seleziona orario';
      }

      const hintRow = document.getElementById('refHintRow');
      if(hintRow) hintRow.style.display = 'none';

      initOptionModal();
      updateRefButtonsEnabled();
      updateGenerateEnabled();
    }
    // --------- Hours ---------
    function updateGenerateEnabled(){
      const ok = !!state.role && !!state.durationMinutes && !!state.startWeekISO && state.anchorPatternIndex !== null;
      document.getElementById('generateBtn').disabled = !ok;
    }

    // ===== FIREBASE =====
    // ► STEP 1: incolla qui il tuo firebaseConfig copiato dalla console Firebase
    const FIREBASE_CONFIG = {
      apiKey:            'AIzaSyBEeNgqLl8hLhxSMvZxHXoxvw9TDYlaOiw',
      authDomain:        'amatriciana-199a1.firebaseapp.com',
      projectId:         'amatriciana-199a1',
      storageBucket:     'amatriciana-199a1.firebasestorage.app',
      messagingSenderId: '1013648015559',
      appId:             '1:1013648015559:web:bc4ffffb103ebac7eafee2'
    };
    // ► STEP 2: email dell'utente Firebase Authentication
    const FIREBASE_EMAIL = 'vitoblackpoint@gmail.com';
    // ► STEP 3: la password Firebase deve coincidere con ADMIN_PASS qui sotto

    let _fbApp = null, _fbAuth = null, _fbDb = null, _fbReady = false;
    let _fbInitPromise = Promise.resolve(); // risolve appena Firebase è pronto
    let _adminPass = ''; // caricata da /api/auth-config
    const _FB_DOC = 'userdata/main'; // unico documento Firestore

    function _fbConfigured(){
      return FIREBASE_CONFIG.apiKey && !FIREBASE_CONFIG.apiKey.startsWith('INSERISCI');
    }

    function initFirebase(){
      if(!_fbConfigured()) return (_fbInitPromise = Promise.resolve());
      try{
        _fbApp  = firebase.initializeApp(FIREBASE_CONFIG);
        _fbAuth = firebase.auth(_fbApp);
        _fbDb   = firebase.firestore(_fbApp);
      } catch(e){ console.warn('[FB] init error:', e); return (_fbInitPromise = Promise.resolve()); }

      // Carica la password da /api/auth-config, poi fa il sign-in
      _fbInitPromise = fetch('/api/auth-config')
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(cfg => {
          _adminPass = cfg.password || '';
          return _fbAuth.signInWithEmailAndPassword(cfg.email || FIREBASE_EMAIL, _adminPass);
        })
        .then(() => { _fbReady = true; })
        .catch(err => console.warn('[FB] auth error (app funziona lo stesso con localStorage):', err && err.message ? err.message : err));
      return _fbInitPromise;
    }

    // Salva TUTTO su Firestore (colleghi + config matrice)
    function fbSave(){
      if(!_fbReady) return;
      const doc = {
        colleghi: state.colleghi,
        config: {
          role:               state.role,
          durationKey:        state.durationKey,
          durationMinutes:    state.durationMinutes,
          startWeekISO:       state.startWeekISO,
          anchorPatternIndex: state.anchorPatternIndex,
          startMonth:         state.startMonth,
          generated:          state.generated
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      _fbDb.doc(_FB_DOC).set(doc).catch(e => console.warn('[FB] save error:', e));
    }

    // Carica da Firestore attendendo il sign-in; returns Promise<data|null>
    function fbLoad(){
      return _fbInitPromise.then(() => {
        if(!_fbReady) return null;
        return _fbDb.doc(_FB_DOC).get()
          .then(snap => snap.exists ? snap.data() : null)
          .catch(e => { console.warn('[FB] load error:', e); return null; });
      });
    }
    // ===== FINE FIREBASE =====

    // ===== ADMIN =====
    // La password admin è caricata da /api/auth-config a runtime.
    // La variabile _adminPass viene impostata da initFirebase().
    // Per il login offline (locale) usa la stessa password Firebase.

    function isAdminSession(){
      try{ return sessionStorage.getItem('adminSession') === '1'; } catch(e){ return false; }
    }
    function setAdminSession(v){
      try{ if(v) sessionStorage.setItem('adminSession','1'); else sessionStorage.removeItem('adminSession'); } catch(e){}
    }

    function updateAdminUI(){
      const isAdmin = isAdminSession();
      // Lock button (in topbar)
      const lockBtn = document.getElementById('adminLockBtn');
      if(lockBtn){
        lockBtn.className = 'icon-btn ' + (isAdmin ? 'unlocked' : 'locked');
        lockBtn.title = isAdmin ? 'Esci da admin' : 'Accedi come admin';
        lockBtn.querySelector('i').className = isAdmin ? 'fa-solid fa-unlock' : 'fa-solid fa-lock';
      }
      // Topbar admin label
      const lbl = document.getElementById('adminLabel');
      if(lbl) lbl.textContent = isAdmin ? 'Admin ✓' : 'Admin';
      // Add button
      const addBtn = document.getElementById('addColleagueBtn');
      if(addBtn) addBtn.style.display = isAdmin ? '' : 'none';
      // Orario colleghi toggle (brand area)
      const orarioCtrl = document.getElementById('orarioColleghiCtrl');
      if(orarioCtrl) orarioCtrl.style.display = isAdmin ? '' : 'none';
      // Cerca orario toggle (brand area)
      const cercaCtrl = document.getElementById('cercaOrarioCtrl');
      if(cercaCtrl) cercaCtrl.style.display = isAdmin ? '' : 'none';
      // Admin-only cards — NON auto-mostrate, solo via pulsanti
      const swapC = document.getElementById('swapCard');
      const findC = document.getElementById('findColleagueCard');
      const teamC = document.getElementById('teamCard');
      const srchC = document.getElementById('searchDateCard');
      if(!isAdmin && swapC) swapC.style.display = 'none';
      if(!isAdmin && findC) findC.style.display = 'none';
      if(!isAdmin && teamC) teamC.style.display = 'none';
      if(!isAdmin && srchC) srchC.style.display = 'none';
      // Re-render team list per mostrare/nascondere edit+delete
      renderTeamList();
    }

    function bindAdminModal(){
      const modal = document.getElementById('adminModal');
      document.getElementById('closeAdminModal').addEventListener('click', ()=>closeModal('adminModal'));
      document.getElementById('cancelAdminBtn').addEventListener('click', ()=>closeModal('adminModal'));
      modal.addEventListener('click', e=>{ if(e.target.id==='adminModal') closeModal('adminModal'); });

      const passInput = document.getElementById('adminPassInput');
      const errEl = document.getElementById('adminPassError');

      document.getElementById('confirmAdminBtn').addEventListener('click', ()=>{
        if(!_adminPass){
          errEl.textContent = 'Credenziali non ancora caricate, riprova tra un secondo.';
          errEl.style.display = 'block'; return;
        }
        if(passInput.value === _adminPass){
          setAdminSession(true);
          errEl.style.display = 'none';
          passInput.value = '';
          closeModal('adminModal');
          updateAdminUI();
        } else {
          errEl.style.display = 'block';
          passInput.focus();
        }
      });
      passInput.addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('confirmAdminBtn').click(); });

      document.getElementById('cercaOrarioBtn').addEventListener('click', ()=>{
        const swapC = document.getElementById('swapCard');
        const findC = document.getElementById('findColleagueCard');
        const srchC = document.getElementById('searchDateCard');
        const btn   = document.getElementById('cercaOrarioBtn');
        const cards = [swapC, findC, srchC].filter(Boolean);
        const visible = cards.some(c => c.style.display !== 'none');
        cards.forEach(c => c.style.display = visible ? 'none' : '');
        if(btn) btn.classList.toggle('active', !visible);
      });

      document.getElementById('orarioColleghiBtn').addEventListener('click', ()=>{
        const teamC = document.getElementById('teamCard');
        const btn   = document.getElementById('orarioColleghiBtn');
        if(!teamC) return;
        const visible = teamC.style.display !== 'none';
        teamC.style.display = visible ? 'none' : '';
        if(btn) btn.classList.toggle('active', !visible);
      });

      document.getElementById('adminLockBtn').addEventListener('click', ()=>{
        if(isAdminSession()){
          setAdminSession(false);
          updateAdminUI();
        } else {
          document.getElementById('adminPassError').style.display = 'none';
          document.getElementById('adminPassInput').value = '';
          openModal('adminModal');
          setTimeout(()=>document.getElementById('adminPassInput').focus(), 80);
        }
      });
    }
    // ===== FINE ADMIN =====

    // ===== TEAM & CERCA PER DATA =====

    // Costruisce la matrice per un config arbitrario (non usa state globale)
    function buildMatrixDataForConfig(cfg){
      const pattern = cfg.role === 'tutor' ? TUTOR_PATTERN : DIPENDENTE_PATTERN;
      const specialOvr = cfg.role === 'tutor' ? {} : DIPENDENTE_SPECIAL_START_OVERRIDES;
      const baseStart = parseISODate(cfg.startWeekISO);
      const totalWeeks = computeTutorWeekCount(cfg.startWeekISO);
      const endWindow = addDays(baseStart, (totalWeeks - 1) * 7 + 6);
      const years = new Set();
      for(let y = baseStart.getFullYear(); y <= endWindow.getFullYear(); y++) years.add(y);
      const hMaps = {};
      years.forEach(y => hMaps[y] = buildHolidayMapForYear(y));
      const anchor = cfg.anchorPatternIndex !== null ? cfg.anchorPatternIndex : 0;
      const weeks = [];
      for(let wi = 0; wi < totalWeeks; wi++){
        const weekStart = addDays(baseStart, wi * 7);
        const pIdx = (anchor + wi) % pattern.length;
        const pat = pattern[pIdx];
        const days = [];
        for(let di = 0; di < 7; di++){
          const dayName = DAYS[di];
          const dateObj = addDays(weekStart, di);
          const isRest = pat.restDays.includes(dayName);
          const entry = pattern[pIdx];
          const rawStart = ((entry.overrides || {})[dayName]) || ((specialOvr[pIdx] || {})[dayName]) || entry.startTime;
          const se = computeStartEnd(rawStart, cfg.durationMinutes || 0);
          const y = dateObj.getFullYear();
          const holidayName = hMaps[y] ? hMaps[y].get(isoDate(dateObj)) : null;
          const isRientro = isRientroWeek(weekStart, cfg.team || null) && di < 5;
          days.push({ dayName, dateObj, isRest, start: se.start, end: se.end, isHoliday: !!holidayName, holidayName, isRientro });
        }
        weeks.push({ weekIndex: wi, patternIndex: pIdx, weekStart, days });
      }
      return weeks;
    }

    // Ritorna il giorno specifico nella matrice di un collega (o null se fuori range)
    function getScheduleOnDate(cfg, targetISO){
      if(!cfg || !cfg.startWeekISO || cfg.anchorPatternIndex === null) return null;
      const weeks = buildMatrixDataForConfig(cfg);
      for(const w of weeks){
        for(const d of w.days){
          if(isoDate(d.dateObj) === targetISO) return d;
        }
      }
      return null;
    }

    // Salva colleghi su localStorage e Firestore
    function saveColleghi(){
      safeStorageSet('colleghi', JSON.stringify(state.colleghi));
      fbSave();
    }

    // Renderizza la lista team
    function renderTeamList(){
      const list = document.getElementById('teamList');
      const empty = document.getElementById('teamEmpty');
      if(!list) return;
      const isAdmin = isAdminSession();
      Array.from(list.children).forEach(c => { if(c.id !== 'teamEmpty') c.remove(); });

      if(!state.colleghi.length){
        if(empty) empty.style.display = '';
        refreshSwapReadiness();
        return;
      }
      if(empty) empty.style.display = 'none';

      // Raggruppa per ruolo + team
      const groups = new Map();
      state.colleghi.forEach(c => {
        const roleKey = c.role || 'dipendente';
        const key = c.team ? `${roleKey}_${c.team}` : '__nessun_team';
        if(!groups.has(key)) groups.set(key, { role: roleKey, team: c.team || null, members: [] });
        groups.get(key).members.push(c);
      });

      // Ordine: dipendenti team 1→6, tutor team 7→9, senza team
      const sortedKeys = [...groups.keys()].sort((a, b) => {
        if(a === '__nessun_team') return 1;
        if(b === '__nessun_team') return -1;
        const gA = groups.get(a), gB = groups.get(b);
        const roleOrder = { dipendente: 0, tutor: 1 };
        const ro = (roleOrder[gA.role]||0) - (roleOrder[gB.role]||0);
        if(ro !== 0) return ro;
        return (gA.team||99) - (gB.team||99);
      });

      sortedKeys.forEach(key => {
        const { role, team, members } = groups.get(key);
        const roleLabel = role === 'tutor' ? 'Tutor' : 'Dipendente';
        const groupLabel = key === '__nessun_team' ? 'Senza team' : `Team ${team} — ${roleLabel}`;

        const details = document.createElement('details');
        details.style.cssText = 'border-radius:10px; border:1px solid #e2e8f0; overflow:hidden; margin-bottom:6px;';
        details.open = true;

        const summary = document.createElement('summary');
        summary.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:9px 12px; font-size:12px; font-weight:900; cursor:pointer; user-select:none; background:var(--ctrl-bg); list-style:none; gap:8px;';
        summary.innerHTML = `<span>${escapeHtml(groupLabel)}</span><span style="background:#e2e8f0;color:#64748b;border-radius:999px;font-size:11px;font-weight:700;padding:1px 8px;">${members.length}</span>`;
        details.appendChild(summary);

        const body = document.createElement('div');
        members.forEach(c => {
          const initial = (c.name || '?').charAt(0).toUpperCase();
          const metaParts = [
            c.role === 'tutor' ? 'Tutor' : 'Dipendente',
            c.team ? `Team ${c.team}` : '',
            c.durationKey || '',
            c.startWeekISO ? `dal ${c.startWeekISO}` : ''
          ].filter(Boolean);

          const row = document.createElement('div');
          row.className = 'colleague-row';
          row.innerHTML = `
            <div class="colleague-avatar">${initial}</div>
            <div class="colleague-info" style="cursor:pointer;flex:1;min-width:0;">
              <div class="colleague-name">${escapeHtml(c.name)}</div>
              <div class="colleague-meta">${metaParts.join(' · ')}</div>
            </div>
            <div style="display:flex;align-items:center;gap:4px;">
              <button class="btn-icon-sm view" title="Vedi matrice" data-id="${c.id}"><i class="fa-solid fa-eye"></i></button>
              <div class="colleague-actions" ${isAdmin ? '' : 'style="display:none"'}>
                <button class="btn-icon-sm edit" title="Modifica" data-id="${c.id}"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon-sm del" title="Elimina" data-id="${c.id}"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>`;

          row.querySelector('.view').addEventListener('click', () => openColleagueMatrix(c));
          row.querySelector('.colleague-info').addEventListener('click', () => openColleagueMatrix(c));
          if(isAdmin){
            row.querySelector('.edit').addEventListener('click', () => openColleagueModal(c.id));
            row.querySelector('.del').addEventListener('click', () => {
              state.colleghi = state.colleghi.filter(x => x.id !== c.id);
              saveColleghi();
              renderTeamList();
            });
          }
          body.appendChild(row);
        });

        details.appendChild(body);
        list.appendChild(details);
      });
      refreshSwapReadiness();
    }

    // ===== MATRICE COLLEGA =====
    let _viewedColleague = null;
    let _colleagueViewMode = 'calendar'; // 'calendar' | 'cards' | 'table'

    function renderColleagueBody(){
      const body = document.getElementById('colleagueMatrixBody');
      if(!body || !_viewedColleague) return;
      body.innerHTML = '';
      if(_colleagueViewMode === 'table'){
        body.appendChild(buildTableViewForCfg(_viewedColleague));
      } else if(_colleagueViewMode === 'cards'){
        body.appendChild(buildCardsViewForCfg(_viewedColleague));
      } else {
        const node = buildCalendarExportNodeForCfg(_viewedColleague);
        // Fit within modal: inherit width, remove fixed 700px
        node.style.width = '100%';
        node.style.padding = '0';
        body.appendChild(node);
      }
    }

    function buildCardsViewForCfg(cfg){
      const weeks = buildMatrixDataForConfig(cfg);
      const todayISO = isoDate(new Date());
      const wrap = document.createElement('div');
      wrap.className = 'cards-wrap';
      wrap.style.display = 'block';
      weeks.forEach((w, idx) => {
        const isWeekToday = w.days.some(d => isoDate(d.dateObj) === todayISO);
        const det = document.createElement('details');
        det.className = 'week-card';
        if(idx === 0 || isWeekToday) det.open = true;
        const label = weekLabel(w.weekStart);
        const summ = document.createElement('summary');
        summ.innerHTML = `<div class="wc-left"><div class="wc-title">${label}</div></div><div class="chev"><i class="fa-solid fa-chevron-down"></i></div>`;
        det.appendChild(summ);
        const body = document.createElement('div');
        body.className = 'wc-body';
        w.days.forEach(d => {
          const dateTxt = fmtDayMonth(d.dateObj);
          const isToday = isoDate(d.dateObj) === todayISO;
          let rightHTML = '';
          if(d.holidayName){
            rightHTML = `<div class="day-time time-red"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div><div class="holiday-name">${escapeHtml(d.holidayName)}</div>`;
          } else if(d.isRest){
            rightHTML = `<div class="pill rest">LIBERO</div>`;
          } else {
            rightHTML = `<div class="day-time"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
          }
          if(d.isRientro) rightHTML += `<div class="cal-rientro">Rientro</div>`;
          const row = document.createElement('div');
          row.className = `day-row${isToday ? ' day-row-today' : ''}`;
          if(isToday) row.style.cssText = 'outline:2px solid var(--accent);outline-offset:-2px;border-radius:14px;';
          row.innerHTML = `<div class="day-left"><div class="day-name">${d.dayName}</div><div class="day-date">${dateTxt}</div></div><div class="day-right">${rightHTML}</div>`;
          body.appendChild(row);
        });
        det.appendChild(body);
        wrap.appendChild(det);
      });
      return wrap;
    }

    function openColleagueMatrix(c){
      if(!c || !c.startWeekISO || c.anchorPatternIndex === null) {
        toast('Configurazione incompleta', 'Questo collega non ha una matrice configurata.'); return;
      }
      _viewedColleague = c;
      const title = document.getElementById('colleagueMatrixTitle');
      if(title) title.textContent = `Matrice di ${c.name}`;
      renderColleagueBody();
      openModal('colleagueMatrixModal');
    }

    function buildTableViewForCfg(cfg){
      const weeks    = buildMatrixDataForConfig(cfg);
      const todayISO = isoDate(new Date());
      const cols = ['Settimana', ...DAYS];

      let html = '<div class="matrix-container" style="overflow-x:auto;"><table class="matrix-table"><thead><tr>';
      cols.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';

      weeks.forEach(w => {
        const isRowToday = w.days.some(d => isoDate(d.dateObj) === todayISO);
        html += `<tr class="${isRowToday ? 'row-today' : ''}">`;
        html += `<td><span class="week-label">${weekLabel(w.weekStart)}</span></td>`;
        w.days.forEach(d => {
          const isToday = isoDate(d.dateObj) === todayISO;
          let cellHtml = `<div class="cell-stack">`;
          if(d.holidayName){
            cellHtml += `<div class="cell-time time-red"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
            cellHtml += `<div class="holiday-name">${d.holidayName}</div>`;
          } else if(d.isRest){
            cellHtml += `<div class="pill rest">LIBERO</div>`;
          } else {
            cellHtml += `<div class="cell-time"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
          }
          if(d.isRientro) cellHtml += `<div class="cal-rientro">Rientro</div>`;
          cellHtml += `</div>`;
          html += `<td${isToday ? ' class="cell-today"' : ''}>${cellHtml}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table></div>';
      const wrap = document.createElement('div');
      wrap.innerHTML = html;
      return wrap;
    }

    function buildCalendarExportNodeForCfg(cfg){
      // Exact pixel-match to the on-screen .cal-* CSS classes
      const S = {
        cell:    'position:relative; min-height:80px; padding:5px 4px; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0; display:flex; flex-direction:column; gap:2px; background:#fff;',
        cellEnd: 'position:relative; min-height:80px; padding:5px 4px; border-right:0;              border-bottom:1px solid #e2e8f0; display:flex; flex-direction:column; gap:2px; background:#fff;',
        empty:   'background:rgba(0,0,0,0.015);',
        rest:    'background:rgba(239,68,68,0.04);',
        holiday: 'background:rgba(239,68,68,0.07);',
        dayNum:  'font-size:13px; font-weight:900; color:#94a3b8; line-height:1; margin-bottom:2px;',
        dayToday:'font-size:13px; font-weight:900; color:#5c9bff;  line-height:1; margin-bottom:2px;',
        time:    'font-size:15px; font-weight:900; color:#1e293b; line-height:1.15;',
        timeEnd: 'font-size:14px; font-weight:700; color:#64748b;',
        timeRed: 'font-size:15px; font-weight:900; color:#ef4444; line-height:1.15;',
        timeEndRed:'font-size:14px; font-weight:700; color:#ef4444;',
        libero:  'font-size:14px; font-weight:900; color:#ef4444; letter-spacing:0.2px;',
        hname:   'font-size:12px; font-weight:900; color:#ef4444; line-height:1.2; word-break:break-word;',
        dow:     'text-align:center; font-size:11px; font-weight:900; color:#64748b; padding:8px 3px; border-right:1px solid #e2e8f0; border-bottom:1px solid #e2e8f0; background:rgba(255,255,255,0.18); letter-spacing:0.4px;',
        dowEnd:  'text-align:center; font-size:11px; font-weight:900; color:#64748b; padding:8px 3px; border-right:0;                border-bottom:1px solid #e2e8f0; background:rgba(255,255,255,0.18); letter-spacing:0.4px;',
      };
      const weeks    = buildMatrixDataForConfig(cfg);
      const todayISO = isoDate(new Date());
      const DOW_LABELS = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];
      const monthMap  = new Map();
      weeks.forEach(w => w.days.forEach(d => {
        const key = `${d.dateObj.getFullYear()}-${pad2(d.dateObj.getMonth()+1)}`;
        if(!monthMap.has(key)) monthMap.set(key, []);
        monthMap.get(key).push(d);
      }));
      const container = document.createElement('div');
      container.style.cssText = 'background:#f1f5f9; font-family:system-ui,-apple-system,sans-serif; display:flex; flex-direction:column; gap:14px; padding:12px; width:700px; box-sizing:border-box;';
      monthMap.forEach((days, key) => {
        const [y, m] = key.split('-').map(Number);
        const monthName = MONTHS[m-1] + ' ' + y;
        const firstOfMonth = new Date(y, m-1, 1);
        const offsetMon = (d => d===0?6:d-1)(firstOfMonth.getDay());
        const dayByISO = new Map();
        days.forEach(d => dayByISO.set(isoDate(d.dateObj), d));
        const daysInMonth = new Date(y, m, 0).getDate();
        let workDays = 0;
        for(let day=1;day<=daysInMonth;day++){
          const d = dayByISO.get(isoDate(new Date(y,m-1,day)));
          if(d && !d.isRest && !d.isHoliday) workDays++;
        }
        const totalMins = workDays * (cfg.durationMinutes || 0);
        const totH = Math.floor(totalMins/60), totM = totalMins%60;
        const oreLabel = totalMins>0 ? `${totH}h${totM?' '+totM+'m':''}` : '—';

        // Card wrapper
        const card = document.createElement('div');
        card.style.cssText = 'border:1px solid #e2e8f0; border-radius:16px; overflow:hidden; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08);';

        // Month title bar
        const titleEl = document.createElement('div');
        titleEl.style.cssText = 'font-weight:900; font-size:14px; letter-spacing:-0.2px; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(90deg,rgba(92,155,255,0.12),rgba(123,97,255,0.08)); border-bottom:1px solid #e2e8f0;';
        titleEl.innerHTML = `<span style="color:#1e293b">${monthName}</span><span style="font-size:11px;font-weight:700;opacity:0.65;color:#1e293b;">${workDays} giorni · ${oreLabel}</span>`;
        card.appendChild(titleEl);

        // Grid
        const grid = document.createElement('div');
        grid.style.cssText = 'display:grid; grid-template-columns:repeat(7,1fr); border-top:1px solid #e2e8f0;';

        // Day-of-week headers
        DOW_LABELS.forEach((dl, i) => {
          const h = document.createElement('div');
          h.style.cssText = i<6 ? S.dow : S.dowEnd;
          h.textContent = dl; grid.appendChild(h);
        });

        const mk = (isLast, bgExtra) => {
          const e = document.createElement('div');
          e.style.cssText = (isLast ? S.cellEnd : S.cell) + bgExtra;
          return e;
        };

        // Empty cells before 1st
        for(let i=0;i<offsetMon;i++){
          const isLast=(i%7)===6;
          grid.appendChild(mk(isLast, S.empty));
        }

        // Day cells
        for(let day=1;day<=daysInMonth;day++){
          const dateObj = new Date(y,m-1,day);
          const iso = isoDate(dateObj);
          const d = dayByISO.get(iso);
          const isToday = iso===todayISO;
          const isLast = ((offsetMon+day-1)%7)===6;
          const bgExtra = d ? (d.isRest ? S.rest : d.isHoliday ? S.holiday : '') : S.empty;
          const cell = mk(isLast, bgExtra);

          const num = document.createElement('div');
          num.style.cssText = isToday ? S.dayToday : S.dayNum;
          num.textContent = day; cell.appendChild(num);

          if(d){
            if(d.isRest){
              const lib=document.createElement('div'); lib.style.cssText=S.libero; lib.textContent='LIBERO'; cell.appendChild(lib);
            } else if(d.isHoliday){
              const t=document.createElement('div'); t.style.cssText=S.timeRed; t.textContent=d.start; cell.appendChild(t);
              const te=document.createElement('div'); te.style.cssText=S.timeEndRed; te.textContent=d.end; cell.appendChild(te);
              const hn=document.createElement('div'); hn.style.cssText=S.hname; hn.textContent=d.holidayName; cell.appendChild(hn);
            } else {
              const t=document.createElement('div'); t.style.cssText=S.time; t.textContent=d.start; cell.appendChild(t);
              const te=document.createElement('div'); te.style.cssText=S.timeEnd; te.textContent=d.end; cell.appendChild(te);
            }
          }
          if(d && d.isRientro){
            const r=document.createElement('div');
            r.style.cssText='position:absolute;top:3px;right:4px;font-size:8px;font-weight:900;color:#d97706;letter-spacing:0.06em;text-transform:uppercase;line-height:1;pointer-events:none;';
            r.textContent='Rientro';
            cell.appendChild(r);
          }
          grid.appendChild(cell);
        }

        // Trailing empty cells
        const rem=(offsetMon+daysInMonth)%7;
        if(rem!==0) for(let i=0;i<7-rem;i++){
          const isLast=((offsetMon+daysInMonth+i)%7)===6;
          grid.appendChild(mk(isLast, S.empty));
        }

        card.appendChild(grid);
        container.appendChild(card);
      });
      return container;
    }

    async function saveColleaguePng(){
      if(!_viewedColleague){ return; }
      const btn = document.getElementById('saveCollegueMatrixBtn');
      if(btn){ const i=btn.querySelector('i'); if(i) i.className='fa-solid fa-spinner fa-spin'; }
      try{
        const node = buildCalendarExportNodeForCfg(_viewedColleague);
        node.style.position = 'fixed'; node.style.left = '-99999px'; node.style.top = '0';
        document.body.appendChild(node);
        const canvas = await html2canvas(node, { backgroundColor:'#ffffff', scale: Math.min(3, window.devicePixelRatio ? window.devicePixelRatio*2 : 2), useCORS:true, logging:false, scrollX:0, scrollY:0 });
        node.remove();
        const blob = canvasToPdfBlob(canvas);
        const safeName = (_viewedColleague.name||'collega').toLowerCase().replace(/\s+/g,'-');
        _downloadBlob(blob, `matrice-${safeName}.pdf`);
        toast('Salvata!', `matrice-${_viewedColleague.name}.pdf`);
      } catch(e){
        toast('Errore', 'Export non riuscito.');
      } finally {
        if(btn){ const i=btn.querySelector('i'); if(i) i.className='fa-solid fa-download'; }
      }
    }
    // ===== FINE MATRICE COLLEGA =====

    // Genera ID unico
    function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

    // pendingColleague — stato temporaneo della modal di aggiunta/modifica
    let pendingColleague = { id: null, name: '', role: null, team: null, durationKey: null, durationMinutes: null, startMonth: null, startWeekYear: new Date().getFullYear(), startWeekISO: null, anchorPatternIndex: null };

    function populateCTeamSelect(role, currentTeam){
      const sel = document.getElementById('cTeamSelect');
      if(!sel) return;
      sel.innerHTML = '<option value="">-- Seleziona --</option>';
      const teams = role === 'tutor' ? [7,8,9] : [1,2,3,4,5,6];
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = String(t);
        opt.textContent = `Team ${t}`;
        if(String(t) === String(currentTeam)) opt.selected = true;
        sel.appendChild(opt);
      });
      pendingColleague.team = teams.includes(Number(currentTeam)) ? Number(currentTeam) : null;
    }

    function refreshColleagueModalOptions(){
      const role = pendingColleague.role;
      const pattern = role === 'tutor' ? TUTOR_PATTERN : DIPENDENTE_PATTERN;

      // Opzioni orario
      const oSel = document.getElementById('cOptionSelect');
      if(oSel){
        oSel.innerHTML = '<option value="">-- Seleziona --</option>';
        pattern.forEach((entry, idx) => {
          const opt = document.createElement('option');
          opt.value = String(idx);
          opt.textContent = `Opzione ${idx+1}: ${optionText(entry)}`;
          oSel.appendChild(opt);
        });
        if(pendingColleague.anchorPatternIndex !== null) oSel.value = String(pendingColleague.anchorPatternIndex);
      }

      refreshColleagueWeeks();
    }

    function refreshColleagueWeeks(){
      const year = pendingColleague.startWeekYear || new Date().getFullYear();
      const month = pendingColleague.startMonth;

      const wSel = document.getElementById('cWeekSelect');
      if(!wSel) return;
      wSel.innerHTML = '<option value="">-- Seleziona --</option>';

      if(month !== null && month !== undefined){
        const candidates = computeWeeksForYear(year).filter(w => w.monthsTouched.has(month));
        candidates.forEach(w => {
          const opt = document.createElement('option');
          opt.value = w.iso;
          opt.textContent = w.label;
          wSel.appendChild(opt);
        });
        if(pendingColleague.startWeekISO) wSel.value = pendingColleague.startWeekISO;
      }
    }

    function validatePendingColleague(){
      const ok = pendingColleague.name.trim().length > 0
        && pendingColleague.role
        && pendingColleague.durationMinutes
        && pendingColleague.startWeekISO
        && pendingColleague.anchorPatternIndex !== null;
      const btn = document.getElementById('saveColleagueBtn');
      if(btn) btn.disabled = !ok;
      return ok;
    }

    function openColleagueModal(editId){
      if(editId){
        const existing = state.colleghi.find(c => c.id === editId);
        if(!existing) return;
        pendingColleague = { ...existing,
          startMonth: existing.startWeekISO ? parseISODate(existing.startWeekISO).getMonth() : 0,
          startWeekYear: existing.startWeekISO ? parseISODate(existing.startWeekISO).getFullYear() : new Date().getFullYear()
        };
        document.getElementById('colleagueModalTitle').textContent = 'Modifica collega';
      } else {
        pendingColleague = { id: null, name: '', role: null, team: null, durationKey: null, durationMinutes: null, startMonth: 0, startWeekYear: new Date().getFullYear(), startWeekISO: null, anchorPatternIndex: null };
        document.getElementById('colleagueModalTitle').textContent = 'Aggiungi collega';
      }

      // Popola campi
      document.getElementById('colleagueName').value = pendingColleague.name || '';

      document.querySelectorAll('#cRoleSegment button').forEach(b => {
        b.setAttribute('aria-pressed', b.getAttribute('data-role') === pendingColleague.role ? 'true' : 'false');
      });

      // Team select
      populateCTeamSelect(pendingColleague.role, pendingColleague.team);

      const cHours = document.getElementById('cHoursSelect');
      if(cHours) cHours.value = pendingColleague.durationKey || '';

      // Anno
      const ySel = document.getElementById('cYearSelect');
      ySel.innerHTML = '';
      const curY = new Date().getFullYear();
      for(let y = curY - 1; y <= curY + 2; y++){
        const opt = document.createElement('option');
        opt.value = String(y); opt.textContent = String(y);
        if(y === pendingColleague.startWeekYear) opt.selected = true;
        ySel.appendChild(opt);
      }

      // Mese
      const mSel = document.getElementById('cMonthSelect');
      mSel.innerHTML = '<option value="">-- Seleziona --</option>';
      MONTHS.forEach((m, i) => {
        const opt = document.createElement('option'); opt.value = String(i); opt.textContent = m;
        if(i === pendingColleague.startMonth) opt.selected = true;
        mSel.appendChild(opt);
      });

      refreshColleagueModalOptions();
      validatePendingColleague();
      openModal('colleagueModal');
    }

    function bindColleagueModal(){
      // Chiudi
      document.getElementById('closeColleagueModal').addEventListener('click', () => closeModal('colleagueModal'));
      document.getElementById('cancelColleagueBtn').addEventListener('click', () => closeModal('colleagueModal'));
      document.getElementById('colleagueModal').addEventListener('click', e => { if(e.target.id === 'colleagueModal') closeModal('colleagueModal'); });

      // Nome
      document.getElementById('colleagueName').addEventListener('input', e => {
        pendingColleague.name = e.target.value;
        validatePendingColleague();
      });

      // Ruolo
      document.querySelectorAll('#cRoleSegment button').forEach(btn => {
        btn.addEventListener('click', () => {
          pendingColleague.role = btn.getAttribute('data-role');
          pendingColleague.team = null;
          pendingColleague.anchorPatternIndex = null; // reset opzione
          document.querySelectorAll('#cRoleSegment button').forEach(b => b.setAttribute('aria-pressed', b === btn ? 'true' : 'false'));
          populateCTeamSelect(pendingColleague.role, null);
          refreshColleagueModalOptions();
          validatePendingColleague();
        });
      });

      // Team
      document.getElementById('cTeamSelect').addEventListener('change', e => {
        pendingColleague.team = e.target.value ? Number(e.target.value) : null;
        validatePendingColleague();
      });

      // Ore
      document.getElementById('cHoursSelect').addEventListener('change', e => {
        const k = e.target.value;
        pendingColleague.durationKey = k || null;
        pendingColleague.durationMinutes = k ? DURATIONS[k] : null;
        validatePendingColleague();
      });

      // Anno
      document.getElementById('cYearSelect').addEventListener('change', e => {
        pendingColleague.startWeekYear = parseInt(e.target.value, 10);
        pendingColleague.startWeekISO = null;
        refreshColleagueWeeks();
        validatePendingColleague();
      });

      // Mese
      document.getElementById('cMonthSelect').addEventListener('change', e => {
        pendingColleague.startMonth = e.target.value === '' ? null : parseInt(e.target.value, 10);
        pendingColleague.startWeekISO = null;
        refreshColleagueWeeks();
        validatePendingColleague();
      });

      // Settimana
      document.getElementById('cWeekSelect').addEventListener('change', e => {
        pendingColleague.startWeekISO = e.target.value || null;
        validatePendingColleague();
      });

      // Opzione
      document.getElementById('cOptionSelect').addEventListener('change', e => {
        pendingColleague.anchorPatternIndex = e.target.value === '' ? null : parseInt(e.target.value, 10);
        validatePendingColleague();
      });

      // Salva
      document.getElementById('saveColleagueBtn').addEventListener('click', () => {
        if(!validatePendingColleague()) return;
        const data = {
          id: pendingColleague.id || genId(),
          name: pendingColleague.name.trim(),
          role: pendingColleague.role,
          team: pendingColleague.team || null,
          durationKey: pendingColleague.durationKey,
          durationMinutes: pendingColleague.durationMinutes,
          startWeekISO: pendingColleague.startWeekISO,
          anchorPatternIndex: pendingColleague.anchorPatternIndex,
        };
        const idx = state.colleghi.findIndex(c => c.id === data.id);
        if(idx >= 0) state.colleghi[idx] = data;
        else state.colleghi.push(data);
        saveColleghi();
        renderTeamList();
        closeModal('colleagueModal');
      });
    }

    // Controlla se un orario (HH:MM) cade dentro il turno [start, end)
    function timeInShift(start, end, query){
      if(!start || !end || !query) return false;
      const s = timeToMinutes(start);
      const e = (end === '00:00') ? 1440 : timeToMinutes(end);
      const q = timeToMinutes(query);
      if(s < e) return q >= s && q < e;
      // Turno che attraversa la mezzanotte
      return q >= s || q < e;
    }

    // Cerca chi lavora in un dato giorno (e opzionalmente a un dato orario)
    function renderSearchResults(targetISO, queryTime){
      const el = document.getElementById('searchResults');
      if(!el) return;
      el.style.display = 'block';
      el.innerHTML = '';

      // Intestazione
      const head = document.createElement('div');
      head.className = 'search-head-row';
      const dateObj = parseISODate(targetISO);
      const dateLabel = dateObj.toLocaleDateString('it-IT', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
      head.innerHTML = `<i class="fa-regular fa-calendar"></i>${dateLabel}${queryTime ? ` &nbsp;<i class="fa-regular fa-clock" style="margin-left:4px"></i> ${queryTime}` : ''}`;
      el.appendChild(head);

      // Soggetti: tu (se generato) + team
      const subjects = [];
      if(state.generated && state.startWeekISO && state.anchorPatternIndex !== null){
        subjects.push({
          name: 'Tu',
          cfg: { role: state.role, durationMinutes: state.durationMinutes, startWeekISO: state.startWeekISO, anchorPatternIndex: state.anchorPatternIndex }
        });
      }
      state.colleghi.forEach(c => subjects.push({ name: c.name, cfg: c }));

      if(!subjects.length){
        const note = document.createElement('div');
        note.className = 'no-results-note';
        note.textContent = 'Genera prima la tua matrice o aggiungi colleghi al team.';
        el.appendChild(note);
        return;
      }

      subjects.forEach(s => {
        const day = getScheduleOnDate(s.cfg, targetISO);
        const initial = s.name.charAt(0).toUpperCase();
        let badgeClass, badgeText, timeText = '';

        if(!day){
          badgeClass = 'badge-out'; badgeText = 'Fuori periodo';
        } else if(day.isHoliday){
          badgeClass = 'badge-holiday'; badgeText = `Festivo — ${day.holidayName}`; timeText = `${day.start}–${day.end}`;
        } else if(day.isRest){
          badgeClass = 'badge-rest'; badgeText = 'Libero';
        } else {
          // Giorno lavorativo
          timeText = `${day.start}–${day.end}`;
          if(queryTime){
            // Con filtro orario
            if(timeInShift(day.start, day.end, queryTime)){
              badgeClass = 'badge-active'; badgeText = 'In turno ✔';
            } else {
              badgeClass = 'badge-offshift'; badgeText = 'Fuori orario';
            }
          } else {
            badgeClass = 'badge-work'; badgeText = 'Lavora';
          }
        }

        const row = document.createElement('div');
        row.className = 'sr-row';
        row.innerHTML = `
          <div class="sr-avatar">${escapeHtml(initial)}</div>
          <div class="sr-name">${escapeHtml(s.name)}</div>
          ${timeText ? `<div class="sr-time">${timeText}</div>` : ''}
          <span class="sr-badge ${badgeClass}">${badgeText}</span>`;
        el.appendChild(row);
      });
    }

    function bindSearchByDate(){
      const dateInput = document.getElementById('searchDateInput');
      const timeInput = document.getElementById('searchTimeInput');
      const btn = document.getElementById('searchDateBtn');
      if(!dateInput || !btn) return;

      // Precompila con oggi e ora attuale
      dateInput.value = isoDate(new Date());
      const now = new Date();
      timeInput.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

      const doSearch = () => {
        if(!dateInput.value) return;
        const qt = timeInput && timeInput.value ? timeInput.value : null;
        renderSearchResults(dateInput.value, qt);
      };

      btn.addEventListener('click', doSearch);
      dateInput.addEventListener('change', doSearch);
      timeInput.addEventListener('change', doSearch);
      dateInput.addEventListener('keydown', e => { if(e.key === 'Enter') doSearch(); });
    }

    // Applica dati Firebase allo state e aggiorna la UI
    function applyFirebaseData(fbData){
      if(!fbData) return;

      // Colleghi
      if(Array.isArray(fbData.colleghi)){
        state.colleghi = fbData.colleghi;
        safeStorageSet('colleghi', JSON.stringify(state.colleghi));
      }

      // Config matrice
      const cfg = fbData.config || {};
      if(cfg.role && (cfg.role === 'dipendente' || cfg.role === 'tutor')){
        state.role            = cfg.role;
        state.durationKey     = cfg.durationKey     ?? state.durationKey;
        state.durationMinutes = cfg.durationMinutes ?? state.durationMinutes;
        state.startWeekISO    = cfg.startWeekISO    ?? state.startWeekISO;
        state.anchorPatternIndex = (cfg.anchorPatternIndex !== undefined && cfg.anchorPatternIndex !== null)
          ? cfg.anchorPatternIndex : state.anchorPatternIndex;
        state.startMonth      = cfg.startMonth      ?? state.startMonth;
        state.generated       = !!cfg.generated;
        setActiveRole(state.role);
        // Sincronizza UI select ore
        const _hs = document.getElementById('hoursSelect');
        if(_hs && state.durationKey) _hs.value = state.durationKey;
        // Aggiorna localStorage per coerenza
        safeStorageSet('operatorRole',        state.role);
        if(state.durationKey)            safeStorageSet('durationKey', state.durationKey);
        if(state.anchorPatternIndex !== null) safeStorageSet('anchorPatternIndex', String(state.anchorPatternIndex));
        if(state.startMonth !== null)    safeStorageSet('startMonth', String(state.startMonth));
        if(state.startWeekISO)           safeStorageSet('startWeekISO', state.startWeekISO);
      }
    }

    function initTeam(){
      // Carica colleghi da localStorage (fallback immediato)
      try{ state.colleghi = JSON.parse(safeStorageGet('colleghi') || '[]'); } catch(e){ state.colleghi = []; }

      bindAdminModal();
      updateAdminUI();

      const addBtn = document.getElementById('addColleagueBtn');
      if(addBtn) addBtn.addEventListener('click', () => openColleagueModal(null));

      bindColleagueModal();
      bindSearchByDate();

      // Prova a caricare da Firestore (sovrascrive localStorage se ci sono dati più recenti)
      fbLoad().then(fbData => {
        if(!fbData) return;
        applyFirebaseData(fbData);
        // Aggiorna UI se arrivano dati dal cloud
        renderTeamList();
        syncStepsFromState();
        if(state.generated){ render(); }
        else { updateGenerateEnabled(); }
      });
    }

    // ===== FINE TEAM =====

    // ===== SCAMBI ORARI =====

    function buildCfgFromState(){
      return {
        role: state.role,
        team: state.team,
        durationMinutes: state.durationMinutes,
        startWeekISO: state.startWeekISO,
        anchorPatternIndex: state.anchorPatternIndex
      };
    }

    // Gap in minuti tra fine turno prev e inizio turno next (su giorni calendari consecutivi)
    function swapGapMinutes(prevStart, prevEnd, nextStart){
      const pS = timeStrToMinutes(prevStart);
      const pE = timeStrToMinutes(prevEnd);
      const nS = timeStrToMinutes(nextStart);
      // Prev end in minuti assoluti dal mezzanotte del giorno prev
      let prevEndAbs;
      if(prevEnd === '00:00'){
        prevEndAbs = 1440; // esattamente mezzanotte = fine giorno prev
      } else if(pE < pS){
        prevEndAbs = pE + 1440; // turno a cavallo mezzanotte
      } else {
        prevEndAbs = pE;
      }
      // Next start è 1 giorno dopo = +1440
      return (1440 + nS) - prevEndAbs;
    }

    // Controlla gap 11h tra due giorni consecutivi (prevDay → nextDay)
    function swapCheck11h(prevDay, nextDay){
      if(!prevDay || prevDay.isRest || !nextDay || nextDay.isRest) return { ok: true };
      const gap = swapGapMinutes(prevDay.start, prevDay.end, nextDay.start);
      if(gap < 660){
        const h = Math.floor(gap/60), m = gap%60;
        return { ok: false, reason: `Solo ${h}h${m ? ' '+m+'m' : ''} di riposo tra i turni (minimo 11h)` };
      }
      return { ok: true };
    }

    // Verifica gap 11h inserendo newShift su targetIso per una persona con cfg
    function swapValidate11h(cfg, targetIso, newShift){
      if(newShift.isRest) return [];
      const errors = [];
      const d = parseISODate(targetIso);
      const prevDay = getScheduleOnDate(cfg, isoDate(addDays(d, -1)));
      const nextDay = getScheduleOnDate(cfg, isoDate(addDays(d, +1)));
      const r1 = swapCheck11h(prevDay, newShift);
      if(!r1.ok) errors.push(r1.reason + ' (rispetto al giorno precedente)');
      const r2 = swapCheck11h(newShift, nextDay);
      if(!r2.ok) errors.push(r2.reason + ' (rispetto al giorno successivo)');
      return errors;
    }

    // Verifica max 5 giorni consecutivi dopo aver sostituito targetIso con newIsWork
    function swapValidate5Consec(cfg, targetIso, newIsWork){
      const center = parseISODate(targetIso);
      const arr = [];
      for(let i = -5; i <= 5; i++){
        const iso = isoDate(addDays(center, i));
        if(iso === targetIso){
          arr.push(newIsWork);
        } else {
          const d = getScheduleOnDate(cfg, iso);
          arr.push(d ? !d.isRest : false);
        }
      }
      let maxC = 0, cur = 0;
      for(const w of arr){ if(w){ cur++; maxC = Math.max(maxC, cur); } else cur = 0; }
      if(maxC > 5) return [`Troppi giorni consecutivi di lavoro: ${maxC} (massimo 5)`];
      return [];
    }

    function swapFmtDay(iso){
      const dayNames = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
      const dt = parseISODate(iso);
      return `${dayNames[dt.getDay()]} ${fmtDayMonth(dt)}`;
    }
    function swapFmtShift(day){
      if(!day) return '—';
      return day.isRest ? '🔴 Riposo' : `${day.start} – ${day.end}`;
    }

    // Nuovo motore di ricerca: cerca tutti i colleghi con cui è possibile fare lo scambio
    // targetISO: giorno desiderato
    // desiredType: 'shift' | 'rest'
    // desiredStart/End: orario desiderato (solo se desiredType='shift')
    // dayMe: turno utente su targetISO (da matrice o manuale) — null se non disponibile
    // myRole: ruolo utente
    // targetISO  = giorno che voglio (prendo il turno del collega)
    // myISO      = giorno che ho (cedo il mio turno al collega) — opzionale
    // desiredType/Start/End = cosa voglio in targetISO
    // dayMe      = mio turno su myISO (da matrice o manuale)
    // myRole     = mio ruolo
    function renderSwapSearch(targetISO, myISO, desiredType, desiredStart, desiredEnd, dayMe, myRole, container){
      const resultEl = container || document.getElementById('swapResult');
      if(!resultEl) return;
      if(!container){ resultEl.innerHTML = ''; resultEl.style.display = ''; }

      const useOwnMatrix = !!(state.generated && state.anchorPatternIndex !== null);
      const cfgA = useOwnMatrix ? buildCfgFromState() : null;
      const isBilateral = !!(myISO && myISO !== targetISO);

      const candidates = state.colleghi.filter(c =>
        c.startWeekISO && c.anchorPatternIndex !== null && c.anchorPatternIndex !== undefined
      );

      if(!candidates.length){
        resultEl.innerHTML = `<div class="note">Nessun collega configurato.</div>`;
        resultEl.style.display = 'block'; return;
      }

      // Turno che ho IO su targetISO prima dello scambio (per escludere scambi inutili)
      // Per myISO usiamo direttamente dayMe (passato come parametro, già corretto sia da matrice che da input manuale)
      const myCurrentOnTarget = cfgA ? getScheduleOnDate(cfgA, targetISO) : null;

      // Due turni sono identici?
      function sameShift(a, b){
        if(!a || !b) return false;
        if(a.isRest && b.isRest) return true;
        return !a.isRest && !b.isRest && a.start === b.start && a.end === b.end;
      }

      // Controlla 11h gap con prev/next espliciti
      function check11hExplicit(prevDay, newShift, nextDay, label, errors){
        if(!newShift || newShift.isRest) return;
        const r1 = swapCheck11h(prevDay, newShift);
        if(!r1.ok) errors.push(`${label}: ${r1.reason} (rispetto al giorno precedente)`);
        const r2 = swapCheck11h(newShift, nextDay);
        if(!r2.ok) errors.push(`${label}: ${r2.reason} (rispetto al giorno successivo)`);
      }

      // Conta max giorni lavorativi consecutivi con overrides
      function countMaxConsec(getCfgDay, center, overrides){
        let mx=0, cr=0;
        for(let i=-5; i<=5; i++){
          const iso = isoDate(addDays(center, i));
          let isWork;
          if(iso in overrides){ isWork = overrides[iso]; }
          else { const d = getCfgDay(iso); isWork = d ? !d.isRest : false; }
          if(isWork){ cr++; mx=Math.max(mx,cr); } else cr=0;
        }
        return mx;
      }

      const results = [];

      candidates.forEach(c => {
        const dayC_target = getScheduleOnDate(c, targetISO);
        if(!dayC_target) return;

        // Scambio inutile (stesso giorno): il collega ha identicamente lo stesso turno che ho io
        if(!isBilateral && sameShift(dayC_target, myCurrentOnTarget)) return;

        // isExact: il collega ha esattamente quello che ho chiesto
        let isExact = false;
        if(desiredType === 'rest'){
          isExact = dayC_target.isRest;
        } else {
          isExact = !dayC_target.isRest && dayC_target.start === desiredStart && dayC_target.end === desiredEnd;
        }

        if(myRole && myRole !== c.role) return;

        const errors = [];
        const dTarget = parseISODate(targetISO);
        const cName = escapeHtml(c.name);

        if(!isBilateral){
          // ── Stesso giorno ──────────────────────────────────────────────────
          if(dayMe){
            const cPrev = getScheduleOnDate(c, isoDate(addDays(dTarget,-1)));
            const cNext = getScheduleOnDate(c, isoDate(addDays(dTarget,+1)));
            check11hExplicit(cPrev, dayMe, cNext, cName, errors);
            swapValidate5Consec(c, targetISO, !dayMe.isRest).forEach(e => errors.push(`${cName}: ${e}`));
          }
          if(cfgA){
            const mePrev = getScheduleOnDate(cfgA, isoDate(addDays(dTarget,-1)));
            const meNext = getScheduleOnDate(cfgA, isoDate(addDays(dTarget,+1)));
            check11hExplicit(mePrev, dayC_target, meNext, 'Tu', errors);
            swapValidate5Consec(cfgA, targetISO, !dayC_target.isRest).forEach(e => errors.push(`Tu: ${e}`));
          }
          results.push({ c, dayC_target, dayC_my: null, dayMe_target: null, isExact, errors });

        } else {
          // ── Bilaterale: cedo myISO, prendo targetISO ──────────────────────
          const dMy = parseISODate(myISO);
          const dayC_my = getScheduleOnDate(c, myISO);
          // Scambio inutile (bilaterale): otterrei esattamente quello che ho già su entrambi i giorni
          // Scambio inutile: esclude se ALMENO UNO dei due giorni è un no-op
          // (otterrei su myISO lo stesso turno che ho già, oppure su targetISO lo stesso che ho già)
          if(sameShift(dayC_my, dayMe) || sameShift(dayC_target, myCurrentOnTarget)) return;
          const dayMe_target = cfgA ? getScheduleOnDate(cfgA, targetISO) : null;

          if(dayMe){
            const cPrev_my = getScheduleOnDate(c, isoDate(addDays(dMy,-1)));
            const myNextIso = isoDate(addDays(dMy,1));
            const cNext_my = (myNextIso === targetISO)
              ? (dayMe_target || { isRest: true })
              : getScheduleOnDate(c, myNextIso);
            check11hExplicit(cPrev_my, dayMe, cNext_my, cName, errors);
            const mx_c = countMaxConsec(iso => getScheduleOnDate(c, iso), dMy, { [myISO]: !dayMe.isRest, [targetISO]: false });
            if(mx_c > 5) errors.push(`${cName}: Troppi giorni consecutivi di lavoro: ${mx_c} (massimo 5)`);
          }

          const meNext_target = cfgA ? getScheduleOnDate(cfgA, isoDate(addDays(dTarget,+1))) : null;
          check11hExplicit(dayC_my || null, dayC_target, meNext_target, 'Tu', errors);
          if(cfgA){
            const mx_me = countMaxConsec(iso => getScheduleOnDate(cfgA, iso), dTarget, { [myISO]: false, [targetISO]: !dayC_target.isRest });
            if(mx_me > 5) errors.push(`Tu: Troppi giorni consecutivi di lavoro: ${mx_me} (massimo 5)`);
          }

          results.push({ c, dayC_target, dayC_my, dayMe_target, isExact, errors });
        }
      });

      // --- HTML ---
      const fmtDay = iso => {
        const dn = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
        const dt = parseISODate(iso);
        return `${dn[dt.getDay()]} ${fmtDayMonth(dt)}`;
      };
      const desiredLabel = desiredType === 'rest' ? '🔴 Riposo' : `${desiredStart} – ${desiredEnd}`;

      let html = `<div style="font-size:11px;font-weight:900;opacity:0.55;text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">`;
      if(myISO) html += `<strong>${fmtDay(myISO)}</strong> ⇄ <strong>${fmtDay(targetISO)}</strong> · vuoi: <strong>${desiredLabel}</strong>`;
      else      html += `Risultati per <strong>${fmtDay(targetISO)}</strong> → <strong>${desiredLabel}</strong>`;
      html += `</div>`;

      if(!results.length){
        html += `<div class="note"><i class="fa-solid fa-circle-info" style="margin-right:6px;"></i>Nessun collega disponibile per uno scambio su questa giornata.</div>`;
      } else {
        const okExact  = results.filter(r => r.errors.length === 0 && r.isExact);
        const okOther  = results.filter(r => r.errors.length === 0 && !r.isExact);
        const nokExact = results.filter(r => r.errors.length >  0 && r.isExact);
        const nokOther = results.filter(r => r.errors.length >  0 && !r.isExact);

        // Helper: renderizza una card di risultato
        const renderCard = ({c, dayC_target, dayC_my, dayMe_target}, accent) => {
          const iGetOnTarget  = isBilateral && dayC_target ? swapFmtShift(dayC_target) : (c.__exactLabel || swapFmtShift(dayC_target));
          const iGetLabel     = swapFmtShift(dayC_target);
          const cGetsOnTarget = isBilateral
            ? (dayMe_target ? swapFmtShift(dayMe_target) : '🔴 Riposo')
            : (dayMe ? swapFmtShift(dayMe) : '(turno tuo)');
          const iGetOnMy  = isBilateral && dayC_my ? swapFmtShift(dayC_my) : null;
          const cGetsOnMy = isBilateral && dayMe   ? swapFmtShift(dayMe)   : null;
          return `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:${accent.bg};border:1px solid ${accent.border};border-radius:10px;margin-bottom:6px;">
            <i class="fa-solid fa-circle-check" style="color:${accent.icon};font-size:18px;flex-shrink:0;margin-top:1px;"></i>
            <div style="flex:1;min-width:0;">
              <div style="font-weight:900;font-size:13px;">${escapeHtml(c.name)}</div>
              <div style="font-size:11px;opacity:0.6;margin-top:1px;">${c.role==='tutor'?'Tutor':'Dipendente'}${c.team?' · Team '+c.team:''}</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;font-size:12px;">
                <div style="background:rgba(255,255,255,0.65);border-radius:6px;padding:6px 8px;">
                  <div style="font-size:10px;opacity:0.5;margin-bottom:2px;">Tu ottieni (${fmtDay(targetISO)})</div>
                  <div style="font-weight:900;">${iGetLabel}</div>
                </div>
                <div style="background:rgba(255,255,255,0.65);border-radius:6px;padding:6px 8px;">
                  <div style="font-size:10px;opacity:0.5;margin-bottom:2px;">${escapeHtml(c.name)} ottiene (${fmtDay(targetISO)})</div>
                  <div style="font-weight:900;">${cGetsOnTarget}</div>
                </div>
                ${isBilateral && iGetOnMy !== null ? `
                <div style="background:rgba(255,255,255,0.65);border-radius:6px;padding:6px 8px;">
                  <div style="font-size:10px;opacity:0.5;margin-bottom:2px;">Tu ottieni (${fmtDay(myISO)})</div>
                  <div style="font-weight:900;">${iGetOnMy}</div>
                </div>
                <div style="background:rgba(255,255,255,0.65);border-radius:6px;padding:6px 8px;">
                  <div style="font-size:10px;opacity:0.5;margin-bottom:2px;">${escapeHtml(c.name)} ottiene (${fmtDay(myISO)})</div>
                  <div style="font-weight:900;">${cGetsOnMy||'—'}</div>
                </div>` : ''}
              </div>
            </div>
          </div>`;
        };

        const accentGreen = { bg:'rgba(34,197,94,.08)', border:'rgba(34,197,94,.22)', icon:'#22c55e' };
        const accentBlue  = { bg:'rgba(99,102,241,.07)', border:'rgba(99,102,241,.22)', icon:'#818cf8' };

        if(okExact.length){
          html += `<div style="margin-bottom:4px;font-size:11px;font-weight:700;opacity:0.5;text-transform:uppercase;letter-spacing:.04em;">Corrispondenza esatta</div>`;
          html += `<div style="margin-bottom:10px;">${okExact.map(r=>renderCard(r,accentGreen)).join('')}</div>`;
        }

        if(okOther.length){
          html += `<div style="margin-bottom:4px;margin-top:${okExact.length?6:0}px;font-size:11px;font-weight:700;opacity:0.5;text-transform:uppercase;letter-spacing:.04em;">Altre opzioni disponibili</div>`;
          html += `<div style="margin-bottom:10px;">${okOther.map(r=>renderCard(r,accentBlue)).join('')}</div>`;
        }

        const nokAll = [...nokExact, ...nokOther];
        if(nokAll.length){
          html += `<div style="margin-bottom:4px;font-size:11px;font-weight:700;opacity:0.45;margin-top:${(okExact.length||okOther.length)?8:0}px;text-transform:uppercase;letter-spacing:.04em;">Problemi contrattuali</div>`;
          nokAll.forEach(({c, errors}) => {
            html += `<div style="padding:9px 12px;background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.18);border-radius:10px;margin-bottom:6px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
                <i class="fa-solid fa-circle-xmark" style="color:#f87171;font-size:15px;flex-shrink:0;"></i>
                <span style="font-weight:900;font-size:13px;">${escapeHtml(c.name)}</span>
                <span style="font-size:11px;opacity:0.5;">${c.role==='tutor'?'Tutor':'Dipendente'}${c.team?' · Team '+c.team:''}</span>
              </div>
              <ul style="margin:0;padding-left:16px;font-size:11px;display:flex;flex-direction:column;gap:3px;opacity:0.75;">
                ${errors.map(e=>`<li>${e}</li>`).join('')}
              </ul>
            </div>`;
          });
        }
      }

      resultEl.innerHTML = html;
      resultEl.style.display = 'block';
    }

    function refreshSwapReadiness(){
      const prereq = document.getElementById('swapPrereq');
      const form   = document.getElementById('swapForm');
      const manual = document.getElementById('swapManualSection');
      if(!prereq || !form) return;
      const hasColleghi = state.colleghi.some(c => c.startWeekISO && c.anchorPatternIndex !== null && c.anchorPatternIndex !== undefined);
      prereq.style.display = hasColleghi ? 'none' : '';
      form.style.display   = hasColleghi ? '' : 'none';
      if(manual) manual.style.display = (hasColleghi && !state.generated) ? '' : 'none';
      // Sincronizza anche la card Trova Collega
      refreshFindColReadiness();
    }

    function initSwap(){
      refreshSwapReadiness();

      // Typed "Sei" segmented (modalità manuale)
      document.querySelectorAll('#swapRoleSegment button').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#swapRoleSegment button').forEach(b => b.setAttribute('aria-pressed', b === btn ? 'true' : 'false'));
        });
      });

      // Auto-fill fine turno +6h per inizio turno manuale
      const tutorEndMap = { '06:00':'12:00', '08:00':'14:00', '11:00':'17:00', '12:00':'18:00', '15:00':'21:00', '18:00':'00:00' };
      document.getElementById('swapManualStart').addEventListener('change', function(){
        const end = tutorEndMap[this.value] || '';
        document.getElementById('swapManualEnd').value = end;
      });
      document.getElementById('swapDesiredStart').addEventListener('change', function(){
        const end = tutorEndMap[this.value] || '';
        document.getElementById('swapDesiredEnd').value = end;
      });

      // Sincronizza mese: quando cambia "il giorno che hai", porta "il giorno che vuoi" nello stesso mese
      document.getElementById('swapMyDate').addEventListener('change', function(){
        if(!this.value) return;
        const target = document.getElementById('swapTargetDate');
        const myYM = this.value.substring(0, 7); // "YYYY-MM"
        const curYM = target.value ? target.value.substring(0, 7) : '';
        if(curYM !== myYM){
          target.value = myYM + '-01';
        }
      });

      const searchBtn = document.getElementById('swapSearchBtn');
      if(!searchBtn) return;
      searchBtn.addEventListener('click', () => {
        const myDate     = document.getElementById('swapMyDate').value;
        const targetDate = document.getElementById('swapTargetDate').value;
        if(!targetDate){ toast('Attenzione', 'Inserisci il giorno che vuoi.'); return; }

        const desiredStart = document.getElementById('swapDesiredStart').value;
        const desiredEnd   = document.getElementById('swapDesiredEnd').value;
        if(!desiredStart || !desiredEnd){ toast('Attenzione', 'Seleziona l\'orario desiderato.'); return; }

        const useOwnMatrix = !!(state.generated && state.anchorPatternIndex !== null);
        let myRole = null;
        if(useOwnMatrix){
          myRole = state.role;
        } else {
          const rolBtn = document.querySelector('#swapRoleSegment button[aria-pressed="true"]');
          myRole = rolBtn ? rolBtn.getAttribute('data-role') : null;
        }

        let dayMe = null;
        if(useOwnMatrix){
          if(myDate) dayMe = getScheduleOnDate(buildCfgFromState(), myDate);
        } else {
          const tStart = document.getElementById('swapManualStart').value;
          const tEnd   = document.getElementById('swapManualEnd').value;
          if(tStart && tEnd) dayMe = { isRest: false, start: tStart, end: tEnd };
        }

        renderSwapSearch(targetDate, myDate || null, 'shift', desiredStart, desiredEnd, dayMe, myRole);
      });
    }

    // ===== FINE SCAMBI ORARI =====

    // ===== TROVA COLLEGA =====
    function refreshFindColReadiness(){
      const prereq = document.getElementById('findColPrereq');
      const form   = document.getElementById('findColForm');
      if(!prereq || !form) return;
      const ready = state.generated &&
        state.colleghi.some(c => c.startWeekISO && c.anchorPatternIndex !== null && c.anchorPatternIndex !== undefined);
      prereq.style.display = ready ? 'none' : '';
      form.style.display   = ready ? '' : 'none';
      if(ready){
        // Popola il select degli orari target con tutti gli orari unici del pattern attivo
        const sel = document.getElementById('findColTarget');
        if(sel){
          const currentVal = sel.value;
          sel.innerHTML = '<option value="">— seleziona orario —</option>';
          const seen = new Set();
          (ACTIVE_PATTERN || []).forEach(p => {
            if(!seen.has(p.startTime)){
              seen.add(p.startTime);
              const opt = document.createElement('option');
              opt.value = p.startTime;
              opt.textContent = p.startTime;
              sel.appendChild(opt);
            }
          });
          // Aggiungi opzione Riposo
          if(!seen.has('LIBERO')){
            const opt = document.createElement('option');
            opt.value = 'LIBERO';
            opt.textContent = 'LIBERO (giorno di riposo)';
            sel.appendChild(opt);
          }
          if(currentVal) sel.value = currentVal;
        }
      }
    }

    function initFindColleague(){
      refreshFindColReadiness();

      // Aggiorna turno personale al cambio data
      const dateInput = document.getElementById('findColDate');
      if(dateInput) dateInput.addEventListener('change', () => {
        const myShiftEl = document.getElementById('findColMyShift');
        const resultEl  = document.getElementById('findColResult');
        if(resultEl) resultEl.style.display = 'none';
        if(!dateInput.value || !state.generated || state.anchorPatternIndex === null){
          if(myShiftEl) myShiftEl.style.display = 'none';
          return;
        }
        const cfg  = buildCfgFromState();
        const day  = getScheduleOnDate(cfg, dateInput.value);
        if(!day){ if(myShiftEl){ myShiftEl.textContent = 'Giorno fuori dalla tua matrice.'; myShiftEl.style.display = ''; } return; }
        if(myShiftEl){
          const shiftTxt = day.isRest ? '🔴 LIBERO' : `${day.start} – ${day.end}${day.isHoliday ? ' · '+day.holidayName : ''}`;
          myShiftEl.innerHTML = `<span style="opacity:.55;font-size:11px;">Il tuo turno:</span> <strong>${shiftTxt}</strong>`;
          myShiftEl.style.display = '';
        }
      });

      const btn = document.getElementById('findColBtn');
      if(!btn) return;
      btn.addEventListener('click', () => {
        const dateVal   = document.getElementById('findColDate').value;
        const targetOrario = document.getElementById('findColTarget').value;
        const resultEl  = document.getElementById('findColResult');
        if(!dateVal){ toast('Attenzione', 'Seleziona un giorno.'); return; }
        if(!targetOrario){ toast('Attenzione', 'Seleziona l\'orario che cerchi.'); return; }

        const cfgA   = buildCfgFromState();
        const myDay  = getScheduleOnDate(cfgA, dateVal);

        const matches   = []; // { name, shift, swapOk, swapErrors }
        const noShift   = []; // colleghi senza turno in quella data
        const wrongTime = []; // colleghi con orario diverso

        state.colleghi.forEach(c => {
          if(!c.startWeekISO || c.anchorPatternIndex === null || c.anchorPatternIndex === undefined) return;
          const cDay = getScheduleOnDate(c, dateVal);
          if(!cDay){ noShift.push(c.name); return; }

          const cShift = cDay.isRest ? 'LIBERO' : cDay.start;
          if(cShift !== targetOrario){ wrongTime.push({ name: c.name, shift: cDay.isRest ? 'LIBERO' : `${cDay.start}–${cDay.end}` }); return; }

          // Collega ha l'orario cercato — valida lo scambio (stesso giorno per entrambi)
          const errors = validateSwap(dateVal, dateVal, c, c.name);
          matches.push({ name: c.name, shift: cDay.isRest ? '🔴 LIBERO' : `${cDay.start} – ${cDay.end}`, swapOk: errors.length === 0, swapErrors: errors });
        });

        if(!resultEl) return;
        if(!matches.length && !wrongTime.length){
          resultEl.innerHTML = `<div class="note"><i class="fa-solid fa-circle-info" style="margin-right:6px;"></i>Nessun collega trovato con orario <strong>${escapeHtml(targetOrario)}</strong> in questa data.</div>`;
          resultEl.style.display = '';
          return;
        }

        let html = '';
        if(matches.length){
          html += `<div style="font-size:11px;font-weight:900;opacity:.55;text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">Colleghi con orario ${escapeHtml(targetOrario)}</div>`;
          matches.forEach(m => {
            const ok = m.swapOk;
            html += `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:12px;margin-bottom:8px;
              background:${ok ? 'rgba(34,197,94,.07)' : 'rgba(248,113,113,.07)'};
              border:1px solid ${ok ? 'rgba(34,197,94,.22)' : 'rgba(248,113,113,.22)'};">
              <i class="fa-solid ${ok ? 'fa-circle-check' : 'fa-circle-xmark'}" style="color:${ok ? '#22c55e' : '#f87171'};font-size:18px;flex-shrink:0;margin-top:1px;"></i>
              <div style="flex:1;min-width:0;">
                <div style="font-weight:900;font-size:13px;">${escapeHtml(m.name)}</div>
                <div style="font-size:12px;opacity:.65;margin-top:2px;">${escapeHtml(m.shift)}</div>
                ${!ok ? `<ul style="margin:6px 0 0;padding-left:16px;font-size:11px;color:#f87171;display:flex;flex-direction:column;gap:2px;">${m.swapErrors.map(e=>`<li>${escapeHtml(e)}</li>`).join('')}</ul>` : '<div style="font-size:11px;color:#22c55e;margin-top:3px;">Scambio ammesso ✓</div>'}
              </div>
            </div>`;
          });
        }
        if(wrongTime.length){
          html += `<details style="margin-top:4px;"><summary style="font-size:11px;font-weight:700;opacity:.45;cursor:pointer;">Altri colleghi (orario diverso) · ${wrongTime.length}</summary><div style="margin-top:6px;display:flex;flex-direction:column;gap:4px;">`;
          wrongTime.forEach(w => {
            html += `<div style="font-size:12px;padding:6px 10px;border-radius:8px;background:var(--ctrl-bg);">${escapeHtml(w.name)} — <span style="opacity:.6;">${escapeHtml(w.shift)}</span></div>`;
          });
          html += `</div></details>`;
        }
        resultEl.innerHTML = html;
        resultEl.style.display = '';
      });
    }
    // ===== FINE TROVA COLLEGA =====

    function stepDone(stepId, text){
      const inp = document.getElementById(`step-${stepId}-input`);
      const sum = document.getElementById(`step-${stepId}-sum`);
      const txt = document.getElementById(`step-${stepId}-text`);
      if(inp) inp.style.display = 'none';
      if(sum){
        sum.style.display = 'flex';
        sum.classList.remove('step-fadein');
        void sum.offsetWidth; // force reflow
        sum.classList.add('step-fadein');
      }
      if(txt) txt.textContent = text;
    }
    function stepOpen(stepId){
      const inp = document.getElementById(`step-${stepId}-input`);
      const sum = document.getElementById(`step-${stepId}-sum`);
      if(inp){
        inp.style.display = '';
        inp.classList.remove('step-fadein');
        void inp.offsetWidth;
        inp.classList.add('step-fadein');
      }
      if(sum) sum.style.display = 'none';
    }
    function stepHide(stepId){
      const inp = document.getElementById(`step-${stepId}-input`);
      const sum = document.getElementById(`step-${stepId}-sum`);
      if(inp) inp.style.display = 'none';
      if(sum) sum.style.display = 'none';
    }
    // Avanza al prossimo step del wizard; se tutti completati genera automaticamente
    function advanceWizard(){
      const steps = ['role','team','hours','week','option'];
      const done = {
        role:   !!state.role,
        team:   state.team !== null,
        hours:  !!state.durationKey,
        week:   !!state.startWeekISO,
        option: state.anchorPatternIndex !== null
      };
      const texts = {
        role:   state.role ? (state.role === 'tutor' ? 'Tutor' : 'Dipendente') : '',
        team:   state.team !== null ? `Team ${state.team}` : '',
        hours:  state.durationKey ? prettyDuration(state.durationKey) : '',
        week:   state.startWeekISO ? weekLabel(parseISODate(state.startWeekISO)) : '',
        option: (state.anchorPatternIndex !== null && ACTIVE_PATTERN) ? optionText(ACTIVE_PATTERN[state.anchorPatternIndex]) : ''
      };
      let firstIncomplete = null;
      steps.forEach(s => { if(!done[s] && firstIncomplete === null) firstIncomplete = s; });
      steps.forEach(s => {
        if(done[s]){
          stepDone(s, texts[s]);
        } else if(s === firstIncomplete){
          stepOpen(s);
          if(s === 'option') updateRefButtonsEnabled();
        } else {
          stepHide(s);
        }
      });
      if(!firstIncomplete){
        // Tutti gli step completati → genera automaticamente
        updateGenerateEnabled();
        const btn = document.getElementById('generateBtn');
        if(btn && !btn.disabled) btn.click();
      }
    }
    function syncStepsFromState(){
      const steps = ['role','team','hours','week','option'];
      const done = {
        role:   !!state.role,
        team:   state.team !== null,
        hours:  !!state.durationKey,
        week:   !!state.startWeekISO,
        option: state.anchorPatternIndex !== null
      };
      const texts = {
        role:   state.role ? (state.role === 'tutor' ? 'Tutor' : 'Dipendente') : '',
        team:   state.team !== null ? `Team ${state.team}` : '',
        hours:  state.durationKey ? prettyDuration(state.durationKey) : '',
        week:   state.startWeekISO ? weekLabel(parseISODate(state.startWeekISO)) : '',
        option: (state.anchorPatternIndex !== null && ACTIVE_PATTERN) ? optionText(ACTIVE_PATTERN[state.anchorPatternIndex]) : ''
      };
      let firstIncomplete = null;
      steps.forEach(s => { if(!done[s] && firstIncomplete === null) firstIncomplete = s; });
      steps.forEach(s => {
        if(done[s]){
          // Mostra il badge riepilogo senza animazione (caricamento iniziale)
          const inp = document.getElementById(`step-${s}-input`);
          const sum = document.getElementById(`step-${s}-sum`);
          const txt = document.getElementById(`step-${s}-text`);
          if(inp) inp.style.display = 'none';
          if(sum){ sum.style.display = 'flex'; }
          if(txt) txt.textContent = texts[s];
        } else if(s === firstIncomplete){
          const inp = document.getElementById(`step-${s}-input`);
          const sum = document.getElementById(`step-${s}-sum`);
          if(inp) inp.style.display = '';
          if(sum) sum.style.display = 'none';
        } else {
          stepHide(s);
        }
      });
    }

    function initRole(){
      const seg = document.getElementById('roleSegment');
      if(!seg) return;

      // Applica ruolo salvato (se presente)
      const saved = localStorage.getItem('operatorRole');
      if(saved === 'dipendente' || saved === 'tutor'){
        state.role = saved;
        setActiveRole(saved);
      }

      seg.querySelectorAll('button').forEach(btn=>{
        const role = btn.getAttribute('data-role');
        btn.setAttribute('aria-pressed', state.role === role ? 'true' : 'false');

        btn.addEventListener('click', (e)=>{
          addRipple(btn, e.clientX || (btn.getBoundingClientRect().left+10), e.clientY || (btn.getBoundingClientRect().top+10));
          playClickSound();

          state.role = role;
          localStorage.setItem('operatorRole', role);
          setActiveRole(role);

          // Ruolo cambiato => reset opzione (pattern diverso) e reset team
          state.anchorPatternIndex = null;
          localStorage.removeItem('anchorPatternIndex');
          state.team = null;
          localStorage.removeItem('team');

          // Ripopola dropdown team in base al ruolo
          populateTeamSelect(role);

          // Nascondi anteprima finò che non ri-genera
          state.generated = false;
          render();

          seg.querySelectorAll('button').forEach(b=>b.setAttribute('aria-pressed', b.getAttribute('data-role')===role ? 'true' : 'false'));

          updateRefLabels();
          advanceWizard();
        });
      });

      // Edit button
      const editBtn = document.getElementById('step-role-edit');
      if(editBtn) editBtn.addEventListener('click', ()=>{
        state.anchorPatternIndex = null;
        localStorage.removeItem('anchorPatternIndex');
        state.team = null;
        localStorage.removeItem('team');
        state.generated = false;
        render();
        stepHide('option');
        stepHide('team');
        stepOpen('role');
        updateRefButtonsEnabled();
        updateGenerateEnabled();
      });
    }

    function initHours(){
      const sel = document.getElementById('hoursSelect');
      const saved = localStorage.getItem('durationKey');
      if(saved && DURATIONS[saved]){
        state.durationKey = saved;
        state.durationMinutes = DURATIONS[saved];
        sel.value = saved;
      }

      sel.addEventListener('change', (e) => {
        playClickSound();
        const key = e.target.value;
        if(!key){ state.durationKey = null; state.durationMinutes = null; updateRefButtonsEnabled(); updateGenerateEnabled(); return; }
        state.durationKey = key;
        state.durationMinutes = DURATIONS[key];
        localStorage.setItem('durationKey', key);
        advanceWizard();
      });

      // Edit button ore
      const editBtn = document.getElementById('step-hours-edit');
      if(editBtn) editBtn.addEventListener('click', ()=>{ stepOpen('hours'); });

      updateRefButtonsEnabled();
      updateGenerateEnabled();
    }

    // --------- Team step ---------
    function populateTeamSelect(role){
      const sel = document.getElementById('teamSelect');
      if(!sel) return;
      sel.innerHTML = '<option value="">-- Seleziona team --</option>';
      const teams = role === 'tutor' ? [7,8,9] : [1,2,3,4,5,6];
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = `Team ${t}`;
        sel.appendChild(opt);
      });
      if(state.team !== null) sel.value = state.team;
    }

    function initTeamStep(){
      // Populate based on current role (may already be set)
      populateTeamSelect(state.role || 'dipendente');

      const sel = document.getElementById('teamSelect');
      if(!sel) return;

      // Restore from localStorage
      const saved = localStorage.getItem('team');
      if(saved !== null && saved !== ''){
        const n = Number(saved);
        if(Number.isFinite(n)){
          state.team = n;
          sel.value = n;
        }
      }

      sel.addEventListener('change', () => {
        const val = sel.value;
        if(!val){ state.team = null; localStorage.removeItem('team'); return; }
        state.team = Number(val);
        localStorage.setItem('team', state.team);
        state.generated = false;
        render();
        advanceWizard();
      });

      const editBtn = document.getElementById('step-team-edit');
      if(editBtn) editBtn.addEventListener('click', () => stepOpen('team'));
    }

    // --------- Theme & view ---------
    function setTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const icon = document.getElementById('themeIcon');
      const lbl  = document.getElementById('themeLabel');
      if(icon) icon.className = theme === 'dark' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
      if(lbl)  lbl.textContent = theme === 'dark' ? 'Buio' : 'Chiaro';
    }
    function initTheme(){
      const saved = localStorage.getItem('theme');
      if (saved === 'dark' || saved === 'light') setTheme(saved);
      else setTheme('light');
    }

    function initViewToggle(){
      const btn = document.getElementById('viewToggle');
      if(!btn) return;

      // restore saved mode
      const saved = safeStorageGet('viewMode');
      // default to saved preference
      const validModes = ['table','cards','calendar'];
      state.viewMode = validModes.includes(saved) ? saved : 'table';

      // If small screen (mobile) we force cards view. Listen for changes to viewport size
      try{
        const m = window.matchMedia('(max-width: 720px)');
        const applyResponsive = (mq)=>{
          if(mq.matches){
            state.viewMode = 'cards';
          } else {
            const restored = safeStorageGet('viewMode');
            state.viewMode = validModes.includes(restored) ? restored : 'table';
          }
          updateViewToggleIcon();
          if(state.generated) render();
        };
        // initial apply
        applyResponsive(m);
        // listen for changes
        if(typeof m.addEventListener === 'function') m.addEventListener('change', (e)=>applyResponsive(e));
        else if(typeof m.addListener === 'function') m.addListener((e)=>applyResponsive(e));
      }catch(e){
        updateViewToggleIcon();
      }

      btn.addEventListener('click', (e)=>{
        addRipple(btn, e.clientX || (btn.getBoundingClientRect().left+10), e.clientY || (btn.getBoundingClientRect().top+10));
        playClickSound();
        // Ciclo: table → cards → calendar → table
        const cycle = ['table','cards','calendar'];
        const idx = cycle.indexOf(state.viewMode);
        state.viewMode = cycle[(idx + 1) % cycle.length];
        safeStorageSet('viewMode', state.viewMode);
        updateViewToggleIcon();
        if(state.generated) render();
        // toast removed for view toggle per user preference
      });
    }

    function updateViewToggleIcon(){
      const btn = document.getElementById('viewToggle');
      if(!btn) return;
      const icon = btn.querySelector('i');
      if(!icon) return;
      const iconMap = { table: 'fa-solid fa-layer-group', cards: 'fa-solid fa-calendar-days', calendar: 'fa-solid fa-table-cells-large' };
      const labelMap = { table: 'Passa a schede', cards: 'Passa a calendario', calendar: 'Passa a tabella' };
      const activeLabel = { table: 'Tabella', cards: 'Schede', calendar: 'Calendario' };
      icon.className = iconMap[state.viewMode] || 'fa-solid fa-layer-group';
      btn.setAttribute('aria-label', labelMap[state.viewMode] || 'Cambia vista');
      const vl = document.getElementById('viewLabel');
      if(vl) vl.textContent = activeLabel[state.viewMode] || 'Vista';
    }

    // --------- Export (PNG) ---------
    // Costruisce un nodo calendario completamente con stili inline per html2canvas
    // Export matrice propria: delega a buildCalendarExportNodeForCfg con configurazione corrente
    function buildCalendarExportNode(){
      return buildCalendarExportNodeForCfg(buildCfgFromState());
    }

    function buildExportNode(){
      const root = document.createElement('div');
      root.className = 'export-root';

      const title = document.createElement('div');
      title.style.fontWeight = '900';
      title.style.marginBottom = '10px';
      const viewLabel = { table: 'Tabella', cards: 'Schede', calendar: 'Calendario' }[state.viewMode] || '';
      title.textContent = `Matrice Orari — ${viewLabel} (${computeTotalWeeks()} settimane)`;
      root.appendChild(title);

      const meta = document.createElement('div');
      meta.style.fontSize = '12px';
      meta.style.color = '#334155';
      meta.style.marginBottom = '12px';
      const monthText = (state.startMonth === null) ? '-' : MONTHS[state.startMonth];
      const weekText = state.startWeekISO ? weekLabel(parseISODate(state.startWeekISO)) : '-';
      const optText = (state.anchorPatternIndex !== null) ? optionText(ACTIVE_PATTERN[state.anchorPatternIndex]) : '-';
      meta.textContent = `Ore: ${state.durationKey || '-'} • Partenza: ${monthText} • ${weekText} • ${optText}`;
      root.appendChild(meta);

      if(state.viewMode === 'table'){
        const table = document.getElementById('matrixTable');
        if(!table) return null;
        const container = document.createElement('div');
        container.className = 'matrix-container';
        container.appendChild(table.cloneNode(true));
        root.appendChild(container);
      } else if(state.viewMode === 'cards'){
        const src = document.getElementById('matrixCardsWrap');
        if(!src) return null;
        const clone = src.cloneNode(true);
        // Forza apertura di tutti i details per l'export
        clone.querySelectorAll('details').forEach(d => d.setAttribute('open', ''));
        root.appendChild(clone);
      } else if(state.viewMode === 'calendar'){
        root.appendChild(buildCalendarExportNode());
      } else {
        return null;
      }

      return root;
    }

    // Converte un canvas html2canvas in un Blob PDF (jsPDF)
    function canvasToPdfBlob(canvas){
      const { jsPDF } = window.jspdf;
      const imgData = canvas.toDataURL('image/jpeg', 0.92);
      const pxToMm = 0.264583; // 1px @ 96dpi = 0.264583mm
      const imgW = canvas.width  * pxToMm;
      const imgH = canvas.height * pxToMm;
      const orientation = imgW >= imgH ? 'landscape' : 'portrait';
      const pdf = new jsPDF({ orientation, unit: 'mm', format: [imgW, imgH], compress: true });
      pdf.addImage(imgData, 'JPEG', 0, 0, imgW, imgH, undefined, 'FAST');
      return pdf.output('blob');
    }

    async function exportPdfBlob(){
      const node = buildExportNode();
      if(!node) throw new Error('Nessuna matrice');

      node.style.position = 'fixed';
      node.style.left = '-99999px';
      node.style.top = '0';
      document.body.appendChild(node);

      try{
        const canvas = await html2canvas(node, {
          backgroundColor: '#ffffff',
          scale: Math.min(3, window.devicePixelRatio ? window.devicePixelRatio * 2 : 2),
          useCORS: true,
          logging: false,
          scrollX: 0,
          scrollY: 0,
        });
        return canvasToPdfBlob(canvas);
      } finally {
        node.remove();
      }
    }

    async function savePng(){
      if(!state.generated){ toast('Matrice assente', 'Genera prima la matrice.'); return; }
      const btn = document.getElementById('saveTopBtn');
      if(btn){ const i = btn.querySelector('i'); if(i) i.className = 'fa-solid fa-spinner fa-spin'; }
      try{
        const blob = await exportPdfBlob();
        if(!blob) throw new Error('Export fallito');
        const fileLabel = { table: 'tabella', cards: 'schede', calendar: 'calendario' }[state.viewMode] || 'vista';
        _downloadBlob(blob, `matrice-orari-${fileLabel}.pdf`);
        toast('Salvata!', `matrice-orari-${fileLabel}.pdf`);
      } catch(err){
        toast('Errore', 'Impossibile esportare.');
      } finally {
        if(btn){ const i = btn.querySelector('i'); if(i) i.className = 'fa-solid fa-download'; }
      }
    }

    async function sharePng(){
      if(!state.generated){ toast('Matrice assente', 'Genera prima la matrice.'); return; }
      const btn = document.getElementById('shareTopBtn');
      if(btn){ const i = btn.querySelector('i'); if(i) i.className = 'fa-solid fa-spinner fa-spin'; }
      try{
        const blob = await exportPdfBlob();
        if(!blob) throw new Error('Export fallito');
        const fileLabel = { table: 'tabella', cards: 'schede', calendar: 'calendario' }[state.viewMode] || 'vista';
        const fileName = `matrice-orari-${fileLabel}.pdf`;
        const file = new File([blob], fileName, { type: 'application/pdf' });

        if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ title: 'Matrice Orari', files: [file] });
        } else {
          _downloadBlob(blob, fileName);
          toast('Salvata', 'File scaricato.');
        }
      } catch(err){
        if(err && err.name !== 'AbortError'){
          toast('Errore', 'Impossibile condividere. Prova Salva.');
        }
      } finally {
        if(btn){ const i = btn.querySelector('i'); if(i) i.className = 'fa-solid fa-share-nodes'; }
      }
    }

    function _downloadBlob(blob, fileName){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = fileName;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1200);
    }

    // --------- Events wiring ---------
    function bindButtonFeedback(){
      document.querySelectorAll('.btn, .btn-ghost, .select-like, .cta, .icon-btn').forEach(btn => {
        btn.addEventListener('pointerdown', (e)=>{
          // ripple
          const x = e.clientX || (btn.getBoundingClientRect().left+10);
          const y = e.clientY || (btn.getBoundingClientRect().top+10);
          addRipple(btn, x, y);
        }, {passive:true});
        btn.addEventListener('click', ()=>{ playClickSound(); }, {passive:true});
      });
    }

    function init(){
      initTheme();
      initViewToggle();

      // Theme toggle (icon stays gear)
      const tt = document.getElementById('themeToggle');
      if(tt){
        tt.addEventListener('click', (e)=>{
          addRipple(tt, e.clientX || (tt.getBoundingClientRect().left+10), e.clientY || (tt.getBoundingClientRect().top+10));
          playClickSound();
          const cur = document.documentElement.getAttribute('data-theme') || 'dark';
          setTheme(cur === 'dark' ? 'light' : 'dark');
          // toast removed for theme toggle per user preference
        });
      }

      bindButtonFeedback();

      // Prepara calendario settimane (anno di riferimento)
      ALL_WEEKS = computeWeeksForYear(REFERENCE_YEAR);

      // Carica ruolo operatore (prima di tutto, perché cambia le opzioni)
      const savedRole = localStorage.getItem('operatorRole');
      if(savedRole === 'dipendente' || savedRole === 'tutor'){
        state.role = savedRole;
        setActiveRole(savedRole);
      }

      // Carica preferenze salvate
      const savedOpt = localStorage.getItem('anchorPatternIndex');
      if(savedOpt !== null && savedOpt !== ''){
        const idx = Number(savedOpt);
        if(Number.isFinite(idx) && idx >= 0 && idx < ACTIVE_PATTERN.length){
          state.anchorPatternIndex = idx;
        }
      }

      const savedMonth = localStorage.getItem('startMonth');
      if(savedMonth !== null && savedMonth !== ''){
        const m = Number(savedMonth);
        if(Number.isFinite(m) && m >= 0 && m <= 11){
          state.startMonth = m;
        }
      }

      const savedWeek = localStorage.getItem('startWeekISO');
      if(savedWeek){
        state.startWeekISO = savedWeek;
      }
      // No fallback for startWeekISO: if nothing saved → stays null (clean wizard, no pre-selection)

      // Default startMonth only for calendar picker navigation (not exposed as a visible selection)
      if(state.startMonth === null){
        state.startMonth = parseISODate(BASE_START_ISO).getMonth();
      }

      // Ruolo operatore (Dipendente/Tutor)
      initRole();

      // Team
      initTeamStep();

      // Ore (attiva/disable UI)
      initHours();

      // Firebase (avvia sign-in async; initTeam lo attende tramite _fbInitPromise)
      try { initFirebase(); } catch(e){ console.warn('[FB] initFirebase crashed:', e); }

      // Team e cerca per data
      initTeam();

      // Scambi orari
      initSwap();

      // Trova collega
      initFindColleague();

      // Calendario inline settimana
      initInlineCal();

      // Labels/modals (dipendono da ore + settimana)
      updateRefLabels();

      // Open/close modals
      document.getElementById('optionBtn').addEventListener('click', ()=>{ if(!document.getElementById('optionBtn').disabled){ initOptionModal(); openModal('optionModal'); }});
      document.getElementById('closeOptionModal').addEventListener('click', ()=>closeModal('optionModal'));
      document.getElementById('optionModal').addEventListener('click', (e)=>{ if(e.target.id==='optionModal') closeModal('optionModal'); });

      // Generate
      document.getElementById('generateBtn').addEventListener('click', ()=>{
        state.generated = true;
        render();
        toast('Ok', `Matrice generata (${computeTotalWeeks()} settimane).`);
        fbSave(); // sincronizza config matrice su Firestore
      });

      // Reset
      document.getElementById('resetBtn').addEventListener('click', ()=>{
        state.generated = false;

        state.role = null;
        setActiveRole('dipendente');
        state.durationKey = null;
        state.durationMinutes = null;
        state.team = null;
        state.anchorPatternIndex = null;
        state.startMonth = parseISODate(BASE_START_ISO).getMonth();
        state.startWeekISO = BASE_START_ISO;

        // Riapri solo il primo step del wizard
        ['role','team','hours','week','option'].forEach(s => stepHide(s));
        stepOpen('role');
        renderInlineCal();
        const calLbl = document.getElementById('calSelLabel');
        if(calLbl) calLbl.textContent = 'Seleziona settimana';

        localStorage.removeItem('operatorRole');
        localStorage.removeItem('team');
        localStorage.removeItem('durationKey');
        localStorage.removeItem('anchorPatternIndex');
        localStorage.removeItem('startMonth');
        localStorage.removeItem('startWeekISO');
        fbSave(); // aggiorna Firestore dopo reset

        // UI reset ruolo
        document.querySelectorAll('#roleSegment button').forEach(b => b.setAttribute('aria-pressed','false'));

        // UI reset team
        const teamSel = document.getElementById('teamSelect');
        if(teamSel){ populateTeamSelect('dipendente'); teamSel.value = ''; }

        // UI reset ore
        const hoursSelect = document.getElementById('hoursSelect');
        if(hoursSelect) hoursSelect.value = '';

        updateRefLabels();
        updateGenerateEnabled();
        render();
        toast('Reset', 'Impostazioni azzerate.');
      });

            // Preview top button
      const pt = document.getElementById('previewTopBtn');
      if(pt){
        pt.addEventListener('click', ()=>{
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      // Export buttons
      document.getElementById('saveTopBtn').addEventListener('click', savePng);

      // Matrice collega: close + backdrop + save
      document.getElementById('closeColleagueMatrixModal').addEventListener('click', ()=> closeModal('colleagueMatrixModal'));
      document.getElementById('saveCollegueMatrixBtn').addEventListener('click', saveColleaguePng);
      document.getElementById('colleagueMatrixModal').addEventListener('click', e=>{ if(e.target.id==='colleagueMatrixModal') closeModal('colleagueMatrixModal'); });
      // Toggle calendario / schede / tabella
      const _allToggleBtns = ['toggleCalBtn','toggleCardsBtn','toggleTblBtn'];
      function _setColleagueToggle(active){
        _allToggleBtns.forEach(id => {
          const btn = document.getElementById(id);
          if(!btn) return;
          const isActive = id === active;
          btn.style.setProperty('background', isActive ? 'var(--accent)' : '#fff');
          btn.style.setProperty('color', isActive ? '#fff' : '#64748b');
        });
      }
      document.getElementById('toggleCalBtn').addEventListener('click', ()=>{
        _colleagueViewMode = 'calendar';
        _setColleagueToggle('toggleCalBtn');
        renderColleagueBody();
      });
      document.getElementById('toggleCardsBtn').addEventListener('click', ()=>{
        _colleagueViewMode = 'cards';
        _setColleagueToggle('toggleCardsBtn');
        renderColleagueBody();
      });
      document.getElementById('toggleTblBtn').addEventListener('click', ()=>{
        _colleagueViewMode = 'table';
        _setColleagueToggle('toggleTblBtn');
        renderColleagueBody();
      });

      // Stampa: mostra solo vista attiva, apri tutti i details
      window.addEventListener('beforeprint', () => {
        const vm = state.viewMode;
        ['matrixTableWrap','matrixCardsWrap','matrixCalendarWrap'].forEach(id => {
          const el = document.getElementById(id); if(el) el.classList.remove('print-show');
        });
        const activeId = {table:'matrixTableWrap', cards:'matrixCardsWrap', calendar:'matrixCalendarWrap'}[vm];
        if(activeId){ const el = document.getElementById(activeId); if(el) el.classList.add('print-show'); }
        document.querySelectorAll('#matrixCardsWrap details').forEach(d => d.setAttribute('open',''));
      });
      window.addEventListener('afterprint', () => {
        ['matrixTableWrap','matrixCardsWrap','matrixCalendarWrap'].forEach(id => {
          const el = document.getElementById(id); if(el) el.classList.remove('print-show');
        });
        if(state.generated) render();
      });

      // Edit button opzione
      const oEdit = document.getElementById('step-option-edit');
      if(oEdit) oEdit.addEventListener('click', ()=>{
        stepOpen('option');
        updateRefButtonsEnabled();
      });
      // (step-week-edit è gestito dentro initInlineCal)

      // Riconcilia stato UI con stato salvato in localStorage
      syncStepsFromState();

      // Improve touch scrolling: keep vertical pan enabled even over the table
      document.addEventListener('touchmove', ()=>{}, {passive:true});
    }

    // Function to switch to card view for mobile or tablet
    function switchToCardView() {
      const isMobileOrTablet = window.matchMedia("(max-width: 768px)").matches;
      const matrixElement = document.querySelector('.matrix'); // Assuming the matrix has a class named 'matrix'

      if (isMobileOrTablet) {
        matrixElement.classList.add('card-view'); // Add a class to switch to card view
      } else {
        matrixElement.classList.remove('card-view'); // Remove the class for larger screens
      }
    }

    // Add event listener for screen resize
    window.addEventListener('resize', switchToCardView);

    // Initial check on page load
    document.addEventListener('DOMContentLoaded', () => {
      switchToCardView();
    });
    
    init();
  </script>
</body>
</html>