<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Matrice Orari</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --bg-a: #5ee7df;
      --bg-mid: #eaf7ff;
      --bg-b: #7b61ff;

      --card: rgba(255,255,255,0.92);
      --stroke: rgba(11,16,32,0.10);
      --text: #0b1020;
      --muted: rgba(11,16,32,0.62);

      --shadow: 0 18px 44px rgba(0,0,0,0.22);
      --shadow-soft: 0 10px 24px rgba(0,0,0,0.18);
      --radius: 18px;

      --accent: #5c9bff;
      --accent2: #14b8a6;
      --danger: #e11d48;
      --ok: #16a34a;
      --warn: #f59e0b;

      --table-bg: #ffffff;
      --table-stroke: rgba(11,16,32,0.10);
      --table-zebra: rgba(11,16,32,0.03);
    }
    html[data-theme="dark"]{
      --bg-a: #3a7686;
      --bg-mid: #0b1420;
      --bg-b: #0b1420;

      --card: rgba(18, 42, 55, 0.96);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);

      --shadow: 0 18px 44px rgba(0,0,0,0.55);
      --shadow-soft: 0 14px 28px rgba(0,0,0,0.40);

      --table-bg: rgba(11, 18, 25, 0.88);
      --table-stroke: rgba(255,255,255,0.10);
      --table-zebra: rgba(11, 18, 25, 0.28);
    }

*{box-sizing:border-box;}
    html, body{height:100%;}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg-a) 0%, var(--bg-mid) 40%, var(--bg-b) 100%);
      color: var(--text);
      padding: 14px;
      padding-bottom: calc(92px + env(safe-area-inset-bottom));
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: auto;
      touch-action: pan-x pan-y;
    }
    body.modal-open{overflow:hidden;}
    a{color:inherit}

    .app-shell{max-width: 1100px; margin:0 auto;}
    .topbar{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: calc(env(safe-area-inset-top) + 12px);
      z-index: 9999;
      /* make it a longer rectangle matching the app width */
      width: calc(100% - 48px);
      max-width: 1100px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
      padding:12px 20px;
      border-radius: 12px; /* less rounded for a more rectangular look */
      background: var(--card);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(14px);
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0;}
    .brand-icon{
      width:44px; height:44px; border-radius: 14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(92,155,255,0.28), rgba(123,97,255,0.22));
      border: 1px solid var(--stroke);
      flex: 0 0 auto;
    }
    .brand h1{
      margin:0; font-size: 16px; line-height: 1.15;
      letter-spacing: -0.2px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .brand small{
      display:block; font-size: 12px; color: var(--muted);
      margin-top: 2px;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
    }

    .top-actions{
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px; /* Increase spacing between buttons */
      flex-wrap: wrap; /* Allow buttons to wrap to the next line on smaller screens */
    }
    .icon-btn{
      width:50px; /* Increase button size */
      height:50px;
      border-radius:50%; /* Make buttons circular */
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:18px; /* Increase icon size */
    }
    .icon-btn i{
      font-size: 20px; /* Adjust icon size */
    }

    .center-controls{
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display:flex;
      gap: 12px;
      align-items:center;
      z-index: 60;
    }
    .center-controls .ctrl{
      display:flex; flex-direction:column; gap:6px; align-items:center; font-weight:700;
      color: var(--muted); font-size:12px;
    }
    .center-controls .ctrl .label{font-size:11px; color:var(--muted);}
    /* topbar position handled above (fixed) */
    .icon-btn{
      width:42px; height:42px; border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.30);
      display:grid; place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
      overflow:hidden;
    }
    html[data-theme="dark"] .icon-btn{background: rgba(0,0,0,0.18);}
    .icon-btn:active{transform: translateY(1px);}
    .ripple{
      position:absolute; border-radius: 999px; transform: translate(-50%,-50%);
      pointer-events:none;
      width: 10px; height: 10px;
      background: rgba(255,255,255,0.55);
      animation: ripple 520ms ease-out forwards;
      mix-blend-mode: overlay;
    }
    @keyframes ripple{
      from{opacity: 0.85; transform: translate(-50%,-50%) scale(1);}
      to{opacity:0; transform: translate(-50%,-50%) scale(16);}
    }

    main{padding-top: 14px;}

    /* When topbar is fixed, add top padding so content isn't covered */
    .app-shell{padding-top: calc(72px + env(safe-area-inset-top));}

    .grid{
      display:grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card-head{
      padding: 14px 14px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.25);
    }
    html[data-theme="dark"] .card-head{border-bottom: 1px solid rgba(255,255,255,0.10);}
    .card-title{font-weight: 1000; letter-spacing:-0.2px;}
    .card-sub{font-size: 12px; color: var(--muted); margin-top: 4px;}
    .card-body{padding: 14px;}

    .note{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.35;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .note i{margin-top: 2px; opacity: 0.9;}

    .controls-grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width: 520px){
      .controls-grid{grid-template-columns: 1fr 1fr;}
    }
    .control-label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .segmented{
      display:flex;
      gap: 8px;
      padding: 6px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.30);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    html[data-theme="dark"] .segmented{background: rgba(0,0,0,0.18);}
    .segmented button{
      flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.62);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
      white-space: nowrap;
    }
    html[data-theme="dark"] .segmented button{background: rgba(16,18,27,0.60); border: 1px solid rgba(255,255,255,0.10);}
    .segmented button[aria-pressed="true"]{
      outline: 2px solid rgba(92,155,255,0.55);
      box-shadow: 0 12px 22px rgba(0,0,0,0.14);
    }

    .btn-ghost{
      width: 100%;
      min-height: 46px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.30);
      color: var(--text);
      font-weight: 900;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
    }
    html[data-theme="dark"] .btn-ghost{background: rgba(0,0,0,0.18);}
    .btn-ghost:active{transform: translateY(1px);}
    .btn-ghost:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      filter: saturate(0.85);
    }
    .btn-ghost:disabled i{opacity: 0.6;}


    .hint-row{display:flex; gap: 10px; margin-top: 10px; flex-wrap:wrap;}
    .hint-pill{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      color: var(--text);
      font-weight: 800;
    }
    html[data-theme="dark"] .hint-pill{background: rgba(0,0,0,0.20);}

    .row-actions{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn{
      border: 1px solid rgba(11,16,32,0.06);
      background: linear-gradient(180deg,#ffffff,#f3f4f6);
      color: var(--text);
      font-weight: 1000;
      padding: 12px 16px;
      border-radius: 16px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      display:flex; align-items:center; gap: 10px;
      position:relative;
      overflow:hidden;
      box-shadow: 0 6px 14px rgba(2,6,23,0.04);
    }
    html[data-theme="dark"] .btn{background: rgba(16,18,27,0.78); color: #fff; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 8px 18px rgba(0,0,0,0.32);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(139,92,246,0.95));
      border: 1px solid rgba(59,130,246,0.45);
      color: #fff;
      box-shadow: 0 10px 22px rgba(59,130,246,0.12);
    }
    .btn:disabled{opacity: 0.55; cursor:not-allowed;}

    /* Preview */
    .preview-wrap{display:none;}
    .preview-wrap.is-visible{display:block;}

    /* Vista a schede */
    .cards-wrap{display:none; margin-top: 10px;}
    .cards-wrap.is-visible{display:block;}

    /* Vista calendario */
    .calendar-wrap{display:none; margin-top: 10px;}
    .calendar-wrap.is-visible{display:block;}
    .cal-month{
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
    }
    .cal-month-title{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -0.2px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(90deg, rgba(92,155,255,0.12), rgba(123,97,255,0.08));
    }
    html[data-theme="dark"] .cal-month-title{
      background: linear-gradient(90deg, rgba(96,165,250,0.18), rgba(139,92,246,0.14));
    }
    .cal-grid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-top: 1px solid var(--stroke);
    }
    .cal-dow{
      text-align: center;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      padding: 8px 4px;
      border-right: 1px solid var(--stroke);
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,0.18);
      letter-spacing: 0.4px;
    }
    html[data-theme="dark"] .cal-dow{background: rgba(0,0,0,0.14);}
    .cal-dow:last-child{border-right: 0;}
    .cal-cell{
      min-height: 72px;
      padding: 6px 5px;
      border-right: 1px solid var(--stroke);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
    }
    .cal-cell:nth-child(7n){border-right: 0;}
    .cal-cell.cal-empty{background: rgba(0,0,0,0.015);}
    html[data-theme="dark"] .cal-cell.cal-empty{background: rgba(0,0,0,0.10);}
    .cal-cell.cal-rest{
      background: rgba(239,68,68,0.04);
    }
    html[data-theme="dark"] .cal-cell.cal-rest{background: rgba(239,68,68,0.07);}
    .cal-cell.cal-holiday{
      background: rgba(239,68,68,0.07);
    }
    .cal-day-num{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      line-height: 1;
      margin-bottom: 2px;
    }
    .cal-cell.cal-today .cal-day-num{
      color: var(--accent);
    }
    .cal-time{
      font-size: 12px;
      font-weight: 900;
      color: var(--text);
      line-height: 1.15;
    }
    .cal-time-end{
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
    }
    .cal-libero{
      font-size: 11px;
      font-weight: 900;
      color: var(--danger);
      letter-spacing: 0.2px;
    }
    .cal-hname{
      font-size: 10px;
      font-weight: 900;
      color: var(--danger);
      line-height: 1.2;
      word-break: break-word;
    }
    .cal-time.time-red{ color: var(--danger); }
    .week-card{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.55);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
      margin-bottom: 10px;
    }
    html[data-theme="dark"] .week-card{background: rgba(0,0,0,0.14);}
    .week-card summary{
      list-style: none;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px 12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .week-card summary::-webkit-details-marker{display:none;}
    .week-card .wc-title{
      font-weight: 1000;
      font-size: 13px;
      letter-spacing: -0.1px;
    }
    .week-card .wc-sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .week-card .wc-left{min-width:0;}
    .week-card .chev{
      width: 34px; height:34px;
      display:grid; place-items:center;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
    }
    html[data-theme="dark"] .week-card .chev{background: rgba(0,0,0,0.18);}
    details[open] .chev{transform: rotate(180deg);}
    .week-card .wc-body{
      padding: 0 12px 12px;
      display:grid;
      gap: 8px;
    }
    .day-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.40);
    }
    html[data-theme="dark"] .day-row{background: rgba(0,0,0,0.12);}
    .day-left{display:flex; flex-direction:column; gap:3px; min-width:0;}
    .day-name{font-weight: 1000; font-size: 12px;}
    .day-date{font-size: 11px; color: var(--muted);}
    .day-right{display:flex; flex-direction:column; align-items:center; gap:4px;}
    .day-time{font-weight: 1000; font-size: 12px;}
    .holiday-name{font-size: 10px; font-weight: 900; color: var(--danger);}


    .matrix-container{
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(10, 18, 25, 0.78);
      box-shadow: 0 18px 30px rgba(0,0,0,0.32);
      overflow-x: auto;
      overflow-y: visible; /* la pagina scorre ovunque */
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x pan-y;
      position: relative;
      padding: 10px 12px; /* crea spazio e arrotonda visivamente l'intestazione */
    }

    table.matrix-table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 820px;
      font-size: 13px;
      color: var(--text);
    }
    .matrix-table th, .matrix-table td{
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      border-right: 1px solid rgba(255,255,255,0.04);
      vertical-align: middle;
      background: transparent;
      text-align: center;
    }
    .matrix-table thead{background:transparent;}
    .matrix-table th{
      font-size: 14px;
      text-transform: none;
      letter-spacing: 0.2px;
      color: var(--muted);
      font-weight: 1000;
      position: sticky;
      top: 0;
      z-index: 3;
      background: linear-gradient(90deg, rgba(96,165,250,0.95), rgba(139,92,246,0.95));
      color: rgba(255,255,255,0.96);
      backdrop-filter: blur(6px);
      padding-top: 18px;
      padding-bottom: 18px;
    }
    /* Rounded corners for the table header to match container */
    .matrix-table thead th:first-child{ border-top-left-radius: 12px; }
    .matrix-table thead th:last-child{ border-top-right-radius: 12px; }
    .matrix-table th:first-child{
      left: 0;
      z-index: 4;
    }
    .matrix-table td:first-child{
      position: sticky;
      left: 0;
      z-index: 2;
      background: linear-gradient(180deg, rgba(16,18,25,0.95), rgba(30,35,42,0.9));
      backdrop-filter: none;
      min-width: 220px;
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      border-right: 1px solid rgba(255,255,255,0.04);
    }
    .matrix-table tr:last-child td{border-bottom: 0;}
    .matrix-table th:last-child, .matrix-table td:last-child{border-right: 0;}

    /* Reduce contrast dimming — keep rows readable */
    .row-dim{opacity: 1;}
    /* In dark theme keep a slight dim to de-emphasize but readable */
    html[data-theme="dark"] .row-dim{opacity: 0.75;}
    .week-label{
      display:block; /* single-line label for table column */
      text-align:center;
      font-weight: 900;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.6px;
      color: var(--muted);
      padding: 6px 8px;
    }
    .matrix-table td:first-child .week-label{display:block;}
    .week-label small{display:none !important;}    

    .cell{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-height: 44px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      width: fit-content;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      font-weight: 1000;
      font-size: 12px;
    }
    html[data-theme="dark"] .pill{background: rgba(0,0,0,0.18);}
    .pill.work{border-color: rgba(92,155,255,0.40);}
    .pill.rest{border-color: rgba(245,158,11,0.40);}
    
    /* In tema scuro: badge LIBERO rossi (come festività) */
    html[data-theme="dark"] .pill.rest{
      border-color: rgba(225,29,72,0.60);
      background: rgba(225,29,72,0.12);
    }
    html[data-theme="dark"] .pill.rest .dot{background: rgba(225,29,72,0.95);}
.pill.holiday{border-color: rgba(225,29,72,0.42);
      font-size: 11px;
      padding: 4px 8px;
    }
    .pill .dot{width:8px; height:8px; border-radius: 999px; background: rgba(92,155,255,0.95);}
    .pill.rest .dot{background: rgba(245,158,11,0.95);}
    .pill.holiday .dot{background: rgba(225,29,72,0.95);}
    .time-red{color: var(--danger);}

    /* Mobile: disable sticky to avoid "layer" feel; let the page scroll anywhere */
    @media (max-width: 720px){
      table.matrix-table{min-width: 720px;}
      .matrix-table th, .matrix-table td{position: static !important; backdrop-filter: none !important;}
      .matrix-table th{background: transparent !important;}
      .matrix-table td:first-child{background: transparent !important;}
      .card{backdrop-filter: none;}
      .topbar{backdrop-filter: none;}
    }

    /* Bottom bar */
    .bottom-bar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 90;
      padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,0.10);
      backdrop-filter: blur(18px);
    }
    html[data-theme="dark"] .bottom-bar{background: rgba(0,0,0,0.25);}
    .bottom-bar__inner{
      max-width: 1100px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .cta{
      border: 0;
      border-radius: 18px;
      min-height: 52px;
      font-weight: 1000;
      color: #fff;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .cta:disabled{opacity: 0.55; cursor:not-allowed;}
    .cta-save{background: linear-gradient(135deg, rgba(20,184,166,0.95), rgba(92,155,255,0.92));}
    .cta-share{background: linear-gradient(135deg, rgba(92,155,255,0.95), rgba(123,97,255,0.92));}

    /* Toast */
    .toast{
      position: fixed;
      left: 14px;
      right: 14px;
      bottom: calc(92px + env(safe-area-inset-bottom));
      z-index: 250;
      background: rgba(0,0,0,0.70);
      color: #fff;
      padding: 12px 12px;
      border-radius: 16px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      box-shadow: var(--shadow);
    }
    .toast.show{display:flex;}
    .toast small{opacity: 0.9;}
    .toast button{
      border: 0;
      background: rgba(255,255,255,0.18);
      color:#fff;
      font-weight: 900;
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 200;
      display:none;
      align-items: flex-end;
      justify-content: center;
      background: rgba(0,0,0,0.45);
      padding: 14px;
    }
    .modal.is-open{display:flex;}
    .modal-sheet{
      width: min(560px, 100%);
      border-radius: 22px;
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding: 14px 14px; border-bottom: 1px solid rgba(255,255,255,0.25);}
    html[data-theme="dark"] .modal-head{border-bottom: 1px solid rgba(255,255,255,0.10);}
    .modal-title{font-weight: 1000;}
    .modal-list{max-height: 60vh; overflow:auto; -webkit-overflow-scrolling:touch; padding: 10px;}
    .modal-item{
      width:100%;
      min-height: 46px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.62);
      color: var(--text);
      font-weight: 900;
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:center;
      padding: 10px 12px;
      cursor:pointer;
      margin-bottom: 10px;
    }
    .modal-item .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      line-height: 1.25;
    }
    html[data-theme="dark"] .modal-item{background: rgba(16,18,27,0.60); border: 1px solid rgba(255,255,255,0.10);}
    .modal-item[aria-current="true"]{outline: 2px solid rgba(92,155,255,0.55);}

    /* Export cleanup */
    .export-root{
      background: #fff;
      color: #111;
      padding: 18px;
      border-radius: 14px;
      width: fit-content;
    }
    .export-root .matrix-table{min-width: 0; width: auto;}
    .export-root .matrix-table th,
    .export-root .matrix-table td{position: static !important; backdrop-filter: none !important;}
    .export-root .matrix-container{overflow: visible !important; border: 1px solid #e5e7eb; background: #fff;}
    .export-root .row-dim{opacity: 1;}
    .export-root .pill{background: #f8fafc; border: 1px solid #e5e7eb;}
    .export-root .pill.work{border-color: rgba(59,130,246,0.50);}
    .export-root .pill.rest{border-color: rgba(245,158,11,0.50);}
    .export-root .pill.holiday{border-color: rgba(225,29,72,0.60);}
    .export-root .time-red{color: #b91c1c;}

    /* Export: vista schede */
    .export-root .week-card{background:#fff; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:10px; overflow:hidden;}
    .export-root .week-card summary{padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .export-root .wc-title{font-weight:900; font-size:13px; color:#0b1020;}
    .export-root .wc-sub{font-size:11px; color:#64748b; margin-top:2px;}
    .export-root .chev{display:none;}
    .export-root .wc-body{padding:0 12px 12px; display:grid; gap:8px;}
    .export-root .day-row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc;}
    .export-root .day-name{font-weight:900; font-size:12px; color:#0b1020;}
    .export-root .day-date{font-size:11px; color:#64748b;}
    .export-root .day-time{font-size:12px; font-weight:900; color:#0b1020; text-align:center;}
    .export-root .time-start{font-weight:900;}
    .export-root .time-end{font-size:11px; font-weight:700; color:#64748b;}
    .export-root .holiday-name{font-size:10px; font-weight:900; color:#b91c1c; text-align:center; margin-top:4px;}

    /* Export: vista calendario */
    .export-root .cal-month{background:#fff; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:14px; overflow:hidden;}
    .export-root .cal-month-title{font-weight:900; font-size:13px; padding:10px 12px; border-bottom:1px solid #e5e7eb; background:#f1f5f9; color:#0b1020;}
    .export-root .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); border-top:1px solid #e5e7eb;}
    .export-root .cal-dow{text-align:center; font-size:11px; font-weight:900; color:#64748b; padding:6px 2px; border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; background:#f8fafc;}
    .export-root .cal-dow:last-child{border-right:0;}
    .export-root .cal-cell{min-height:60px; padding:5px 4px; border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; display:flex; flex-direction:column; gap:2px;}
    .export-root .cal-cell:nth-child(7n){border-right:0;}
    .export-root .cal-cell.cal-empty{background:#fafafa;}
    .export-root .cal-cell.cal-rest{background:#fff5f5;}
    .export-root .cal-cell.cal-holiday{background:#fff1f1;}
    .export-root .cal-day-num{font-size:11px; font-weight:900; color:#64748b;}
    .export-root .cal-time{font-size:12px; font-weight:900; color:#0b1020;}
    .export-root .cal-time.time-red{color:#b91c1c;}
    .export-root .cal-time-end{font-size:11px; color:#64748b;}
    .export-root .cal-libero{font-size:11px; font-weight:900; color:#b91c1c;}
    .export-root .cal-hname{font-size:10px; font-weight:900; color:#b91c1c; line-height:1.2;}

    /* --- Classic dark look (as screenshot) --- */
    .hint-strip{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(220, 230, 238, 0.75);
      color: rgba(10,16,26,0.78);
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
      margin: 10px 0 14px;
      font-weight: 700;
    }
    html[data-theme="dark"] .hint-strip{
      background: rgba(210, 220, 228, 0.55);
      color: rgba(255,255,255,0.80);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .hint-strip i{color: #fb923c;}

    .select-like{
      width:100%;
      min-height: 50px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(10, 18, 25, 0.55);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 14px;
      font-weight: 800;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* Hide the settings helper text as requested */
    .card-sub{display:none !important;}
    .card-title{display:none !important;}
    .hint-strip{display:none !important;}
    .select-like:disabled{opacity: 0.55; cursor:not-allowed;}
    .select-like__left{display:flex; align-items:center; gap: 10px; min-width:0;}
    .select-like__left span{white-space:nowrap; overflow:hidden; text-overflow: ellipsis;}
    .select-like i{opacity: 0.9;}

    .row-actions{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 14px;
    }
    .ok-btn{
      flex: 1 1 auto;
      min-height: 56px;
      border-radius: 16px;
      border: 0;
      background: linear-gradient(90deg, #4f46e5, #06b6d4);
      color: white;
      font-weight: 900;
      letter-spacing: 0.4px;
      box-shadow: 0 14px 30px rgba(79,70,229,0.14);
    }
    .ok-btn:disabled{filter: grayscale(0.2); opacity: 0.55;}
    .btn:focus-visible, .ok-btn:focus-visible{ outline: 3px solid rgba(59,130,246,0.28); outline-offset: 3px; }
    .ok-btn:disabled{filter: grayscale(0.2); opacity: 0.55;}
    .row-actions .icon-btn{
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: rgba(10, 18, 25, 0.45);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }

    /* controls grid like screenshot */
    @media(min-width: 820px){
      .controls-grid{grid-template-columns: 1.1fr 1fr 1fr;}
    }

    /* table look (applied only in dark theme) */
    html[data-theme="dark"] .matrix-container{
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      background: rgba(10, 18, 25, 0.70);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      box-shadow: 0 18px 30px rgba(0,0,0,0.28);
      touch-action: pan-x pan-y;
    }
    html[data-theme="dark"] table.matrix-table{min-width: 780px;}
    html[data-theme="dark"] .matrix-table th{
      color: rgba(255,255,255,0.92);
      font-weight: 900;
      background: linear-gradient(90deg, rgba(96,165,250,0.85), rgba(139,92,246,0.85));
      border-right: 1px solid rgba(255,255,255,0.12);
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    html[data-theme="dark"] .matrix-table td{
      background: rgba(11, 18, 25, 0.40);
      color: rgba(255,255,255,0.88);
      border-right: 1px solid rgba(255,255,255,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    html[data-theme="dark"] .matrix-table tr:nth-child(even) td{background: var(--table-zebra);}    
    html[data-theme="dark"] .week-label{display:block; font-weight: 900;}
    html[data-theme="dark"] .week-label small{display:block; margin-top: 6px; font-weight: 800; color: rgba(255,255,255,0.58);}
    html[data-theme="dark"] .cell-stack{display:flex; flex-direction:column; gap: 10px; align-items:center; justify-content:center; padding: 8px 0;}
    html[data-theme="dark"] .cell-time{font-weight: 900;}
    /* Increase table row height and emphasize time */
    .matrix-table td .cell-stack{ min-height: 64px; padding-top: 6px; padding-bottom: 6px; }
    .matrix-table .cell-time, .matrix-table .day-time{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size: 14px;
      text-align: center;
      line-height: 1.1;
    }
    .matrix-table .cell-time .time-start,
    .matrix-table .day-time .time-start{ font-weight: 900; }
    .matrix-table .cell-time .time-end,
    .matrix-table .day-time .time-end{ color: var(--muted); font-size: 13px; font-weight: 700; }
    /* Ensure pill badges and other inline elements are centered */
    .matrix-table .pill, .matrix-table .cell-stack{ display:flex; align-items:center; justify-content:center; }
    /* Force vertical stacking inside table cells: time above, holiday name below */
    .matrix-table .cell-stack{ flex-direction: column !important; }
    .matrix-table .cell-time{ display:flex; flex-direction:column; align-items:center; }
    .matrix-table .holiday-name{ display:block; width:100%; text-align:center; margin-top:6px; }
    html[data-theme="dark"] .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height: 30px;
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      letter-spacing: 0.4px;
      border: 0;
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.94);
    }
    html[data-theme="dark"] .pill.rest{
      background: linear-gradient(180deg, rgba(239,68,68,0.95), rgba(239,68,68,0.85));
      color: #fff;
      box-shadow: 0 6px 14px rgba(239,68,68,0.12) inset;
    }
    html[data-theme="dark"] .pill.work{
      background: rgba(255,255,255,0.08);
    }
    html[data-theme="dark"] .pill.holiday{
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.40);
    }
    html[data-theme="dark"] .time-red{color: #fecaca; font-weight: 900;}
    @media (max-width: 720px){
      /* su mobile: niente sticky e niente “vetro” */
      .card{backdrop-filter: none;}
      .topbar{backdrop-filter: none;}
    }

  
    #refHintRow, #hoursHintRow{display:none !important;}

    .spacer-8{ height:8px; }

    /* Accessibilità: testo solo per screen reader */
    .sr-only{
      position:absolute;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    /* Nasconde “Settimana X” ovunque */
    .week-label small{display:none !important;}

    /* Festività: nome in rosso più piccolo */
    .holiday-name{
      font-size: 11px;
      font-weight: 900;
      color: var(--danger);
      line-height: 1.1;
      letter-spacing: 0.1px;
    }
    /* Force holiday name below times and centered (cards) */
    .day-right .holiday-name{ display:block; width:100%; text-align:center; margin-top:6px; }

    /* Light theme overrides: keep preview and controls clean and high-contrast */
    html[data-theme="light"] .matrix-container{
      background: var(--table-bg);
      border: 1px solid rgba(11,16,32,0.06);
      box-shadow: var(--shadow-soft);
      padding: 8px;
    }
    html[data-theme="light"] table.matrix-table{min-width: 780px;}
    html[data-theme="light"] .matrix-table th{
      color: var(--text);
      font-weight: 900;
      background: linear-gradient(90deg, rgba(92,155,255,0.10), rgba(123,97,255,0.06));
      border-right: 1px solid rgba(11,16,32,0.06);
      border-bottom: 1px solid rgba(11,16,32,0.04);
    }
    html[data-theme="light"] .matrix-table td{
      background: var(--table-bg);
      color: var(--text);
      border-right: 1px solid rgba(11,16,32,0.04);
      border-bottom: 1px solid rgba(11,16,32,0.03);
    }
    html[data-theme="light"] .matrix-table tr:nth-child(even) td{background: var(--table-zebra);}    
    html[data-theme="light"] .matrix-table td:first-child{
      background: var(--table-bg);
      color: var(--text);
      font-weight: 800;
      border-right: 1px solid rgba(11,16,32,0.06);
    }
    html[data-theme="light"] .pill{
      background: #f1f5f9;
      color: var(--text);
      border: 1px solid rgba(11,16,32,0.06);
    }
    html[data-theme="light"] .pill.rest{
      background: #fff5f5;
      color: #b91c1c;
      border: 1px solid rgba(239,68,68,0.12);
    }
    html[data-theme="light"] .select-like{
      background: var(--card);
      border: 1px solid rgba(11,16,32,0.06);
      color: var(--text);
    }
    html[data-theme="light"] .card{ background: var(--card); }
    html[data-theme="light"] .topbar{ background: var(--card); border:1px solid rgba(11,16,32,0.04); }


    /* Responsive: piccoli schermi - rendi i pulsanti più compatti */
    @media (max-width: 520px){
      .topbar{ padding:8px 12px; }
      .top-actions{ gap:10px; }
      .icon-btn{ width:36px; height:36px; border-radius:10px; font-size:14px; }
      .icon-btn i{ font-size:16px; }
      .brand-icon{ width:36px; height:36px; border-radius:10px; }
      .top-actions .label{ display:none; }
      .brand h1{ font-size:14px; }
    }

    /* Evidenzia riga/cella corrente nella tabella */
    .matrix-table tr.row-today > td { background: rgba(92,155,255,0.08) !important; }
    html[data-theme="dark"] .matrix-table tr.row-today > td { background: rgba(92,155,255,0.12) !important; }
    .matrix-table td.cell-today { outline: 2px solid var(--accent); outline-offset: -3px; border-radius: 4px; }

    /* Weekend non-riposo nel calendario */
    .cal-cell.cal-weekend { background: rgba(11,16,32,0.03); }
    html[data-theme="dark"] .cal-cell.cal-weekend { background: rgba(255,255,255,0.03); }

    /* Filtro rapido mese nel calendario */
    .cal-month-filter {
      display: flex; gap: 8px; overflow-x: auto; padding: 2px 2px 10px;
      -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .cal-month-filter::-webkit-scrollbar { display: none; }
    .cal-month-pill {
      flex: 0 0 auto;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.35);
      color: var(--text);
      font-size: 12px; font-weight: 900;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    html[data-theme="dark"] .cal-month-pill { background: rgba(0,0,0,0.20); }
    .cal-month-pill.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* Indicatore vista attiva sotto il tasto */
    .ctrl .label { transition: color 0.2s; }

    /* Calendario responsivo su schermi piccoli */
    @media (max-width: 480px) {
      .cal-cell { min-height: 52px; padding: 4px 3px; }
      .cal-day-num { font-size: 10px; }
      .cal-time { font-size: 11px; }
      .cal-time-end { font-size: 10px; }
      .cal-libero { font-size: 10px; }
      .cal-hname { font-size: 9px; }
      .cal-dow { font-size: 10px; padding: 6px 2px; }
      .cal-month-title { font-size: 13px; }
    }
    @media (max-width: 360px) {
      .calendar-wrap { overflow-x: auto; }
      .cal-grid { min-width: 320px; }
    }

    /* CSS Stampa */
    @media print {
      body { background: #fff !important; padding: 0 !important; padding-bottom: 0 !important; }
      .topbar, .bottom-bar, #bottomBar, .toast, .card-head button, #generateBtn, #resetBtn, .row-actions { display: none !important; }
      .card:first-child .card-body { display: none !important; }
      .app-shell { padding-top: 0 !important; }
      .card { box-shadow: none !important; border: 1px solid #e5e7eb !important; background: #fff !important; backdrop-filter: none !important; }
      .preview-wrap { display: block !important; }
      #matrixTableWrap, #matrixCardsWrap, #matrixCalendarWrap { display: none !important; }
      #matrixTableWrap.print-show, #matrixCardsWrap.print-show, #matrixCalendarWrap.print-show { display: block !important; }
      .matrix-container { overflow: visible !important; box-shadow: none !important; border: 1px solid #e5e7eb !important; }
      .matrix-table th, .matrix-table td { position: static !important; backdrop-filter: none !important; }
      .matrix-table th { background: #f1f5f9 !important; color: #0b1020 !important; }
      .matrix-table td { background: #fff !important; color: #0b1020 !important; }
      .week-card { break-inside: avoid; }
      .cal-month { break-inside: avoid; margin-bottom: 8px; }
      .cal-month-filter { display: none !important; }
    }

</style>
</head>

<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="brand">
        <div class="brand-icon" aria-hidden="true"></div>
        <!-- Titolo rimosso -->
      </div>

      <div class="top-actions" role="group" aria-label="Azioni principali">
        <div class="ctrl">
          <button class="icon-btn" id="viewToggle" type="button" aria-label="Cambia vista">
            <i class="fa-solid fa-layer-group"></i>
          </button>
          <span class="label" id="viewLabel">Tabella</span>
        </div>
        <div class="ctrl">
          <button class="icon-btn" id="todayBtn" type="button" aria-label="Vai ad oggi">
            <i class="fa-solid fa-calendar-day"></i>
          </button>
          <span class="label">Oggi</span>
        </div>
        <div class="ctrl">
          <button class="icon-btn" id="themeToggle" type="button" aria-label="Tema">
            <i class="fa-solid fa-gear"></i>
          </button>
          <span class="label">Tema</span>
        </div>
        <div class="ctrl">
          <button class="icon-btn" id="saveTopBtn" type="button" title="Salva immagine matrice" aria-label="Salva" onclick="document.getElementById('savePngBtn').click()"><i class="fa-solid fa-download"></i></button>
          <span class="label">Salva</span>
        </div>
        <div class="ctrl">
          <button class="icon-btn" id="shareTopBtn" type="button" title="Condividi" aria-label="Condividi" onclick="document.getElementById('shareBtn').click()"><i class="fa-solid fa-share-nodes"></i></button>
          <span class="label">Share</span>
        </div>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Impostazioni</div>
            <div class="card-sub">Compila i riferimenti e premi OK per generare le 18 settimane.</div>
          </div>
        </div>
        <div class="card-body">
          <div class="hint-strip"><i class="fa-solid fa-circle-info"></i><span>1) Seleziona il <b>monte ore</b> • 2) scegli <b>mese</b>, <b>settimana</b> e <b>opzione orario</b> • 3) premi <b>OK</b>.</span></div>

          <div class="controls-grid">
            <div style="grid-column: 1 / -1;">
              <span class="control-label">Tipo operatore</span>
              <div class="segmented" id="roleSegment" role="group" aria-label="Tipo operatore">
                <button type="button" data-role="dipendente" aria-pressed="false">Dipendente</button>
                <button type="button" data-role="tutor" aria-pressed="false">Tutor</button>
              </div>

              <div class="spacer-8"></div>
              <span class="control-label">Monte ore giornaliero</span>
              <div class="segmented" id="hoursSegment" role="group" aria-label="Ore giornaliere">
                <button type="button" data-hours="4h" aria-pressed="false">4h</button>
                <button type="button" data-hours="6h" aria-pressed="false">6h</button>
                <button type="button" data-hours="6h40" aria-pressed="false">6h 40m</button>
                <button type="button" data-hours="7h55" aria-pressed="false">7h 55m</button>
              </div>
              <div class="hint-row" id="hoursHintRow" style="display:none;">
                <span class="hint-pill"><i class="fa-solid fa-clock"></i> <span id="hoursHint"></span></span>
              </div>
            </div>

            <div>
              <span class="control-label">Mese di partenza</span>
              <button class="select-like" id="monthBtn" type="button" disabled>
                <span class="select-like__left"><i class="fa-solid fa-calendar-days"></i><span id="monthBtnLabel">Seleziona mese</span></span>
                <i class="fa-solid fa-chevron-down"></i>
              </button>
            </div>

            <div>
              <span class="control-label">Settimana di partenza</span>
              <button class="select-like" id="weekBtn" type="button" disabled>
                <span class="select-like__left"><span id="weekBtnLabel">Seleziona settimana</span></span>
                <i class="fa-solid fa-chevron-down"></i>
              </button>
            </div>

            <div style="grid-column: 1 / -1;">
              <span class="control-label">Orario e riposi (della settimana selezionata)</span>
              <button class="select-like" id="optionBtn" type="button" disabled>
                <span class="select-like__left"><span id="optionLabel">Seleziona orario</span></span>
                <i class="fa-solid fa-chevron-down"></i>
              </button>
              <div class="hint-row" id="refHintRow" style="display:none;">
                <span class="hint-pill"><i class="fa-solid fa-anchor"></i> <span id="refHint"></span></span>
              </div>
            </div>
          </div>

          <div class="row-actions">
            <button class="btn ok-btn" id="generateBtn" type="button" disabled><i class="fa-solid fa-check"></i> OK</button>
            <button class="icon-btn" id="resetBtn" type="button" aria-label="Reset"><i class="fa-solid fa-rotate-left"></i></button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Anteprima</div>
            <div class="card-sub">Festività in rosso con nome.</div>
          </div>
        </div><button class="icon-btn" id="previewTopBtn" type="button" aria-label="Torna su"><i class="fa-solid fa-arrow-up"></i></button>
        <div class="card-body">
          <div class="preview-wrap" id="previewWrap">
            <div class="matrix-container" id="matrixTableWrap" aria-label="Matrice orari"></div>
            <div class="cards-wrap" id="matrixCardsWrap" aria-label="Matrice (schede)" style="display:none;"></div>
            <div class="calendar-wrap" id="matrixCalendarWrap" aria-label="Matrice (calendario)" style="display:none;"></div>
          </div>

          <div id="emptyPreview" class="note" style="margin-top:2px; display:none;">
            <i class="fa-regular fa-eye-slash"></i>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="bottom-bar" id="bottomBar" style="display:none;">
    <div class="bottom-bar__inner" style="display:none;">
      <button class="cta cta-save" id="savePngBtn" disabled style="display:none;"><i class="fa-solid fa-download"></i> Salva PNG</button>
      <button class="cta cta-share" id="shareBtn" disabled style="display:none;"><i class="fa-solid fa-share-nodes"></i> Condividi</button>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="monthModal" role="dialog" aria-modal="true" aria-labelledby="monthTitle">
    <div class="modal-sheet">
      <div class="modal-head">
        <div class="modal-title" id="monthTitle">Seleziona mese di partenza</div>
        <button class="icon-btn" id="closeMonthModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-list" id="monthList"></div>
    </div>
  </div>

  <div class="modal" id="weekModal" role="dialog" aria-modal="true" aria-labelledby="weekTitle">
    <div class="modal-sheet">
      <div class="modal-head">
        <div class="modal-title" id="weekTitle">Seleziona settimana</div>
        <button class="icon-btn" id="closeWeekModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-list" id="weekList"></div>
    </div>
  </div>

  <div class="modal" id="optionModal" role="dialog" aria-modal="true" aria-labelledby="optionTitle">
    <div class="modal-sheet">
      <div class="modal-head">
        <div class="modal-title" id="optionTitle">Seleziona opzione orario</div>
        <button class="icon-btn" id="closeOptionModal" aria-label="Chiudi"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-list" id="optionList"></div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div>
      <div style="font-weight:900" id="toastTitle">Ok</div>
      <small id="toastMsg"></small>
    </div>
    <button id="toastClose" type="button">Chiudi</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    // --------- Micro feedback ---------
    const clickAudio = (() => {
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        return { ctx };
      } catch(e){ return null; }
    })();

    function playClickSound(){
      if(!clickAudio || !clickAudio.ctx) return;
      const ctx = clickAudio.ctx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 420;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.06, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
      o.start(now);
      o.stop(now + 0.1);
    }

    function addRipple(el, x, y){
      const r = document.createElement('span');
      r.className = 'ripple';
      const rect = el.getBoundingClientRect();
      r.style.left = (x - rect.left) + 'px';
      r.style.top = (y - rect.top) + 'px';
      el.appendChild(r);
      setTimeout(() => r.remove(), 650);
    }

    function toast(title, msg){
      const t = document.getElementById('toast');
      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastMsg').textContent = msg || '';
      t.classList.add('show');
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=>t.classList.remove('show'), 2600);
    }
    document.getElementById('toastClose').addEventListener('click', ()=>document.getElementById('toast').classList.remove('show'));

    

    // --------- Safe storage (no-crash) ---------
    const localStorage = (()=>{
      try{
        const ls = window.localStorage;
        const k = '__matrice_test__';
        ls.setItem(k, '1');
        ls.removeItem(k);
        return ls;
      } catch(e){
        const mem = new Map();
        return {
          getItem: (k)=> mem.has(k) ? mem.get(k) : null,
          setItem: (k,v)=> { mem.set(k, String(v)); },
          removeItem: (k)=> { mem.delete(k); },
        };
      }
    })();

    function safeStorageGet(key){
      try{ return localStorage.getItem(key); } catch(e){ return null; }
    }
    function safeStorageSet(key, value){
      try{ localStorage.setItem(key, String(value)); } catch(e){}
    }
    function safeStorageRemove(key){
      try{ localStorage.removeItem(key); } catch(e){}
    }
// --------- Data ---------
    const BASE_START_ISO = '2026-02-16'; // lunedì: data fissa di partenza della tabella (18 settimane)
    const DAYS = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];

    // Pattern fisso (18 settimane) - ordine del ciclo
    const DIPENDENTE_PATTERN = [
      { startTime: '14:00', restDays: ['Lun','Dom'] },
      { startTime: '06:00', restDays: ['Mer','Sab'] },
      { startTime: '13:30', restDays: ['Ven','Sab'] },
      { startTime: '15:30', restDays: ['Mar','Dom'] },
      { startTime: '09:30', restDays: ['Gio','Dom'] },
      { startTime: '12:00', restDays: ['Sab','Dom'] },
      { startTime: '14:30', restDays: ['Lun','Dom'] },
      { startTime: '08:00', restDays: ['Mer','Sab'] },
      { startTime: '14:00', restDays: ['Ven','Sab'] },
      { startTime: '16:00', restDays: ['Mar','Dom'] },
      { startTime: '09:30', restDays: ['Gio','Dom'] },
      { startTime: '12:30', restDays: ['Sab','Dom'] },
      { startTime: '15:00', restDays: ['Lun','Dom'] },
      { startTime: '08:30', restDays: ['Mer','Sab'] },
      { startTime: '14:30', restDays: ['Ven','Sab'] },
      { startTime: '18:00', restDays: ['Mar','Dom'] },
      { startTime: '10:00', restDays: ['Gio','Dom'] },
      { startTime: '13:00', restDays: ['Sab','Dom'] }
    ];

    // Eccezioni richieste (giorni specifici nella settimana) - indice nel PATTERN (0..17)
    const DIPENDENTE_SPECIAL_START_OVERRIDES = {
      12: { Sab: '18:00' },          // 15:00 (Lun,Dom) -> Sab 18:00
      13: { Dom: '10:00' },          // 08:30 (Mer,Sab) -> Dom 10:00
      14: { Dom: '18:00' },          // 14:30 (Ven,Sab) -> Dom 18:00
      15: { Sab: '12:00' },          // 18:00 (Mar,Dom) -> Sab 12:00
      16: { Sab: '09:00' },          // 10:00 (Gio,Dom) -> Sab 09:00
      0:  { Sab: '14:00' },          // 14:00 (Lun,Dom) -> Sab 14:00 (già uguale, ma esplicito)
      1:  { Dom: '06:00' },          // 06:00 (Mer,Sab) -> Dom 06:00
      2:  { Dom: '14:00' },          // 13:30 (Ven,Sab) -> Dom 14:00
      3:  { Sab: '10:00' },          // 15:30 (Mar,Dom) -> Sab 10:00
      4:  { Sab: '06:00' },          // 09:30 (Gio,Dom) -> Sab 06:00
      6:  { Sab: '16:00' },          // 14:30 (Lun,Dom) -> Sab 16:00
      7:  { Dom: '09:00' },          // 08:00 (Mer,Sab) -> Dom 09:00
      8:  { Dom: '16:00' },          // 14:00 (Ven,Sab) -> Dom 16:00
      9:  { Sab: '11:00' },          // 16:00 (Mar,Dom) -> Sab 11:00
      10: { Sab: '08:00' },          // 09:30 (Gio,Dom) -> Sab 08:00 (seconda occorrenza)
    };

    // Pattern Tutor (15 opzioni) — ciclo ripetuto per riempire 18 settimane
    const TUTOR_PATTERN = [
      { startTime: '12:00', restDays: ['Mer','Sab'], overrides: { Dom: '12:00' } },
      { startTime: '06:00', restDays: ['Mar','Sab'], overrides: { Dom: '06:00' } },
      { startTime: '18:00', restDays: ['Mer','Dom'], overrides: { Sab: '18:00' } },
      { startTime: '15:00', restDays: ['Sab','Dom'] },
      { startTime: '06:00', restDays: ['Gio','Dom'], overrides: { Sab: '06:00' } },
      { startTime: '18:00', restDays: ['Lun','Sab'], overrides: { Dom: '18:00' } },
      { startTime: '12:00', restDays: ['Mar','Dom'], overrides: { Sab: '12:00' } },
      { startTime: '08:00', restDays: ['Sab','Dom'] },
      { startTime: '18:00', restDays: ['Mar','Sab'], overrides: { Dom: '18:00' } },
      { startTime: '12:00', restDays: ['Lun','Sab'], overrides: { Dom: '12:00' } },
      { startTime: '06:00', restDays: ['Mer','Dom'], overrides: { Sab: '06:00' } },
      { startTime: '11:00', restDays: ['Sab','Dom'] },
      { startTime: '12:00', restDays: ['Gio','Dom'], overrides: { Sab: '12:00' } },
      { startTime: '06:00', restDays: ['Lun','Sab'], overrides: { Dom: '06:00' } },
      { startTime: '18:00', restDays: ['Gio','Dom'], overrides: { Sab: '18:00' } },
    ];
    const TOTAL_WEEKS_MAP = { dipendente: 18, tutor: 15 };
    function totalWeeksForRole(role){ return TOTAL_WEEKS_MAP[role] || 18; }

    // Per il tutor: conta le settimane dalla settimana di partenza fino al 31 dic dell'anno selezionato
    function computeTutorWeekCount(startISO){
      const start = parseISODate(startISO);
      const year = start.getFullYear();
      const endOfYear = new Date(year, 11, 31);
      let count = 0;
      let cur = new Date(start.getTime());
      while(cur <= endOfYear){
        count++;
        cur = addDays(cur, 7);
      }
      return Math.max(count, 1);
    }

    // Restituisce il totale settimane in base a ruolo e stato corrente
    // Per entrambi i ruoli: settimane dalla partenza fino al 31 dic dell'anno selezionato
    function computeTotalWeeks(){
      if(state.startWeekISO){
        return computeTutorWeekCount(state.startWeekISO);
      }
      return totalWeeksForRole(state.role);
    }

    // Ruolo attivo (Dipendente/Tutor) — determina pattern e opzioni
    let activeRole = 'dipendente';
    let ACTIVE_PATTERN = DIPENDENTE_PATTERN;
    let ACTIVE_SPECIAL_OVERRIDES = DIPENDENTE_SPECIAL_START_OVERRIDES;

    function setActiveRole(role){
      activeRole = (role === 'tutor') ? 'tutor' : 'dipendente';
      ACTIVE_PATTERN = (activeRole === 'tutor') ? TUTOR_PATTERN : DIPENDENTE_PATTERN;
      ACTIVE_SPECIAL_OVERRIDES = (activeRole === 'tutor') ? {} : DIPENDENTE_SPECIAL_START_OVERRIDES;
    }


    // Durate (minuti) — 6.4h => 6h40m, 7,55h => 7h55m
    const DURATIONS = {
      '4h': 240,
      '6h': 360,
      '6h40': 400,
      '7h55': 475,
    };

    function prettyDuration(key){
      const map = { '4h':'4h', '6h':'6h', '6h40':'6h 40m', '7h55':'7h 55m' };
      return map[key] || key || '';
    }


    // --------- Helpers ---------
    function parseISODate(iso){
      const [y,m,d] = String(iso).split('-').map(Number);
      return new Date(y, (m||1)-1, d||1);
    }
    function pad2(n){return String(n).padStart(2,'0');}
    function isoDate(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
    function addDays(date, days){
      const d = new Date(date.getTime());
      d.setDate(d.getDate()+days);
      return d;
    }
    function timeToMinutes(t){
      const [hh,mm] = String(t).split(':').map(Number);
      return (hh||0)*60 + (mm||0);
    }
    function minutesToTime(m){
      m = ((m%1440)+1440)%1440;
      const hh = Math.floor(m/60);
      const mm = m%60;
      return `${pad2(hh)}:${pad2(mm)}`;
    }
    function addMinutesToTimeStr(t, minutes){
      return minutesToTime(timeToMinutes(t) + minutes);
    }
    function weekLabel(startDate){
      const endDate = addDays(startDate, 6);
      const options = { day: '2-digit', month: 'short' };
      const startStr = startDate.toLocaleDateString('it-IT', options);
      const endStr = endDate.toLocaleDateString('it-IT', options);
      return `${startStr} – ${endStr}`;
    }

    function timeStrToMinutes(t){
      const parts = String(t||'').split(':');
      const h = parseInt(parts[0]||'0', 10);
      const m = parseInt(parts[1]||'0', 10);
      return (h*60) + m;
    }
    function minutesToTimeStr(min){
      min = ((min % 1440) + 1440) % 1440;
      const h = Math.floor(min/60);
      const m = min % 60;
      return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    }
    function computeStartEnd(rawStart, durationMinutes){
      // Fine turno massimo: mezzanotte (00:00).
      // Per i turni "18:00" consideriamo la chiusura a mezzanotte e calcoliamo l'inizio in base al monte ore.
      if(!durationMinutes) return { start: rawStart, end: '' };

      const startStr = String(rawStart);
      if(startStr === '18:00'){
        const startMin = 1440 - durationMinutes;
        return { start: minutesToTimeStr(startMin), end: '00:00' };
      }

      const end = addMinutesToTimeStr(startStr, durationMinutes);
      // Se attraversa la mezzanotte, tronca a 00:00
      if(timeStrToMinutes(end) < timeStrToMinutes(startStr)){
        return { start: startStr, end: '00:00' };
      }
      return { start: startStr, end };
    }

    function fmtDayMonth(d){
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'][d.getMonth()];
      return `${dd} ${mm}`;
    }
    function restLabel(arr){
      return arr.join(', ');
    }

    // Easter / Easter Monday for a given year (Gregorian)
    function easterDate(year){
      // Anonymous Gregorian algorithm
      const a = year % 19;
      const b = Math.floor(year/100);
      const c = year % 100;
      const d = Math.floor(b/4);
      const e = b % 4;
      const f = Math.floor((b+8)/25);
      const g = Math.floor((b - f + 1)/3);
      const h = (19*a + b - d - g + 15) % 30;
      const i = Math.floor(c/4);
      const k = c % 4;
      const l = (32 + 2*e + 2*i - h - k) % 7;
      const m = Math.floor((a + 11*h + 22*l)/451);
      const month = Math.floor((h + l - 7*m + 114)/31); // 3=March, 4=April
      const day = ((h + l - 7*m + 114) % 31) + 1;
      return new Date(year, month-1, day);
    }

    
function buildHolidayMapForYear(year){
  const map = new Map();
  // Festività nazionali italiane (fisse)
  map.set(`${year}-01-01`, 'Capodanno');
  map.set(`${year}-01-06`, 'Epifania');
  map.set(`${year}-04-25`, 'Liberazione');
  map.set(`${year}-05-01`, 'Festa del Lavoro');
  map.set(`${year}-06-02`, 'Festa della Repubblica');
  map.set(`${year}-08-15`, 'Ferragosto');
  map.set(`${year}-11-01`, 'Ognissanti');
  map.set(`${year}-12-08`, 'Immacolata Concezione');
  map.set(`${year}-12-25`, 'Natale');
  map.set(`${year}-12-26`, 'Santo Stefano');

  // Pasquetta (Lunedì dell’Angelo)
  const easter = easterDate(year);
  const easterMonday = addDays(easter, 1);
  map.set(isoDate(easterMonday), 'Pasquetta');

  return map;
}

    function getDayStartTime(patternIndex, dayName){
      const len = ACTIVE_PATTERN.length || 1;
      const idx = ((patternIndex % len) + len) % len;
      const entry = ACTIVE_PATTERN[idx];
      const override = ((entry.overrides || {})[dayName]) || ((ACTIVE_SPECIAL_OVERRIDES[idx] || {})[dayName]);
      return override || entry.startTime;
    }

        function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

// --------- State ---------
    const state = {
      role: null, // 'dipendente' | 'tutor'
      durationKey: null,
      durationMinutes: null,
      startMonth: null,           // 0..11 (mese di partenza)
      startWeekISO: null,         // YYYY-MM-DD (lunedì della settimana di partenza)
      anchorPatternIndex: null,   // 0..17 (orario + riposi della settimana di partenza)
      generated: false,
      viewMode: 'table',
    };

    // --------- Matrix generation ---------
    function buildMatrixData(){
      const baseStart = state.startWeekISO ? parseISODate(state.startWeekISO) : parseISODate(BASE_START_ISO);
      const totalWeeks = computeTotalWeeks();

      // Holidays for years involved in the 18-week window
      const endWindow = addDays(baseStart, (totalWeeks - 1) * 7 + 6);
      const years = new Set();
      for(let y = baseStart.getFullYear(); y <= endWindow.getFullYear(); y++) years.add(y);
      const holidayMaps = {};
      years.forEach(y => holidayMaps[y] = buildHolidayMapForYear(y));

      const weeks = [];
      for (let weekIndex = 0; weekIndex < totalWeeks; weekIndex++){
        const weekStart = addDays(baseStart, weekIndex * 7);

        // La settimana di partenza usa l'opzione scelta; le successive avanzano nel ciclo (18)
        const patternIndex = (state.anchorPatternIndex !== null)
          ? (state.anchorPatternIndex + weekIndex) % ACTIVE_PATTERN.length
          : (weekIndex % ACTIVE_PATTERN.length);

        const pat = ACTIVE_PATTERN[patternIndex];

        const days = [];
        for (let dayIdx = 0; dayIdx < 7; dayIdx++){
          const dayName = DAYS[dayIdx];
          const dateObj = addDays(weekStart, dayIdx);

          const isRest = pat.restDays.includes(dayName);
          const rawStart = getDayStartTime(patternIndex, dayName);
          const se = computeStartEnd(rawStart, state.durationMinutes || 0);
          const start = se.start;
          const end = se.end;

          const y = dateObj.getFullYear();
          const holidayName = holidayMaps[y] ? holidayMaps[y].get(isoDate(dateObj)) : null;
          const isHoliday = !!holidayName;

          days.push({ dayName, dateObj, isRest, start, end, isHoliday, holidayName });
        }

        const inMonth = (state.startMonth === null)
          ? true
          : days.some(d => d.dateObj.getMonth() === state.startMonth);

        weeks.push({
          weekIndex,
          patternIndex,
          label: weekLabel(weekStart),
          weekStart,
          restDays: pat.restDays.slice(),
          baseStartTime: pat.startTime,
          inMonth,
          days,
        });
      }
      return weeks;
    }

    function renderTable(weeks){
      const wrap = document.getElementById('matrixTableWrap');
      const cols = ['Settimana', ...DAYS];
      const todayISO = isoDate(new Date());

      let html = '<div class="matrix-container"><table class="matrix-table" id="matrixTable"><thead><tr>';
      cols.forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';

      weeks.forEach(w => {
        const isRowToday = w.days.some(d => isoDate(d.dateObj) === todayISO);
        html += `<tr class="${w.inMonth ? '' : 'row-dim'}${isRowToday ? ' row-today' : ''}">`;
        html += `<td><span class="week-label"><span class="sr-only">Settimana ${w.weekIndex+1}</span>${w.label}</span></td>`;

        w.days.forEach(d => {
          const isToday = isoDate(d.dateObj) === todayISO;
          let cellHtml = `<div class="cell-stack">`;
          if (d.holidayName){
            cellHtml += `<div class="cell-time time-red"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
            cellHtml += `<div class="holiday-name">${d.holidayName}</div>`;
          } else if (d.isRest){
            cellHtml += `<div class="pill rest">LIBERO</div>`;
          } else {
            cellHtml += `<div class="cell-time"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
          }
          cellHtml += `</div>`;
          html += `<td${isToday ? ' class="cell-today"' : ''}>${cellHtml}</td>`;
        });

        html += '</tr>';
      });

      html += '</tbody></table></div>';
      wrap.innerHTML = html;
    }

    function renderCards(weeks){
      const wrap = document.getElementById('matrixCardsWrap');
      if(!wrap) return;
      const todayISO = isoDate(new Date());
      let html = '';
      weeks.forEach((w, idx)=>{
        const isWeekToday = w.days.some(d => isoDate(d.dateObj) === todayISO);
        const open = (idx === 0 || isWeekToday) ? ' open' : '';
        html += `<details class="week-card"${open}>`;
        html += `<summary>`;
        html += `<div class="wc-left"><div class="wc-title">${w.label}</div>`;
        html += `<div class="wc-sub">${w.inMonth ? 'Nel mese selezionato' : 'Fuori filtro mese'}</div></div>`;
        html += `<div class="chev"><i class="fa-solid fa-chevron-down"></i></div>`;
        html += `</summary>`;
        html += `<div class="wc-body">`;
        w.days.forEach(d=>{
          const dateTxt = fmtDayMonth(d.dateObj);
          const isToday = isoDate(d.dateObj) === todayISO;
          let right = '';
          if(d.holidayName){
            right = `<div class="day-time time-red"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div><div class="holiday-name">${escapeHtml(d.holidayName)}</div>`;
          } else if(d.isRest){
            right = `<div class="pill rest">LIBERO</div>`;
          } else {
            right = `<div class="day-time"><div class="time-start">${d.start}</div><div class="time-end">${d.end}</div></div>`;
          }
          html += `<div class="day-row ${w.inMonth ? '' : 'row-dim'}${isToday ? ' day-row-today' : ''}"` +
                  `${isToday ? ' style="outline:2px solid var(--accent);outline-offset:-2px;border-radius:14px;"' : ''}>` +
                  `<div class="day-left"><div class="day-name">${d.dayName}</div><div class="day-date">${dateTxt}</div></div>` +
                  `<div class="day-right">${right}</div>` +
                  `</div>`;
        });
        html += `</div></details>`;
      });
      wrap.innerHTML = html;
    }

    // --------- Render calendario ---------
    function renderCalendar(weeks){
      const wrap = document.getElementById('matrixCalendarWrap');
      if(!wrap) return;

      const todayISO = isoDate(new Date());
      const weekendDowIdx = new Set([5, 6]); // Sab=5, Dom=6 (da Lun=0)

      // Raggruppa i giorni per mese
      const monthMap = new Map();
      weeks.forEach(w => {
        w.days.forEach(d => {
          const key = `${d.dateObj.getFullYear()}-${pad2(d.dateObj.getMonth()+1)}`;
          if(!monthMap.has(key)) monthMap.set(key, []);
          monthMap.get(key).push(d);
        });
      });

      const DOW_LABELS = ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'];

      // Filtro mese rapido
      let html = '<div class="cal-month-filter" id="calMonthFilterPills">';
      monthMap.forEach((_, key) => {
        const [y, m] = key.split('-').map(Number);
        const short = MONTHS[m-1].substring(0,3);
        html += `<button class="cal-month-pill" data-target="cal-month-${key}" type="button">${short} ${y}</button>`;
      });
      html += '</div>';

      monthMap.forEach((days, key) => {
        const [y, m] = key.split('-').map(Number);
        const monthName = MONTHS[m-1] + ' ' + y;

        const firstOfMonth = new Date(y, m-1, 1);
        const dowFirst = firstOfMonth.getDay();
        const offsetMon = (dowFirst === 0) ? 6 : dowFirst - 1;

        const dayByISO = new Map();
        days.forEach(d => dayByISO.set(isoDate(d.dateObj), d));

        const daysInMonth = new Date(y, m, 0).getDate();

        // Contatore ore mensili
        let workDays = 0;
        for(let day = 1; day <= daysInMonth; day++){
          const iso = isoDate(new Date(y, m-1, day));
          const d = dayByISO.get(iso);
          if(d && !d.isRest && !d.isHoliday) workDays++;
        }
        const totalMins = workDays * (state.durationMinutes || 0);
        const totH = Math.floor(totalMins / 60);
        const totM = totalMins % 60;
        const oreLabel = totalMins > 0 ? `${totH}h${totM ? ' ' + totM + 'm' : ''}` : '—';

        html += `<div class="cal-month" id="cal-month-${key}">`;
        html += `<div class="cal-month-title">${monthName}<span style="float:right;font-size:11px;font-weight:700;opacity:0.65;">${workDays} giorni · ${oreLabel}</span></div>`;
        html += `<div class="cal-grid">`;

        DOW_LABELS.forEach(dl => { html += `<div class="cal-dow">${dl}</div>`; });

        for(let i = 0; i < offsetMon; i++){
          html += `<div class="cal-cell cal-empty"></div>`;
        }

        for(let day = 1; day <= daysInMonth; day++){
          const dateObj = new Date(y, m-1, day);
          const iso = isoDate(dateObj);
          const d = dayByISO.get(iso);
          const isToday = iso === todayISO;
          const dowIdx = (dateObj.getDay() + 6) % 7;
          const isWeekend = weekendDowIdx.has(dowIdx);

          let classes = 'cal-cell';
          if(isToday) classes += ' cal-today';

          let inner = `<div class="cal-day-num">${day}</div>`;

          if(d){
            if(d.isRest){ classes += ' cal-rest'; inner += `<div class="cal-libero">LIBERO</div>`; }
            else if(d.isHoliday){ classes += ' cal-holiday'; inner += `<div class="cal-time time-red">${d.start}</div><div class="cal-time-end">${d.end}</div><div class="cal-hname">${escapeHtml(d.holidayName)}</div>`; }
            else {
              if(isWeekend) classes += ' cal-weekend';
              inner += `<div class="cal-time">${d.start}</div><div class="cal-time-end">${d.end}</div>`;
            }
          } else {
            classes += ' cal-empty';
          }

          html += `<div class="${classes}">${inner}</div>`;
        }

        const totalCells = offsetMon + daysInMonth;
        const remainder = totalCells % 7;
        if(remainder !== 0){
          for(let i = 0; i < 7 - remainder; i++){
            html += `<div class="cal-cell cal-empty"></div>`;
          }
        }

        html += `</div></div>`;
      });

      wrap.innerHTML = html;

      // Wire month filter pills interactivity
      const pills = wrap.querySelectorAll('.cal-month-pill');
      pills.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.getAttribute('data-target'));
          if(target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          pills.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
      if(pills.length) pills[0].classList.add('active');

      // Auto-activate pill for current month
      const todayKey = todayISO.substring(0,7).replace('-', '-');
      const todayPill = wrap.querySelector(`.cal-month-pill[data-target="cal-month-${todayISO.substring(0,7)}"]`);
      if(todayPill){
        pills.forEach(b => b.classList.remove('active'));
        todayPill.classList.add('active');
      }
    }

    function render(){
      const previewWrap = document.getElementById('previewWrap');
      const empty = document.getElementById('emptyPreview');
      const bottomBar = document.getElementById('bottomBar');

      if(!state.generated){
        previewWrap.classList.remove('is-visible');
        empty.style.display = 'flex';
        bottomBar.style.display = 'none';
        return;
      }

      const weeks = buildMatrixData();
      // Costruisci sempre la tabella (serve anche per export PNG)
      renderTable(weeks);
      // Vista a schede
      renderCards(weeks);
      // Vista calendario
      renderCalendar(weeks);

      const tableWrap = document.getElementById('matrixTableWrap');
      const cardsWrap = document.getElementById('matrixCardsWrap');
      const calWrap = document.getElementById('matrixCalendarWrap');
      const vm = state.viewMode;
      if(tableWrap) tableWrap.style.display = (vm === 'table') ? 'block' : 'none';
      if(cardsWrap) cardsWrap.style.display = (vm === 'cards') ? 'block' : 'none';
      if(calWrap)   calWrap.style.display   = (vm === 'calendar') ? 'block' : 'none';

      previewWrap.classList.add('is-visible');
      empty.style.display = 'none';
      bottomBar.style.display = 'block';

      // enable actions if we have duration minutes
      document.getElementById('savePngBtn').disabled = !state.durationMinutes;
      document.getElementById('shareBtn').disabled = !state.durationMinutes;
    }

    // --------- Modals & selettori ---------
    const MONTHS = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
    const REFERENCE_YEAR = parseISODate(BASE_START_ISO).getFullYear();
    let ALL_WEEKS = [];

    function openModal(id){
      const modal = document.getElementById(id);
      modal.classList.add('is-open');
      document.body.classList.add('modal-open');
    }
    function closeModal(id){
      const modal = document.getElementById(id);
      modal.classList.remove('is-open');
      document.body.classList.remove('modal-open');
    }

    function computeWeeksForYear(year){
      const jan1 = new Date(year, 0, 1);
      const dow = jan1.getDay(); // 0=dom .. 6=sab
      const diffToMonday = (dow === 0) ? -6 : (1 - dow);
      const firstMonday = addDays(jan1, diffToMonday);

      const dec31 = new Date(year, 11, 31);
      const limit = addDays(dec31, 7);

      const arr = [];
      for(let i=0;i<54;i++){
        const ws = addDays(firstMonday, i*7);
        if(ws > limit) break;

        const monthsTouched = new Set();
        for(let d=0; d<7; d++){
          monthsTouched.add(addDays(ws, d).getMonth());
        }
        arr.push({ start: ws, iso: isoDate(ws), label: weekLabel(ws), monthsTouched });
      }
      return arr;
    }

    function weeksForSelectedMonth(){
      if(state.startMonth === null) return [];
      return ALL_WEEKS.filter(w => w.monthsTouched.has(state.startMonth));
    }

    function initMonthModal(){
      const list = document.getElementById('monthList');
      list.innerHTML = '';
      MONTHS.forEach((m, idx)=>{
        const b = document.createElement('button');
        b.type='button';
        b.className='modal-item';
        b.innerHTML = `${m}<div class="sub">Seleziona un mese per trovare la settimana di partenza</div>`;
        b.setAttribute('aria-current', state.startMonth === idx ? 'true' : 'false');
        b.addEventListener('click', ()=>{
          state.startMonth = idx;
          localStorage.setItem('startMonth', String(idx));

          // Se la settimana attuale non tocca il mese, metti la prima disponibile
          const possible = weeksForSelectedMonth();
          if(possible.length){
            const touches = state.startWeekISO ? possible.some(w => w.iso === state.startWeekISO) : false;
            if(!touches){
              state.startWeekISO = possible[0].iso;
              localStorage.setItem('startWeekISO', state.startWeekISO);
            }
          }

          updateRefLabels();
          closeModal('monthModal');
          if(state.generated) render();
        });
        list.appendChild(b);
      });
    }

    function initWeekModal(){
      const list = document.getElementById('weekList');
      list.innerHTML = '';

      const possible = weeksForSelectedMonth();
      if(!possible.length){
        const info = document.createElement('div');
        info.className = 'modal-item';
        info.style.cursor = 'default';
        info.innerHTML = `Seleziona prima un mese<div class="sub">Poi potrai scegliere la settimana.</div>`;
        list.appendChild(info);
        return;
      }

      possible.forEach((w)=>{
        const b = document.createElement('button');
        b.type='button';
        b.className='modal-item';
        b.innerHTML = `${w.label}<div class="sub">${w.iso} (lun)</div>`;
        b.setAttribute('aria-current', state.startWeekISO === w.iso ? 'true' : 'false');
        b.addEventListener('click', ()=>{
          state.startWeekISO = w.iso;
          localStorage.setItem('startWeekISO', state.startWeekISO);
          updateRefLabels();
          closeModal('weekModal');
          if(state.generated) render();
        });
        list.appendChild(b);
      });
    }

    function optionText(entry){
      return `${entry.startTime} — ${restLabel(entry.restDays)}`;
    }

    function initOptionModal(){
      const list = document.getElementById('optionList');
      list.innerHTML='';
      ACTIVE_PATTERN.forEach((entry, idx)=>{
        const b=document.createElement('button');
        b.type='button';
        b.className='modal-item';
        b.innerHTML = `${optionText(entry)}<div class="sub">Opzione ${idx+1}</div>`;
        b.setAttribute('aria-current', state.anchorPatternIndex === idx ? 'true' : 'false');
        b.addEventListener('click', ()=>{
          state.anchorPatternIndex = idx;
          localStorage.setItem('anchorPatternIndex', String(state.anchorPatternIndex));
          updateRefLabels();
          closeModal('optionModal');
          if(state.generated) render();
        });
        list.appendChild(b);
      });
    }

    function updateRefButtonsEnabled(){
      const enabled = !!state.role && !!state.durationMinutes;
      document.getElementById('monthBtn').disabled = !enabled;
      document.getElementById('weekBtn').disabled = !enabled || state.startMonth === null;
      document.getElementById('optionBtn').disabled = !enabled || !state.startWeekISO;
    }

    function updateRefLabels(){
      // Mese
      const mLabel = document.getElementById('monthBtnLabel');
      mLabel.textContent = (state.startMonth === null) ? 'Seleziona mese' : MONTHS[state.startMonth];

      // Settimana
      const wLabel = document.getElementById('weekBtnLabel');
      if(state.startWeekISO){
        wLabel.textContent = weekLabel(parseISODate(state.startWeekISO));
      } else {
        wLabel.textContent = 'Seleziona settimana';
      }

      // Opzione
      const oLabel = document.getElementById('optionLabel');
      if(state.anchorPatternIndex !== null){
        oLabel.textContent = optionText(ACTIVE_PATTERN[state.anchorPatternIndex]);
      } else {
        oLabel.textContent = 'Seleziona orario';
      }

      // Hint sintetico
      const refOk = !!state.durationMinutes && state.startMonth !== null && !!state.startWeekISO && state.anchorPatternIndex !== null;
      const hintRow = document.getElementById('refHintRow');
      if(refOk){
        hintRow.style.display = 'flex';
        const monthText = MONTHS[state.startMonth];
        const weekText = weekLabel(parseISODate(state.startWeekISO));
        const optText = optionText(ACTIVE_PATTERN[state.anchorPatternIndex]);
        document.getElementById('refHint').textContent = `${monthText} • ${weekText} • ${optText}`;
      } else {
        hintRow.style.display = 'none';
      }

      initMonthModal();
      initWeekModal();
      initOptionModal();
      updateRefButtonsEnabled();
      updateRefButtonsEnabled();
      updateGenerateEnabled();
    }
    // --------- Hours ---------
    function updateGenerateEnabled(){
      const ok = !!state.role && !!state.durationMinutes && state.startMonth !== null && state.startWeekISO && state.anchorPatternIndex !== null;
      document.getElementById('generateBtn' ).disabled = !ok;
    }

    function initRole(){
      const seg = document.getElementById('roleSegment');
      if(!seg) return;

      // Applica ruolo salvato (se presente)
      const saved = localStorage.getItem('operatorRole');
      if(saved === 'dipendente' || saved === 'tutor'){
        state.role = saved;
        setActiveRole(saved);
      }

      seg.querySelectorAll('button').forEach(btn=>{
        const role = btn.getAttribute('data-role');
        btn.setAttribute('aria-pressed', state.role === role ? 'true' : 'false');

        btn.addEventListener('click', (e)=>{
          addRipple(btn, e.clientX || (btn.getBoundingClientRect().left+10), e.clientY || (btn.getBoundingClientRect().top+10));
          playClickSound();

          state.role = role;
          localStorage.setItem('operatorRole', role);
          setActiveRole(role);

          // Pattern cambiato => richiedi nuova selezione opzione orario
          state.anchorPatternIndex = null;
          localStorage.removeItem('anchorPatternIndex');

          // Nascondi anteprima finché non si rigenera
          state.generated = false;

          seg.querySelectorAll('button').forEach(b=>b.setAttribute('aria-pressed', b.getAttribute('data-role')===role ? 'true' : 'false'));

          updateRefButtonsEnabled();
          updateGenerateEnabled();
          updateRefLabels();
          render();
        });
      });
    }

    function initHours(){
      const seg = document.getElementById('hoursSegment');
      const saved = localStorage.getItem('durationKey');
      if (saved && DURATIONS[saved]) {
        state.durationKey = saved;
        state.durationMinutes = DURATIONS[saved];
      }

      seg.querySelectorAll('button').forEach(btn => {
        const key = btn.getAttribute('data-hours');
        const pressed = state.durationKey === key;
        btn.setAttribute('aria-pressed', pressed ? 'true' : 'false');

        btn.addEventListener('click', (e) => {
          addRipple(btn, e.clientX || (btn.getBoundingClientRect().left+10), e.clientY || (btn.getBoundingClientRect().top+10));
          playClickSound();
          state.durationKey = key;
          state.durationMinutes = DURATIONS[key];
          localStorage.setItem('durationKey', key);

          seg.querySelectorAll('button').forEach(b => b.setAttribute('aria-pressed', b.getAttribute('data-hours')===key ? 'true' : 'false'));

          document.getElementById('hoursHintRow').style.display = 'flex';
          document.getElementById('hoursHint').textContent = `Ore giornaliere: ${prettyDuration(key)}`;
          updateRefButtonsEnabled();
          updateGenerateEnabled();

          if(state.generated) render();
        });
      });

      if(state.durationMinutes){
        document.getElementById('hoursHintRow').style.display = 'flex';
        document.getElementById('hoursHint').textContent = `Ore giornaliere: ${prettyDuration(state.durationKey)}`;
      }
      updateRefButtonsEnabled();
      updateGenerateEnabled();
    }

    // --------- Theme & view ---------
    function setTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      // Icon stays as "gear" (UI style from screenshot)
      localStorage.setItem('theme', theme);
    }
    function initTheme(){
      const saved = localStorage.getItem('theme');
      if (saved === 'dark' || saved === 'light') setTheme(saved);
      else setTheme('dark');
    }

    function initViewToggle(){
      const btn = document.getElementById('viewToggle');
      if(!btn) return;

      // restore saved mode
      const saved = safeStorageGet('viewMode');
      // default to saved preference
      const validModes = ['table','cards','calendar'];
      state.viewMode = validModes.includes(saved) ? saved : 'table';

      // If small screen (mobile) we force cards view. Listen for changes to viewport size
      try{
        const m = window.matchMedia('(max-width: 720px)');
        const applyResponsive = (mq)=>{
          if(mq.matches){
            state.viewMode = 'cards';
          } else {
            const restored = safeStorageGet('viewMode');
            state.viewMode = validModes.includes(restored) ? restored : 'table';
          }
          updateViewToggleIcon();
          if(state.generated) render();
        };
        // initial apply
        applyResponsive(m);
        // listen for changes
        if(typeof m.addEventListener === 'function') m.addEventListener('change', (e)=>applyResponsive(e));
        else if(typeof m.addListener === 'function') m.addListener((e)=>applyResponsive(e));
      }catch(e){
        updateViewToggleIcon();
      }

      btn.addEventListener('click', (e)=>{
        addRipple(btn, e.clientX || (btn.getBoundingClientRect().left+10), e.clientY || (btn.getBoundingClientRect().top+10));
        playClickSound();
        // Ciclo: table → cards → calendar → table
        const cycle = ['table','cards','calendar'];
        const idx = cycle.indexOf(state.viewMode);
        state.viewMode = cycle[(idx + 1) % cycle.length];
        safeStorageSet('viewMode', state.viewMode);
        updateViewToggleIcon();
        if(state.generated) render();
        // toast removed for view toggle per user preference
      });
    }

    function updateViewToggleIcon(){
      const btn = document.getElementById('viewToggle');
      if(!btn) return;
      const icon = btn.querySelector('i');
      if(!icon) return;
      const iconMap = { table: 'fa-solid fa-layer-group', cards: 'fa-solid fa-calendar-days', calendar: 'fa-solid fa-table-cells-large' };
      const labelMap = { table: 'Passa a schede', cards: 'Passa a calendario', calendar: 'Passa a tabella' };
      const activeLabel = { table: 'Tabella', cards: 'Schede', calendar: 'Calendario' };
      icon.className = iconMap[state.viewMode] || 'fa-solid fa-layer-group';
      btn.setAttribute('aria-label', labelMap[state.viewMode] || 'Cambia vista');
      const vl = document.getElementById('viewLabel');
      if(vl) vl.textContent = activeLabel[state.viewMode] || 'Vista';
    }

    // --------- Export (PNG) ---------
    function buildExportNode(){
      const root = document.createElement('div');
      root.className = 'export-root';

      const title = document.createElement('div');
      title.style.fontWeight = '900';
      title.style.marginBottom = '10px';
      const viewLabel = { table: 'Tabella', cards: 'Schede', calendar: 'Calendario' }[state.viewMode] || '';
      title.textContent = `Matrice Orari — ${viewLabel} (${computeTotalWeeks()} settimane)`;
      root.appendChild(title);

      const meta = document.createElement('div');
      meta.style.fontSize = '12px';
      meta.style.color = '#334155';
      meta.style.marginBottom = '12px';
      const monthText = (state.startMonth === null) ? '-' : MONTHS[state.startMonth];
      const weekText = state.startWeekISO ? weekLabel(parseISODate(state.startWeekISO)) : '-';
      const optText = (state.anchorPatternIndex !== null) ? optionText(ACTIVE_PATTERN[state.anchorPatternIndex]) : '-';
      meta.textContent = `Ore: ${state.durationKey || '-'} • Partenza: ${monthText} • ${weekText} • ${optText}`;
      root.appendChild(meta);

      if(state.viewMode === 'table'){
        const table = document.getElementById('matrixTable');
        if(!table) return null;
        const container = document.createElement('div');
        container.className = 'matrix-container';
        container.appendChild(table.cloneNode(true));
        root.appendChild(container);
      } else if(state.viewMode === 'cards'){
        const src = document.getElementById('matrixCardsWrap');
        if(!src) return null;
        const clone = src.cloneNode(true);
        // Forza apertura di tutti i details per l'export
        clone.querySelectorAll('details').forEach(d => d.setAttribute('open', ''));
        root.appendChild(clone);
      } else if(state.viewMode === 'calendar'){
        const src = document.getElementById('matrixCalendarWrap');
        if(!src) return null;
        root.appendChild(src.cloneNode(true));
      } else {
        return null;
      }

      return root;
    }

    async function exportPngBlob(){
      const node = buildExportNode();
      if(!node) throw new Error('Nessuna matrice');

      // Temporarily attach offscreen
      node.style.position = 'fixed';
      node.style.left = '-99999px';
      node.style.top = '0';
      document.body.appendChild(node);

      try{
        const canvas = await html2canvas(node, {
          backgroundColor: '#ffffff',
          scale: Math.min(3, window.devicePixelRatio ? window.devicePixelRatio * 2 : 2),
          useCORS: true,
          logging: false,
          scrollX: 0,
          scrollY: 0,
        });
        return await new Promise((resolve) => canvas.toBlob(resolve, 'image/png', 1.0));
      } finally {
        node.remove();
      }
    }

    async function savePng(){
      try{
        const blob = await exportPngBlob();
        if(!blob) throw new Error('Export fallito');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const fileLabel = { table: 'tabella', cards: 'schede', calendar: 'calendario' }[state.viewMode] || 'vista';
        a.download = `matrice-orari-${fileLabel}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1200);
        // toast removed for save action per user preference
      } catch(err){
        // toast removed for save error per user preference
      }
    }

    async function sharePng(){
      try{
        const blob = await exportPngBlob();
        if(!blob) throw new Error('Export fallito');
        const file = new File([blob], 'matrice-orari.png', { type: 'image/png' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'Matrice Orari',
            text: 'Ecco la matrice orari (PNG).',
            files: [file]
          });
          // toast removed for share action per user preference
        } else if (navigator.share) {
          // Fallback: share without file, but still download
          await savePng();
          // toast removed for share fallback per user preference
        } else {
          await savePng();
          // toast removed for share fallback per user preference
        }
      } catch(err){
        // user cancelled share or something; toast removed per user preference
      }
    }

    // --------- Events wiring ---------
    function bindButtonFeedback(){
      document.querySelectorAll('.btn, .btn-ghost, .select-like, .cta, .icon-btn').forEach(btn => {
        btn.addEventListener('pointerdown', (e)=>{
          // ripple
          const x = e.clientX || (btn.getBoundingClientRect().left+10);
          const y = e.clientY || (btn.getBoundingClientRect().top+10);
          addRipple(btn, x, y);
        }, {passive:true});
        btn.addEventListener('click', ()=>{ playClickSound(); }, {passive:true});
      });
    }

    function init(){
      initTheme();
      initViewToggle();

      // Theme toggle (icon stays gear)
      const tt = document.getElementById('themeToggle');
      if(tt){
        tt.addEventListener('click', (e)=>{
          addRipple(tt, e.clientX || (tt.getBoundingClientRect().left+10), e.clientY || (tt.getBoundingClientRect().top+10));
          playClickSound();
          const cur = document.documentElement.getAttribute('data-theme') || 'dark';
          setTheme(cur === 'dark' ? 'light' : 'dark');
          // toast removed for theme toggle per user preference
        });
      }

      bindButtonFeedback();

      // Prepara calendario settimane (anno di riferimento)
      ALL_WEEKS = computeWeeksForYear(REFERENCE_YEAR);

      // Carica ruolo operatore (prima di tutto, perché cambia le opzioni)
      const savedRole = localStorage.getItem('operatorRole');
      if(savedRole === 'dipendente' || savedRole === 'tutor'){
        state.role = savedRole;
        setActiveRole(savedRole);
      }

      // Carica preferenze salvate
      const savedOpt = localStorage.getItem('anchorPatternIndex');
      if(savedOpt !== null && savedOpt !== ''){
        const idx = Number(savedOpt);
        if(Number.isFinite(idx) && idx >= 0 && idx < ACTIVE_PATTERN.length){
          state.anchorPatternIndex = idx;
        }
      }

      const savedMonth = localStorage.getItem('startMonth');
      if(savedMonth !== null && savedMonth !== ''){
        const m = Number(savedMonth);
        if(Number.isFinite(m) && m >= 0 && m <= 11){
          state.startMonth = m;
        }
      }

      const savedWeek = localStorage.getItem('startWeekISO');
      if(savedWeek){
        state.startWeekISO = savedWeek;
      }

      // Default se manca qualcosa
      if(state.startMonth === null){
        state.startMonth = parseISODate(BASE_START_ISO).getMonth();
      }
      if(!state.startWeekISO){
        // prima settimana che tocca il mese scelto
        const possible = weeksForSelectedMonth();
        state.startWeekISO = possible.length ? possible[0].iso : BASE_START_ISO;
      }

      // Ruolo operatore (Dipendente/Tutor)
      initRole();

      // Ore (attiva/disable UI)
      initHours();

      // Labels/modals (dipendono da ore + mese + settimana)
      updateRefLabels();

      // Open/close modals
      document.getElementById('monthBtn').addEventListener('click', ()=>{ if(!document.getElementById('monthBtn').disabled){ initMonthModal(); openModal('monthModal'); }});
      document.getElementById('closeMonthModal').addEventListener('click', ()=>closeModal('monthModal'));
      document.getElementById('monthModal').addEventListener('click', (e)=>{ if(e.target.id==='monthModal') closeModal('monthModal'); });

      document.getElementById('weekBtn').addEventListener('click', ()=>{ if(!document.getElementById('weekBtn').disabled){ initWeekModal(); openModal('weekModal'); }});
      document.getElementById('closeWeekModal').addEventListener('click', ()=>closeModal('weekModal'));
      document.getElementById('weekModal').addEventListener('click', (e)=>{ if(e.target.id==='weekModal') closeModal('weekModal'); });

      document.getElementById('optionBtn').addEventListener('click', ()=>{ if(!document.getElementById('optionBtn').disabled){ initOptionModal(); openModal('optionModal'); }});
      document.getElementById('closeOptionModal').addEventListener('click', ()=>closeModal('optionModal'));
      document.getElementById('optionModal').addEventListener('click', (e)=>{ if(e.target.id==='optionModal') closeModal('optionModal'); });

      // Generate
      document.getElementById('generateBtn').addEventListener('click', ()=>{
        state.generated = true;
        render();
        toast('Ok', `Matrice generata (${computeTotalWeeks()} settimane).`);
      });

      // Reset
      document.getElementById('resetBtn').addEventListener('click', ()=>{
        state.generated = false;

        state.role = null;
        setActiveRole('dipendente');
        state.durationKey = null;
        state.durationMinutes = null;
        state.anchorPatternIndex = null;
        state.startMonth = parseISODate(BASE_START_ISO).getMonth();
        state.startWeekISO = BASE_START_ISO;

        localStorage.removeItem('operatorRole');
        localStorage.removeItem('durationKey');
        localStorage.removeItem('anchorPatternIndex');
        localStorage.removeItem('startMonth');
        localStorage.removeItem('startWeekISO');

        // UI reset ruolo
        document.querySelectorAll('#roleSegment button').forEach(b => b.setAttribute('aria-pressed','false'));

        // UI reset ore
        document.querySelectorAll('#hoursSegment button').forEach(b => b.setAttribute('aria-pressed','false'));
        document.getElementById('hoursHintRow').style.display = 'none';

        updateRefLabels();
        updateGenerateEnabled();
        render();
        toast('Reset', 'Impostazioni azzerate.');
      });

            // Preview top button
      const pt = document.getElementById('previewTopBtn');
      if(pt){
        pt.addEventListener('click', ()=>{
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      // Export buttons
      document.getElementById('savePngBtn').addEventListener('click', savePng);
      document.getElementById('shareBtn').addEventListener('click', sharePng);

      // Tasto Oggi
      const todayBtn = document.getElementById('todayBtn');
      if(todayBtn){
        todayBtn.addEventListener('click', (e) => {
          addRipple(todayBtn, e.clientX || (todayBtn.getBoundingClientRect().left+10), e.clientY || (todayBtn.getBoundingClientRect().top+10));
          playClickSound();
          if(!state.generated){ toast('Oggi', 'Genera prima la matrice.'); return; }
          const vm = state.viewMode;
          let el = null;
          if(vm === 'table') el = document.querySelector('.matrix-table .cell-today');
          else if(vm === 'cards') el = document.querySelector('#matrixCardsWrap .day-row-today');
          else if(vm === 'calendar') el = document.querySelector('#matrixCalendarWrap .cal-today');
          if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          else toast('Oggi', 'Il giorno corrente non è nella matrice.');
        });
      }

      // Stampa: mostra solo vista attiva, apri tutti i details
      window.addEventListener('beforeprint', () => {
        const vm = state.viewMode;
        ['matrixTableWrap','matrixCardsWrap','matrixCalendarWrap'].forEach(id => {
          const el = document.getElementById(id); if(el) el.classList.remove('print-show');
        });
        const activeId = {table:'matrixTableWrap', cards:'matrixCardsWrap', calendar:'matrixCalendarWrap'}[vm];
        if(activeId){ const el = document.getElementById(activeId); if(el) el.classList.add('print-show'); }
        document.querySelectorAll('#matrixCardsWrap details').forEach(d => d.setAttribute('open',''));
      });
      window.addEventListener('afterprint', () => {
        ['matrixTableWrap','matrixCardsWrap','matrixCalendarWrap'].forEach(id => {
          const el = document.getElementById(id); if(el) el.classList.remove('print-show');
        });
        if(state.generated) render();
      });

      // Improve touch scrolling: keep vertical pan enabled even over the table
      document.addEventListener('touchmove', ()=>{}, {passive:true});
    }

    // Function to switch to card view for mobile or tablet
    function switchToCardView() {
      const isMobileOrTablet = window.matchMedia("(max-width: 768px)").matches;
      const matrixElement = document.querySelector('.matrix'); // Assuming the matrix has a class named 'matrix'

      if (isMobileOrTablet) {
        matrixElement.classList.add('card-view'); // Add a class to switch to card view
      } else {
        matrixElement.classList.remove('card-view'); // Remove the class for larger screens
      }
    }

    // Add event listener for screen resize
    window.addEventListener('resize', switchToCardView);

    // Initial check on page load
    document.addEventListener('DOMContentLoaded', () => {
      switchToCardView();
    });
    
    init();
  </script>
</body>
</html>